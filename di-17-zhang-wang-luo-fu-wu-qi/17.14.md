# Section 17.14 OnlyOffice

First, install nextcloud on other machines.

# Install

```sh '
# pkg install onlyoffice-documentsserver
````

Or...

```sh '
# cd /usr/ports/www/onlyoffice-documentsserver/
# Make install clean
````

# View installation configuration

```sh '
root@ykla:~pkginfo-D onlyoffice-documentsserver
Onlyoffice-documentserver-8.2.0.143_4:
On install:
CONFIGURATION:
---
Configure:
# Here is a detailed description of how to configure the OnlyOffice document server.

The situation file can be found at the following path:
/usr/local/etc/onlyoffice/documentserver/local.json
# Profile is in the following path (or creation):
#/usr/local/etc/onlyoffice/documentserver/local.json

The default values are available in the default.
Please do not delete the numbers of the
The default values will be restored each time you
Upgrad Document Server to a new version and all your changes will be lost.
# Default value can be found in the default.json configuration file, which is in the above folder.
# Please do not directly edit the contents of the file default.json, because every time you upgrade the document server, all changes will be lost and the default value will be restored.

1. Available services at startup in the/etc/rc.conf file:
nginx_enable
"YES"
Subvisor_enable
1. Enable start-up services in /etc/rc.conf files:
Set nginx_enable
# Set rabbitmq_enable #
Setup supervisor_enable

Actually in case of a jail with local IP and no internet access:
Update/etc/hosts in order to support your nextclass service to its local IP
# If running in a jail environment (local IP) without Internet access, choose:
# Update/etc/hosts files to resolve the Nextcloud server to its local IP.

Install a dataserver and set up the database:
For PostgreSQL (don't forget to change the password):
# Service postgresql initdb
# Service postgresql start
# psql-U postgres-c "CREATE DATABASE only office;"
# psql-U postgres-c "CREATE USER onlyoffice WITH password 'onlyoffice';"
# psql-U postgres-c "GRANT Allervileges ON DATABASE onlyoffice TO only office;"
# psql-U postgres-c "Alter DATABASE onlyoffice Owner to onlyoffice;"
#psql-hlocalhost-Uonlyoffice-d onlyoffice-f/usr/local/www/onlyoffice/documentserver/server/schema/postgresql/createdb.sql
2. Install database servers and set up databases (optional PostgreSQL or MySQL):
# For PostgreSQL (do not forget to change the password):
# Initialize the database, start the PostgreSQL service and create the required databases and users.

Actually in case of a jail with local IP:
Update / var/db/postgres/data13/pg_hba.conf
# If run in local IP Jail environment, you can also choose to update / var/db/postgres/data13/pg_hba.conf files.

For MySQL don't forget to change the password:
# With mysql-server start
# Mysql-u root-p-e "CREATE DATABASE onlyoffice DEFAUTER SET utf8 DEFAULT COLLATE utf8_general_ci;"
♪ Mysql-u root-p-e "CREATE USER 'ONlyoffice' ♪ Localhost' IDENTIFIEED BY 'ONLYoffice';"
♪ Mysql-u root-p-e-e "Grant Allervileges ON onlyoffice. ♪
# Mysql-u onlyoffice-D onlyoffice-p < /usr/local/www/onlyoffice/documentserver/server/schema/mysql/createdb.sql
# For MySQL (do not forget to change the password):
# Start MySQL services and create the required databases, users and permissions.

Create a new Rabbitmq user for the ONLYOFFICE Document Management:
# With service radbitmq start
# Rabbitmqctl-erlang-cookie `cat / var/db/rabbitmq/.erlang.cookie`add_user onlyoffice password
# Rabbitmqctl-erlang-cookie `cat / var/db/rabbitmq/.erlang.cookie `set_user_tags onlyoffice administrator
# Rabbitmqctl-erlang-cookie `cat / var/db/rabbitmq/.erlang.cookie `set_permissions-p/ onlyoffice " * " *"
And change it in/usr/local/etc/onlyoffice/documentserver/local.json otherwise.
3. Create a new rabbitmq user for ONLYOFFICE document server configuration (do not forget to change password):
# Starts the rabitmq service and adds new users and sets privileges to ensure that the `/usr/local/etc/onlyoffice/documentserver/local.json ' changes are made accordingly.

Set up majority in order to elaborate documents:
- Let yourself go.
/usr/local/etc/subvisor.conf:
[include]
= /usr/local/etc/onlyoffice/documentserver/subvisor/*.conf

- Start supervisor:
# Service supervisor start
#4 Settingscould not close temporary folder: %s
# Configure subvisor loads files and starts subvisor services.

Set up nginx:
- For HTTP including the following in your/usr/local/etc/nginx.conf file:
Include/usr/local/etc/onlyoffice/documentserver/nginx/ds.conf;
5. Set nginx:
# Set Nginx configuration for HTTP to ensure that ds.conf configuration is included in nginx.conf files.

NOTE: documentserver-update-security.sh will only update./nginx/ds.conf and local.json under/usr/local/etc/onlyoffice/documentserver/!
- Run documentserver-update-security.

- Start nginx:
♪ Service nginx start
# Note: documentserver-update-securelink.sh will only update ./nginx/ds.conf and/usr/local/etc/onlyoffice/documentserver/ local.json files!
# Run the script once to generate a secret string and start an nginx service.

Follow the following doc if you want to use Onlyoffice with Nextcloud:
- https://api.onlyoffice.com/editos/nextcloud
6. If you want to combine OnlyOffice with Nextcloud, refer to the following documents:
#https://api.onlyoffice.com/editos/nextcloud

Install OnlyOffice plugins (you'll need internet):
#usr/local/bin/documentserver-pluginsmanager.sh-update=/usr/local/www/onlyoffice/documentserver/sdkjs-plugins/plugin-list-default.json
# 7. Installation of the OnlyOffice plugin (needs Internet connection):
# Update the list of plugins with the plugin manager.

8. Enjoy.
8. Complete installation and enjoy the experience of using OnlyOffice.

On upward from onlyoffice-documentsserver <7.1.0.215:
If you are upgrading onlyoffice-documentsserver from a version budget to 7.1.0215,
You need to update the data scheme:
For PostgreSQL:
pssql-U postgres-d onlyoffice-f/usr/local/www/onlyoffice/documentserver/server/schema/postgresql/upgrad/upgradev710.sql
For MySQL:
Mysql-u onlyoffice-D onlyoffice-p </usr/local/www/onlyoffice/documentserver/server/schema/mysql/upgrad/upgradev710.sql
# Upgrade from onlyoffice-documentserver <7.1.0.215:
# In the case of upgrade from older version (before 7.1.0215), the database model needs to be updated:
# PostgreSQL and MySQL updated command.

On upward from onlyoffice-documentserver > 7.1.0.215 < 7.2.1.3:
If you are upgrading onlyoffice-documentsserver from a version budget to 7.2.1.34,
You need to update the data scheme:
For PostgreSQL:
Pssql-U postgress-d d onlyoffice-f/usr/local/www/onlyoffice/documentserver/server/schema/postgresql/upgrad/upgradev720.sql
For MySQL:
Mysql-u onlyoffice-D onlyoffice-p < /usr/local/www/onlyoffice/documentserver/server/schema/mysql/upgrade/upgradev720.sql
# Upgrade from onlyoffice-documentserver > 7.1.0.215 < 7.2.1.34:
# The database model needs to be updated if it is upgraded from the previous version of 7.2.1.34:
# PostgreSQL and MySQL updated command.
````


# Configure Services

```sh '
# With service #
# With service rabbitmq available
# With service subvisor able
````

# Configure Database

```sh '
# pkg install postgresql16-server
# Service postgresql available
# Service postgresql initdb
# Service postgresql start
# psql-U postgres-c "CREATE DATABASE only office;"
# psql-U postgres-c "CREATE USER onlyoffice WITH password 'onlyoffice';"
# psql-U postgres-c "GRANT Allervileges ON DATABASE onlyoffice TO only office;"
# psql-U postgres-c "Alter DATABASE onlyoffice Owner to onlyoffice;"
#psql-hlocalhost-Uonlyoffice-d onlyoffice-f/usr/local/www/onlyoffice/documentserver/server/schema/postgresql/createdb.sql
````

# Configure rabbitmq

Open service:

```sh '
# With service radbitmq start
````

Step 1:

```sh '
# Rabbitmqctl-erlang-cookie `cat / var/db/rabbitmq/.erlang.cookie `add_user onlyoffice password #

Please see diagnostics information and options below.

Most common concerns for this are:

? Target Node is unreadable (e.g. due to hostname resolution, TCP connection or first issues)
? CLI tool justice with the server
? Target node is not running ?

In agreement to the diagnosticsinfo below:

? See the CLI, clustering and netting guidelines on https://rabbitmq.com/documentation.html to learn more
? Consult service logs on node ?
? If target node is configured to use long node names, don't forget to use-long names with CLI tables

DIAGNOSTICS
== sync, corrected by elderman ==

I'm sorry, I'm sorryt: [rabbit@ykla]

@ykla:
? Connected to epmd (port 4369) on ykla
? adamd reports node 'rabbit' uses port 25672 for inter-node and CLI tool technical
? Can't discuss TCP connection to the target node, reason: time out
? Check if host 'ykla' settlements, is available and reports 25672, 4369 are not blocked by Fairwall

"Current node details:
*node name: 'rabbitmqcli-719-rabbit@ykla'
? effective user's home directory: / root
♪ Erlang cookie Hash: mmhdcv/DKEfjrCrCEaZMvQ ♪
````

Step 2:

```sh '
# Rabbitmqctl-erlang-cookie `cat / var/db/rabbitmq/.erlang.cookie `set_user_tags onlyoffice administrator
Please see diagnostics information and options below.

Most common concerns for this are:

? Target Node is unreadable (e.g. due to hostname resolution, TCP connection or first issues)
? CLI tool justice with the server
? Target node is not running ?

In agreement to the diagnosticsinfo below:

? See the CLI, clustering and netting guidelines on https://rabbitmq.com/documentation.html to learn more
? Consult service logs on node ?
? If target node is configured to use long node names, don't forget to use-long names with CLI tables

DIAGNOSTICS
== sync, corrected by elderman ==

I'm sorry, I'm sorry.

@ykla:
? Connected to epmd (port 4369) on ykla
? adamd reports node 'rabbit' uses port 25672 for inter-node and CLI tool technical
? Can't discuss TCP connection to the target node, reason: time out
? Check if host 'ykla' settlements, is available and reports 25672, 4369 are not blocked by Fairwall

"Current node details:
* node name: 'rabbitmqcli-882-rabbit@ykla'
? effective user's home directory: / root
♪ Erlang cookie Hash: mmhdcv/DKEfjrCrCEaZMvQ ♪
````

Step 3:

```sh '
Root@ykla: ~ #rabbitmqctl-erlang-cookie `cat / var/db/rabbitmq/.erlang.cookie `set_missions-p/ onlyoffice " * "...*"
Please see diagnostics information and options below.

Most common concerns for this are:

? Target Node is unreadable (e.g. due to hostname resolution, TCP connection or first issues)
? CLI tool justice with the server
? Target node is not running ?

In agreement to the diagnosticsinfo below:

? See the CLI, clustering and netting guidelines on https://rabbitmq.com/documentation.html to learn more
? Consult service logs on node ?
? If target node is configured to use long node names, don't forget to use-long names with CLI tables

DIAGNOSTICS
== sync, corrected by elderman ==

I'm sorry, I'm sorry.

@ykla:
? Connected to epmd (port 4369) on ykla
? adamd reports node 'rabbit' uses port 25672 for inter-node and CLI tool technical
? Can't discuss TCP connection to the target node, reason: time out
? Check if host 'ykla' settlements, is available and reports 25672, 4369 are not blocked by Fairwall

"Current node details:
* node name: 'rabbitmqcli-636-rabbit@ykla'
? effective user's home directory: / root
♪ Erlang cookie Hash: mmhdcv/DKEfjrCrCEaZMvQ ♪
````

# Allow LAN access

Onlyoffice default configuration, private addresses are not allowed. The following clips should therefore be added to `/usr/local/etc/onlyoffice/documentserver/local.json ' :

```ini '
"request-filtering-agent": {
"allow PrivateIPAddress": true,
"allowMetaIPAddress": true
♪ I don't know ♪
````

Namely:

```ini '
_Other Organiser
"services":
"CoAuthoring":
"sql":
"type": "postgres",
"dbhost": "localhost",
"dbPort": "5432",
"dbName": "onlyoffice",
"dbuser": "onlyoffice",
"dbpass": "onlyoffice"
♪ I don't know ♪
"request-filtering-agent": {
"allow PrivateIPAddress": true,
"allowMetaIPAddress": true
♪ I don't know ♪
"token":
"enable":
"request":
"inbox,"
"outbox": false
♪ I don't know ♪
,"browser":

...and omitted...
````

# Configure nginx

Edit `/usr/local/etc/nginx/nginx.conf '

Put

```ini '
Include/usr/local/etc/onlyoffice/documentserver/nginx/ds.conf;
````

In brackets in http: %1

Example:

```ini '
...and omitted...
http {
I don't know.
_type application/octet-stream;
Include/usr/local/etc/onlyoffice/documentserver/nginx/ds.conf;

...and omitted...
````

# Configure subvisor

Edit `/usr/local/etc/subvisor.conf ' , turn to the bottom and find `; [include] ' , and delete the semicolon before:

Namely:

```ini '
[include]
;files = relative/directory/*.ini
= /usr/local/etc/onlyoffice/documentserver/subvisor/*.conf
````

```sh '
# Service supervisor start
````

# Start Document

```sh '
#documentserver-update-securityink.sh
ds:docservice: stopped
ds:docservice: started
ds:convert: stopped
ds:converter: started
Check on nginx configuration:
nginx: the communication file/usr/local/etc/nginx/nginx.conf syntax is ok
nginx: conversion file/usr/local/etc/nginx/nginx.conf test is relevant
````

Open the IP address directly, as shown in the figure below:

[Document Server is running] (..getbook/assets/documentsserver1.png)

# Configure NextCloud

NextCloud:

Install onlyoffice plugins with direct access to `ip/nextcloud/index.php/settings/apps/office/onlyoffice ':

[onlyoffice] (. . .gitbook/assets/documentsserver2.png)

Click on header -- > Manage settings, find onlyoffice, set as follows (see if the key is really empty)

[onlyoffice](./.gitbook/assets/documentserver3.png)

# Done

Preview of a few files:

[onlyoffice](./.gitbook/assets/documentserver4.png)

[onlyoffice] (.. .getbook/assets/documentserver5.png)

[onlyoffice](./.gitbook/assets/documentsserver6.png)

# References

- [How to allow access only Office document Server?]

# Fragmentation and unfinished business

The log `cat / var/log/onlyoffice/documentserver/converter/out.log ' .
。
# Section 17.14 OnlyOffice

first, install nextcloud on other machines。

# Install

```sh
# pkg install onlyoffice-documentserver
```

Or..

```sh
# cd /usr/ports/www/onlyoffice-documentserver/ 
# make install clean
```

# View installation configuration

```sh
root@ykla:~ # pkg info -D onlyoffice-documentserver
onlyoffice-documentserver-8.2.0.143_4:
On install:
CONFIGURATION:
-------------
# 配置：
# 以下是有关如何配置 OnlyOffice 文档服务器的详细说明。

The situation file can be found at the following path:
/usr/local/etc/onlyoffice/documentserver/local.json
# Profile is in the following path (or creation):
#/usr/local/etc/onlyoffice/documentserver/local.json

The default values are available in the default,
please do not delete the numbers of the
the default values will be restored each time you
upgrad Document Server to a new version and all your changes will be lost.
# default value can be found in the default.json configuration file, which is in the above folder。
# please do not directly edit the contents of the file default.json, because every time you upgrade the document server, all changes will be lost and the default value will be restored。

1. Available services at startup in the/etc/rc.conf file:
nginx_enable
"YES"
subvisor_enable
1. enable start-up services in /etc/rc.conf files:
Set nginx_enable
# Set rabbitmq_enable #
Setup supervisor_enable

Actually in case of a jail with local IP and no internet access:
update/etc/hosts in order to support your nextclass service to its local IP
# If running in a jail environment (local IP) without Internet access, choose:
# Update/etc/hosts files to resolve the Nextcloud server to its local IP。

Install a dataserver and set up the database:
For PostgreSQL (don't forget to change the password):
# service postgresql initdb
# service postgresql start
# psql-U postgres-c "CREATE DATABASE only office;"
# psql-U postgres-c "CREATE USER onlyoffice WITH password 'onlyoffice';"
# psql-U postgres-c "GRANT Allervileges ON DATABASE onlyoffice TO only office;"
# psql-U postgres-c "Alter DATABASE onlyoffice Owner to onlyoffice;"
#psql-hlocalhost-Uonlyoffice-d onlyoffice-f/usr/local/www/onlyoffice/documentserver/server/schema/postgresql/createdb.sql
2. Install database servers and set up databases (optional PostgreSQL or MySQL):
# For PostgreSQL (do not forget to change the password):
# Initialize the database, start the PostgreSQL service and create the required databases and users。

Actually in case of a jail with local IP:
update / var/db/postgres/data13/pg_hba.conf
# If run in local IP Jail environment, you can also choose to update / var/db/postgres/data13/pg_hba.conf files。

For MySQL don't forget to change the password:
# with mysql-server start
# Mysql-u root-p-e "CREATE DATABASE onlyoffice DEFAUTER SET utf8 DEFAULT COLLATE utf8_general_ci;"
♪ Mysql-u root-p-e "CREATE USER 'ONlyoffice' ♪ Localhost' IDENTIFIEED BY 'ONLYoffice';"
♪ Mysql-u root-p-e-e "Grant Allervileges ON onlyoffice. ♪
# Mysql-u onlyoffice-D onlyoffice-p < /usr/local/www/onlyoffice/documentserver/server/schema/mysql/createdb.sql
# For MySQL (do not forget to change the password):
# Start MySQL services and create the required databases, users and permissions。

Create a new Rabbitmq user for the ONLYOFFICE Document Management:
# with service radbitmq start
# Rabbitmqctl-erlang-cookie #
# Rabbitmqctl -- erlang-cookie _ CODESPAN_0
# Rabbitmqctl-erlang-cookie # CODESPAN_0 # set_permissions-p/ onlyoffice ".*" ".*"
and change it in/usr/local/etc/onlyoffice/documentserver/local.json otherwise.
3. Create a new rabbitmq user for ONLYOFFICE document server configuration (do not forget to change password):
# Starts the rabbitmq service and adds new users and sets permissions to ensure that __CODESPAN_0_ changes are made accordingly。

Set up majority in order to elaborate documents:
- let yourself go
/usr/local/etc/subvisor.conf:
[include]
= /usr/local/etc/onlyoffice/documentserver/subvisor/*.conf

- start supervisor:
# service supervisor start
#4 setup subvisor to perform document server services:
# configure subvisor loads files and starts subvisor services。

Set up nginx:
- For HTTP including the following in your/usr/local/etc/nginx.conf file:
include/usr/local/etc/onlyoffice/documentserver/nginx/ds.conf;
5. set nginx:
# Set Nginx configuration for HTTP to ensure that ds.conf configuration is included in nginx.conf files。

NOTE: documentserver-update-security.sh will only update./nginx/ds.conf and local.json under/usr/local/etc/onlyoffice/documentserver/!
- run documentserver-update-security

- start nginx:
♪ service nginx start
# note: documentserver-update-securelink.sh will only update ./nginx/ds.conf and/usr/local/etc/onlyoffice/documentserver/ local.json files
# run the script once to generate a secret string and start an nginx service。

Follow the following doc if you want to use Onlyoffice with Nextcloud:
- https://api.onlyoffice.com/editos/nextcloud
6. If you want to combine OnlyOffice with Nextcloud, refer to the following documents:
#https://api.onlyoffice.com/editos/nextcloud

Install OnlyOffice plugins (you'll need internet):
#usr/local/bin/documentserver-pluginsmanager.sh-update=/usr/local/www/onlyoffice/documentserver/sdkjs-plugins/plugin-list-default.json
# 7. Installation of the OnlyOffice plugin (needs Internet connection):
# Update the list of plugins with the plugin manager。

8. Enjoy.
8. Complete installation and enjoy the experience of using OnlyOffice。

On upward from onlyoffice-documentsserver <7.1.0.215:
If you are upgrading onlyoffice-documentsserver from a version budget to 7.1.0215,
you need to update the data scheme:
For PostgreSQL:
pssql-U postgres-d onlyoffice-f/usr/local/www/onlyoffice/documentserver/server/schema/postgresql/upgrad/upgradev710.sql
For MySQL:
mysql-u onlyoffice-D onlyoffice-p </usr/local/www/onlyoffice/documentserver/server/schema/mysql/upgrad/upgradev710.sql
# upgrade from onlyoffice-documentserver <7.1.0.215:
# In the case of upgrade from older version (before 7.1.0215), the database model needs to be updated:
# PostgreSQL and MySQL updated command。

On upward from onlyoffice-documentserver > 7.1.0.215 < 7.2.1.3:
If you are upgrading onlyoffice-documentsserver from a version budget to 7.2.1.34,
you need to update the data scheme:
For PostgreSQL:
pssql-U postgress-d d onlyoffice-f/usr/local/www/onlyoffice/documentserver/server/schema/postgresql/upgrad/upgradev720.sql
For MySQL:
mysql-u onlyoffice-D onlyoffice-p < /usr/local/www/onlyoffice/documentserver/server/schema/mysql/upgrade/upgradev720.sql
# upgrade from onlyoffice-documentserver > 7.1.0.215 < 7.2.1.34:
# The database model needs to be updated if it is upgraded from the previous version of 7.2.1.34:
# PostgreSQL and MySQL updated command。
````


# Configure Services

```sh
# service nginx enable
# service rabbitmq enable
# service supervisord enable
```

# Configure Database

```sh
# pkg install postgresql16-server
# service postgresql enable
# service postgresql initdb
# service postgresql start
# psql -U postgres -c "CREATE DATABASE onlyoffice;"
# psql -U postgres -c "CREATE USER onlyoffice WITH password 'onlyoffice';"
# psql -U postgres -c "GRANT ALL privileges ON DATABASE onlyoffice TO onlyoffice;"
# psql -U postgres -c "ALTER DATABASE onlyoffice OWNER to onlyoffice;"
# psql -hlocalhost -Uonlyoffice -d onlyoffice -f /usr/local/www/onlyoffice/documentserver/server/schema/postgresql/createdb.sql
```

# configure rabbitmq

Open service:

```sh
# service rabbitmq start
```

Step 1:

```sh
# rabbitmqctl --erlang-cookie `cat /var/db/rabbitmq/.erlang.cookie` add_user onlyoffice password  # 注意：会卡几分钟，下同

Please see diagnostics information and options below.

Most common concerns for this are:

? Target Node is unreadable (e.g. due to hostname resolution, TCP connection or first issues)
? CLI tool justice with the server
? Target node is not running 

In agreement to the diagnosticsinfo below:

? See the CLI, clustering and netting guidelines on https://rabbitmq.com/documentation.html to learn more
? Consult service logs on node 
? If target node is configured to use long node names, don't forget to use-long names with CLI tables

DIAGNOSTICS
== sync, corrected by elderman ==

i'm sorry, i'm sorry

@ykla:
? connected to epmd (port 4369) on ykla
? adamd reports node 'rabbit' uses port 25672 for inter-node and CLI tool technical
? Can't discuss TCP connection to the target node, reason: time out
? check if host 'ykla' settlements, is available and reports 25672, 4369 are not blocked by fairwall

"Current node details:
*node name: 'rabbitmqcli-719-rabbit@ykla'
? effective user's home directory: / root
♪ Erlang cookie Hash: mmhdcv/DKEfjrCrCEaZMvQ ♪
````

Step 2:

```sh
# rabbitmqctl --erlang-cookie `cat /var/db/rabbitmq/.erlang.cookie` set_user_tags onlyoffice administrator
Error: unable to perform an operation on node 'rabbit@ykla'. Please see diagnostics information and suggestions below.

Most common concerns for this are:

? Target Node is unreadable (e.g. due to hostname resolution, TCP connection or first issues)
? CLI tool justice with the server
? Target node is not running 

In agreement to the diagnosticsinfo below:

? See the CLI, clustering and netting guidelines on https://rabbitmq.com/documentation.html to learn more
? Consult service logs on node 
? If target node is configured to use long node names, don't forget to use-long names with CLI tables

DIAGNOSTICS
== sync, corrected by elderman ==

i'm sorry, i'm sorry

@ykla:
? connected to epmd (port 4369) on ykla
? adamd reports node 'rabbit' uses port 25672 for inter-node and CLI tool technical
? Can't discuss TCP connection to the target node, reason: time out
? check if host 'ykla' settlements, is available and reports 25672, 4369 are not blocked by fairwall

"Current node details:
* node name: 'rabbitmqcli-882-rabbit@ykla'
? effective user's home directory: / root
♪ Erlang cookie Hash: mmhdcv/DKEfjrCrCEaZMvQ ♪
````

Step 3:

```sh
root@ykla:~ #  rabbitmqctl --erlang-cookie `cat /var/db/rabbitmq/.erlang.cookie` set_permissions -p / onlyoffice ".*" ".*" ".*"
Error: unable to perform an operation on node 'rabbit@ykla'. Please see diagnostics information and suggestions below.

Most common concerns for this are:

? Target Node is unreadable (e.g. due to hostname resolution, TCP connection or first issues)
? CLI tool justice with the server
? Target node is not running 

In agreement to the diagnosticsinfo below:

? See the CLI, clustering and netting guidelines on https://rabbitmq.com/documentation.html to learn more
? Consult service logs on node 
? If target node is configured to use long node names, don't forget to use-long names with CLI tables

DIAGNOSTICS
== sync, corrected by elderman ==

i'm sorry, i'm sorry

@ykla:
? connected to epmd (port 4369) on ykla
? adamd reports node 'rabbit' uses port 25672 for inter-node and CLI tool technical
? Can't discuss TCP connection to the target node, reason: time out
? check if host 'ykla' settlements, is available and reports 25672, 4369 are not blocked by fairwall

"Current node details:
* node name: 'rabbitmqcli-636-rabbit@ykla'
? effective user's home directory: / root
♪ Erlang cookie Hash: mmhdcv/DKEfjrCrCEaZMvQ ♪
````

# Allow LAN access

onlyoffice default configuration, private addresses are not allowed. For this reason, the following clips should be added:

```ini
  "request-filtering-agent" : {
				"allowPrivateIPAddress": true,
				"allowMetaIPAddress": true
			},
```

Namely:

```ini
{
  "services": {
    "CoAuthoring": {
      "sql": {
        "type": "postgres",
        "dbHost": "localhost",
        "dbPort": "5432",
        "dbName": "onlyoffice",
        "dbUser": "onlyoffice",
        "dbPass": "onlyoffice"
      },
  "request-filtering-agent" : {
				"allowPrivateIPAddress": true,
				"allowMetaIPAddress": true
			},
      "token": {
        "enable": {
          "request": {
            "inbox": false,
            "outbox": false
          },
          "browser": false

...and omitted..
````

# configure nginx

EDIT __CODESPAN_0_

Put

```ini
include /usr/local/etc/onlyoffice/documentserver/nginx/ds.conf;
```

in brackets in http: %1

Example:

```ini
……省略……
http {
    include       mime.types;
    default_type  application/octet-stream;
    include /usr/local/etc/onlyoffice/documentserver/nginx/ds.conf;

...and omitted..
````

# configure subvisor

EDIT __CODESPAN_0, TURN TO THE BOTTOM AND FIND __CODESPAN_1 AND DELETE THE SEMICOLON BEFORE:

Namely:

```ini
[include]
;files = relative/directory/*.ini
files = /usr/local/etc/onlyoffice/documentserver/supervisor/*.conf
```

```sh
# service supervisord start
```

# Start Document

```sh
root@ykla:~ # documentserver-update-securelink.sh
ds:docservice: stopped
ds:docservice: started
ds:converter: stopped
ds:converter: started
Performing sanity check on nginx configuration:
nginx: the configuration file /usr/local/etc/nginx/nginx.conf syntax is ok
nginx: configuration file /usr/local/etc/nginx/nginx.conf test is successful
```

OPEN THE IP ADDRESS DIRECTLY, AS SHOWN IN THE FIGURE BELOW:

[Document Server is running] (..getbook/assets/documentsserver1.png)

# Configure NextCloud

NextCloud:

Install onlyoffice plugins with direct access to __CODESPAN_0_:

[i'm sorry, onlyoffice]

click on header -- > manage settings, find onlyoffice, set as follows (see if the key is really empty)

[i'm sorry, onlyoffice]

# Done

Preview of a few files:

[i'm sorry, onlyoffice]

[i'm sorry, onlyoffice]

[i'm sorry, onlyoffice]

# References

- [How to allow access only Office document Server?]

# Fragmentation and unfinished business

YOU CAN READ CODESPAN_0_。

# Section 17.15 Zabbix Surveillance (based on PostgreSQL)



# install zabbix7-server

zabbix7-server is the server end. it is responsible for receiving and processing surveillance data and should be operated on the monitoring server。

the pkg installation will install surplus MySQL (and will be bound to death) and will be installed using Ports。

```sh
# cd /usr/ports/net-mgmt/zabbix7-server/ 
# make config
```

![..gitbook/assets/Zabbix.png]

CLICK __CODESPAN_0_ TO RETURN THE CAR AS GRAPH CONFIGURATION IS SELECTED:

```sh
# make install clean
```


# Install PostgreSQL


Installation:

```sh
# pkg install postgresql16-server postgresql16-client
```

or

```sh
# cd /usr/ports/databases/postgresql16-server/ && make install clean
# cd /usr/ports/databases/postgresql16-client/ && make install clean
```


# install zabbix7-frontend

zabbix7-frontend is web-controlled frontend。

```sh
# pkg ins zabbix7-frontend-php83
```

PHPs will be installed automatically. The version installed in this document is PHP8.3 (wrong if PHP 8.4 is written) and can be seen in [zabbix7-frontend] (https://www.freshports.org/net-mgmt/zabbix7-frontend)。

Or:

```sh
# cd /usr/ports/net-mgmt/zabbix7-frontend/ 
# make install clean
```


Pdo

NOTE PHP VERSION:

```sh
# pkg ins php83-pdo_pgsql php83-pgsql
```

or

```sh
# cd /usr/ports/databases/php83-pdo_pgsql/ && make install clean
# cd /usr/ports/databases/php83-pgsql/ && make install clean
```


# install zabbix7-agent

zabbix7-agent is responsible for data collection and is installed on monitored servers。

```sh
# pkg install zabbix7-agent
```

Or..

```sh
# cd /usr/ports/net-mgmt/zabbix7-agent/ 
# make install clean
```

# install nginx

```sh
# pkg install nginx
```

```sh
# cd /usr/ports/www/nginx/ 
# make install clean
```

Configure service startup

```sh
# service zabbix_server enable
# service zabbix_agentd enable
# service postgresql enable
# service nginx enable
# service php_fpm enable
```

# Set database

Initialize Database

```sql
# service postgresql initdb # 初始化数据库
# su - postgres # 切换到数据库用户
$ /usr/local/bin/pg_ctl -D /var/db/postgres/data16 -l logfile start # 初始化服务
$ cd /usr/local/share/zabbix7/server/database/postgresql/
$ psql 
psql (16.8)
Type "help" for help.

template1=#create data zabbix; # create zabbix database
CREATE DATABASE
template1=#CREATE USER zabbix WITH PASWORD 'z'; # Set here the user zabbix password is z
CREATE ROLE
postgres=#GRANT USAGE, CREATE on SCHEMA PUBLIC to zabbix; #
GRANT
postgres=#GRANT ALL PRIVILEGES ON DATABASE zabbix TO zabbix; # has all permissions for zabbix databases to grant user zabbix
GRANT
postgres=#grant all on data zabbix to zabbix; #
GRANT
postgres=#ALTER DATABASE zabbix own to zabbix;#
ALTER DATABASE
postgres=#\q
````

We must withdraw and continue:

```sql
$  psql -U zabbix zabbix # 使用用户账户 zabbix 登录到数据库 zabbix
psql (16.8, server 16.7)
Type "help" for help.

zabbix=>i schema.sql# imports a database, same as
CREATE TABLE
CREATE INDEX
CREATE TABLE
CREATE INDEX
CREATE TABLE
...and omitted..

zabbix =
INSERT 01
INSERT 01
INSERT 01
INSERT 01
INSERT 01
...and omitted..

zabbix=1 data.sql
START TRANSACTION
INSERT 0 4
INSERT 01
INSERT 0 2
...and omitted..
zabbix=#\
$ outside # quit database user
# i'm back
````

References

- [PostgreSQL15 Public Schema has no power to support the problem] (https://showme.codes/zh-cn/2024-01-postgresql15-public-schema-mission/)

# Setup Zabix Server

Zabfix's main profile is at __CODESPAN_0_。

Add the following:

```ini
SourceIP=127.0.0.1
LogFile=/var/log/zabbix/zabbix_server.log
DBHost=
DBName=zabbix
DBUser=zabbix
DBPassword=z
Timeout=4
LogSlowQueries=3000
StatsAllowedIP=127.0.0.1
```

# Setup Zabix Agent

Zabix Agent profile in __CODESPAN_0_

Add the following:

```ini
LogFile=/var/log/zabbix/zabbix_agentd.log
SourceIP=127.0.0.1
Server=127.0.0.1
ServerActive=127.0.0.1
Hostname=ykla
```

# Configure Zabfix Frontend

Zabfix frontend profile template is at __CODESPAN_0_。

Copy template:

```sh
# cp /usr/local/www/zabbix7/conf/zabbix.conf.php.example /usr/local/www/zabbix7/conf/zabbix.conf.php
```

EDIT `/usr/local/www/zabbix7/conf/zabbix.conf.php`, WHICH WILL:

```ini
$DB['TYPE']                             = 'MYSQL';
$DB['SERVER']                   = 'localhost';
$DB['PORT']                             = '0';
$DB['DATABASE']                 = 'zabbix';
$DB['USER']                             = 'zabbix';
$DB['PASSWORD']                 = '';
```

Amend to read as follows:

```ini
$DB['TYPE']                             = 'POSTGRESQL'; #数据库改成这个
$DB['SERVER']                   = 'localhost';
$DB['PORT']                             = '0';
$DB['DATABASE']                 = 'zabbix';
$DB['USER']                             = 'zabbix';
$DB['PASSWORD']                 = 'z';  # 这里是你的数据库密码
```

# configure nginx

Backup of original main profile:

```sh
# cp /usr/local/etc/nginx/nginx.conf /usr/local/etc/nginx/nginx.conf.simple
```

EDIT __CODESPAN_0, CLEAR THE ORIGINAL TEXT AND AMEND IT AS FOLLOWS:

```ini
worker_processes 1;
events {
  worker_connections 1024;
}
http {
  include             mime.types;
  default_type        application/octet-stream;
  sendfile            on;
  keepalive_timeout   65;
  server {
    listen            80;
    server_name       localhost;
    root /usr/local/www/zabbix7;
    index index.php index.html index.htm;
    location / {
      try_files $uri $uri/ =404;
    }
    location ~ .php$ {
      fastcgi_split_path_info ^(.+\.php)(/.+)$;
      fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
      fastcgi_param PATH_INFO $fastcgi_path_info;
      fastcgi_param REMOTE_USER $remote_user;
      fastcgi_pass   127.0.0.1:9000;
      fastcgi_index index.php;
      include fastcgi_params;
    }

♪ I'm so sorry ♪
````

# CONFIGURE PHP

## EDIT __CODESPAN_0_

```sh
# cp /usr/local/etc/php.ini-production /usr/local/etc/php.ini
```

EDIT __CODESPAN_0_:

- FIND __CODESPAN_0 TO __CODESPAN_1 (NOTE TO DELETE THE ORIGINAL __CODESPAN_2_)
- FIND __CODESPAN_0... TO __CODESPAN_1_..
- FOUND __CODESPAN_0, MODIFIED TO __CODESPAN_1_
- FOUND __CODESPAN_0, MODIFIED TO __CODESPAN_1_


# Start service

```sh
# service postgresql restart
# service php_fpm start
# service nginx start
# service zabbix_server start
# service zabbix_agentd start
```

# Login


The default username and password for Zabfix are as follows:

- USERNAME: __CODESPAN_0_
- PASSWORD: __CODESPAN_0_

![.. ..gitbook/assets/Zabbix1.png]


# Configure Chinese

![..gitbook/assets/Zabbix2.png]

![.. ..gitbook/assets/Zabbix3.png]

![..gitbook/assets/Zabbix4.png]

# Fragmentation and unfinished business

# Log

- AGENT: __CODESPAN_0_
- SERVER: __CODESPAN_0_
- PHP-RELATED ERROR: __CODESPAN_0_

# To be resolved #

- Chinese
- There's not enough surveillance
- HTTP SECURITY SETTINGS

# References

- [Monitor Your Posts with Zabfix] (https://freebsdfoundation.org/our-work/journal/browser-based-edition/networking-10th-anniversary/practical-ports-monitor-your-hosts-with-zabbix/)

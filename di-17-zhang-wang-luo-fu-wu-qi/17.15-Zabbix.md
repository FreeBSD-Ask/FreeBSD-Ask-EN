# Section 17.15 Zabbix Surveillance (based on PostgreSQL)



# Install zabbix7-server

zabbix7-server is the server end. It is responsible for receiving and processing surveillance data and should be operated on the monitoring server.

The pkg installation will install surplus MySQL (and will be bound to death) and will be installed using Ports.

```sh '
#cd/usr/ports/net-mgmt/zabbix7-server/
# Make config
````

![..gitbook/assets/Zabbix.png]

Press `PGSQL ' and return keys as graph configuration:

```sh '
# Make install clean
````


# Install PostgreSQL


Installation:

```sh '
# pkg install postgresql16-server postgresql16-client
````

or

```sh '
#cd /usr/ports/datases/postgresql16-server/ & make install clean
#cd/usr/ports/datases/postgresql16-client/ & make install clean
````


# Install zabbix7-frontend

zabbix7-frontend is web-controlled frontend.

```sh '
# pkg in zabbix7-frontend-php83
````

PHPs will be installed automatically. The version installed in this document is PHP8.3 (wrong if PHP 8.4 is written) and can be seen in [zabbix7-frontend] (https://www.freshports.org/net-mgmt/zabbix7-frontend).

Or:

```sh '
#cd/usr/ports/net-mgmt/zabbix7-frontend/
# Make install clean
````


Pdo

Note PHP version:

```sh '
# pkg insphp83-pdo_pgsqlphp83-pgsql
````

or

```sh '
#cd /usr/ports/datases/php83-pdo_pgsql/ & make install clean
#cd /usr/ports/databases/php83-pgsql/ & make install clean
````


# Install zabbix7-agent

zabbix7-agent is responsible for data collection and is installed on monitored servers.

```sh '
# pkg install zabbix7-ent
````

Or...

```sh '
#cd/usr/ports/net-mgmt/zabbix7-agent/
# Make install clean
````

# Install nginx

```sh '
# Pkg install nginx
````

```sh '
#cd/usr/ports/www/nginx/
# Make install clean
````

Configure service startup

```sh '
# Service zabbix #
# For service zabbix #
# Service postgresql available
# With service #
# Service php_fpm capable
````

# Set database

Initialize Database

``sql
# service postgresql initdb #
# su - postgres # switch to database users
$/usr/local/bin/pg_ctl-D/var/db/postgres/data16-l logfilestart# Initialization service
$cd/usr/local/share/zabbix7/server/database/postgresql/
$psql
psql (16.8)
Type "help" for help.

template1=#create data zabbix; # Create zabbix Database
CREATE DATABASE
template1=#CREATE USER zabbix WITH PASWORD 'z'; # Set here the user zabbix password is z
CREATE ROLE
Postgres=#GRANT USAGE, CREATE on SCHEMA PUBLIC to zabbix; #
GRANT
Postgres=#GRANT ALL PRIVILEGES ON DATABASE zabbix TO zabbix; # has all permissions for zabbix databases to grant user zabbix
GRANT
Postgres=#grant all on data zabbix to zabbix; #
GRANT
Postgres=#ALTER DATABASE zabbix own to zabbix;#
ALTER DATABASE
Postgres=#\q
````

We must withdraw and continue:

``sql
$psql -U zabbix zabbix # Login to database zabbix
psql (16.8, server 16.7)
Type "help" for help.

zabbix=>i schema.sql# Imports a database, same as
CREATE TABLE
CREATE INDEX
CREATE TABLE
CREATE INDEX
CREATE TABLE
...and omitted...

zabbix =
INSERT 01
INSERT 01
INSERT 01
INSERT 01
INSERT 01
...and omitted...

zabbix=1 data.sql
START TRANSACTION
INSERT 0 4
INSERT 01
INSERT 0 2
...and omitted...
zabbix=#\
$ outside # quit database user
# I'm back
````

References

- [PostgreSQL15 Public Schema has no mandate to resolve the issue] (https://showme.codes/zh-cn/2024-01-postgresql15-public-schema-mission/)

# Setup Zabix Server

Zabfix ' s main profile is in `/usr/local/etc/zabbix7/zabbix_server.conf ' .

Add the following:

```ini '
SourceIP = 127.0.0.1
LogFile=/var/log/zabbix/zabbix_server.log
DBHost=
DBName=zabbix
DBUser=zabbix
DBPassword=z
Timeout = 4
LogSlowQueries = 3000
Stats Allowed IP=127.0.0.1
````

# Setup Zabix Agent

Zabix Agent profile at `/usr/local/etc/zabbix7/zabbix_agentd.conf '

Add the following:

```ini '
LogFile=/var/log/zabbix/zabbix_agentd.log
SourceIP = 127.0.0.1
Server = 127.0.0.1
ServerActive = 127.0.0.1
Hostname=ykla
````

# Configure Zabfix Frontend

Zabfix front-end configuration file template is at `/usr/local/www/zabbix7/conf/zabbix.conf.php.example ' .

Copy template:

```sh '
#cp /usr/local/www/zabbix7/conf/zabbix.conf.php.example/usr/local/www/zabbix7/conf/zabbix.conf.php
````

Edit `/usr/local/www/zabbix7/conf/zabbix.conf.php ' will:

```ini '
$DB ['TYPE'] = 'MYSQL';
$DB['SERVER'] = 'localhost';
$DB['PORT'] = '0';
$DB['DATABASE'] = 'zabbix';
$DB ['USER'] = 'zabbix';
$DB ['PASSWOORD'] = '';
````

Amend to read as follows:

```ini '
$DB ['TYPE'] = 'POSTGRESQL'; #Replace database with this
$DB ['SERVER']= 'localhost';
$DB['PORT'] = '0';
$DB['DATABASE'] = 'zabbix';
$DB ['USER'] = 'zabbix';
$DB ['PSSWORD'] = 'z'; # Here's your database password
````

# Configure nginx

Backup of original main profile:

```sh '
#cp/usr/local/etc/nginx/nginx.conf/usr/local/etc/nginx/nginx.conf.simple
````

Edit `/usr/local/etc/nginx/nginx.conf ' , emptied and amended to read as follows:

```ini '
Worker_processes 1;
This post is part of our special coverage Syria Protests 2011.
We're going to have to do this.
♪ I'm sorry ♪
http {
I don't know.
_type application/octet-stream;
I don't know, sendfile on;
(b) Keep alive_timeout 65;
Server {
It's a big deal.
_name localhost;
Root/usr/local/www/zabbix7;
I don't know.
Organisation
Try_files $uri $uri/=404;
♪ I'm sorry ♪
Local ~.php {
Fastcgi_split_path_info^(.+.php) (/.+) $;
Fastcgi_param SCRIPT_FILANAME $document_root$fastcgi_script_name;
Fastcgi_param PATH_INFO $fastcgi_path_info;
Fastcgi_param REMOTE_USER $remote_user;
Fastcgi_pass 127.0.0.1:9,000;
-Fastcgi_index index.php;
Include pastcgi_params;
♪ I'm sorry ♪

♪ I'm so sorry ♪
````

# Configure PHP

# # Edit `/usr/local/etc/php.ini-project'

```sh '
#cp /usr/local/etc/php.ini-prevention/usr/local/etc/php.ini
````

Edit `/usr/local/etc/php.ini ' :

- Found `; date.timezone = `date.timezone = Asia/Shanghai ' (note to delete the original `; `)
- Found `post_max_size = 8M = `post_max_size = 16M '
- Found 'max_execution_time = 30 ', modified to 'max_execution_time = 300 '
- Found `max_input_time = 60 ', modified to `max_input_time = 300 '


# Start service

```sh '
# Service postgresql restart
# Service php_fpm start
♪ Service nginx start
# Service zabbix #
# Service zabbix #
````

# Login


The default username and password for Zabfix are as follows:

- User name: `Admin '
- Password: `zabbix '

![.. ..gitbook/assets/Zabbix1.png]


# Configure Chinese

![..gitbook/assets/Zabbix2.png]

![.. ..gitbook/assets/Zabbix3.png]

![..gitbook/assets/Zabbix4.png]

# Fragmentation and unfinished business

# Log

- Agent: `/var/log/zabbix/zabbix_agentd.log '
- Server end: `/var/log/zabbix/zabbix_server.log '
- PHP-related error: '/var/log/nginx/error.log '

# To be resolved #

- Chinese.
- There's not enough surveillance.
- HTTP security settings

# References

- [Monitor Your Posts with Zabbix] (https://freebsdfoundation.org/our-work/journal/browser-based-edition/networking-10th-anniversary/practical-ports-monitor-your-hosts-with-zabbix/)

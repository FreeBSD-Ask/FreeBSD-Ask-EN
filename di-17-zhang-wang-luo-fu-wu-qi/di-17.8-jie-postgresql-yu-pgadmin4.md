# Section 17.8 PostgreSQL and pgAdmin4

PostgreSQL is a free object relationship database (Object-Relational Database, ORDB). PostgreSQL was first published in June 1989. There are several versions available on FreeBSD. More than MySQL in terms of throughput, source-code clarity and average time-consuming。

It's worth mentioning that PostgreSQL also originated from the University of California at Berkeley. PostgreSQL is licensed by [PostgreSQL license] (https://www.postgresql.org/about/licence/), similar to BSDL。

# PostgreSQL installation example (6 versions all)

# Install

```sh
# pkg install -y postgresql16-server
```

Or..

```sh
# cd /usr/ports/databases/postgresql16-server/ 
# make install clean
```

View installation configuration

```sh
For procedural languages and postgresql functions, please note that
you might have to update them when updating the server.
# 如果你使用了过程语言或 PostgreSQL 函数，更新服务器时可能也需要同步更新它们。

If you have many tumbles and many clits running
i'm sorry to bother you
well, apparently.
# if you have a large number of tables and clients, it is recommended to use sysctl to upgrade kern.maxfiles or to reconfigure kernel parameters。

The port is set up to use autovacuum for new data, but you might
there
is a periodic script, /usr/local/etc/periodic/ daily/502.pgsql, that
you can use it to backup and personal vacum on all
it's `vacum analize'
for autovacuum settings, please review
~postgres/data/postgresql.conf.
# the port defaults to enable aautovacum for the new database, but you should still move vacum and backup regularly。
# there is a daily script /usr/local/etc/periodic/ daily/502.pgsql that can be used to back up every night and vacum all databases。
# Default execution __CODESPAN_0_, available in scripts. See postgresql.conf for the setting of autovacum。

If you plan to access your PostgreSQL service using ODBC, please
/usr/local/share/postgresql/odbc.sql
to get the operations referred for ODS communication.
# If you want to access PostgreSQL through ODBC, run the Odbc.sql script to install the required compatibility functions。

Please note that if you use the rc script,
/usr/local/etc/rc.d/postgresql, to initiaize the data, unicode
(UTF-8) will be used to store caractor data by default
no, postgresql_litdb_flags or use login.conf settings dropped below to
see the start rc script for more information.
# If you initialize the database with rc scripts, the character data will be stored by default using UTF-8 encoding。
# you can change this by setting up postgresql_initdb_flags or login.conf, as detailed in the rc foot note。

To set lives, environment stuff like locale and collect and other
things, you can set up a class in/etc/login
add something simple to this to/etc/login.conf:
# if you need to set initialisation parameters such as resource limitations, language environment, sorting rules, you can predescribe a login class in /etc/login.conf。
Add something simple to this to/etc/login.conf:
I don't..
postgres: \\
:lang=en_US.UTF-8:\
:setenv=LC_COLLATE=C:\
:tc=default:
I don't..
# Example login type settings that define language and sorting rules。

and run 'cap_mkdb/etc/login.conf'.
Then add 'postgresql_login_class=postgres' to/etc/rc.conf, or
it's as the postgress user's login class in/etc/passwd.
# run cap_mkdb effective after adding login class and set postgresql_login_class。
# or specify this login class for postgres users directly in /etc/passwd。

== sync, corrected by elderman == @elder_man

To use PostgreSQL, enough it in rc.conf using

== sync, corrected by elderman ==
Enable PostgreSQL service。

To initialize the data, run

i don't know, service postgresql initdb
# Initializing the database。

You can then start PostgreSQL by running:

service postgresql start
# Start PostgreSQL service。

For postmaster settings, see ~postgres/data/postgresql.conf
# postmaster set in postgresql.conf。

FreeBSD's PostgreSQL port logs to syslog by default
See ~postgres/data/postgresql.conf for moreinfo
# PostgreSQL defaults on FreeBSD by syslog log, see postgresql.conf。

If you're not using a checking field like ZFS, you might..
it can be effective during
the initdb case, by adding the "--data-checksums"
the postgresql_initdb_flags rcvar
check the initdb(1) manpage for more information
and make sure you understand the performations.
# If you do not use a file system like ZFS with a checksum, it is recommended that the PostgreSQL data check function be activated。
# you can use --data-checksums at initdb stage, or pg_checksums later。
# please refer to the initdb manual and understand its possible performance implications。

== sync, corrected by elderman == @elder_man

SECURITY ADVICE
# Safety advice

If updating from a version 16x < 16.3
A security value was found in the system views pg_stats_ext
and pg_stats_ext_extprs, technically allowing officially based data
if this is of concern in your
instability, run the SQL script/usr/local/share/postgresql/fix-CVE-2024-4317sql
for debts, see
https://www.postgresql.org/support/security/CVE-2024-4317/
# if you upgrade from the following 16.3 versions, pg_stats_ext and pg_stats_ext_exprs have a security loophole that may lead to the authentication user seeing data that should not be seen。
# If you're concerned about this, please implement the six-CVE-2024-4317.sql for each database。
# For more information, see Official Gazette: https://www.postgresql.org/support/security/CVE-2024-4317/
````

# Add starter #

```sh
# service postgresql enable
```

# Initialize the database #

```sh
# service postgresql initdb
```

Example output:

```sql
root@ykla:~ # service postgresql initdb
The files belonging to this database system will be owned by user "postgres".
This user must also own the server process.

The data ruler will be intitiated with this local situation:
no, no, no, no
LC_COLLATE:
LC_CTYPE: C.UTF-8
LC_MSAGES: C.UTF-8
LC_MONETARY: C.UTF-8
LC_NUMERIC: C.UTF-8
LC_TIME: C.UTF-8
The default text will be set to "english".

Data page checks are disabled.

/ var/db/postgres/data16... ok
creating subdirectors... ok
i don't know if i'm going to be able to help you with this
i'm sorry, i'm sorry
i'm not sure I'm going to be able to do this
singing default time zero..
creating configries... ok
running bootstream... ok
i don't know what you're talking about
syncing data to disk... ok

initdb: warning: enabling "trust"
you can change this by tinging pg_hba. cof or using the option-A, or-auth-local and-auth-host, the next time you run initb.

You can now start the database service us:

/usr/local/bin/pg_ctl-D/var/db/postgres/data16-l logfilestart
````

# Login to use #

Postgresql default does not have root users and needs to login using the user __CODESPAN_0_。

Example output:

```sql
root@ykla:~ # psql
psql: FATAL:  role "root" does not exist
```

Correct use:

```sql
#切换用户
root@ykla:~ # su - postgres

# Start the service
$/usr/local/bin/pg_ctl-D/var/db/postgres/data16-l logfilestart

# create new user ykla and set password
You know, I've been thinking about it
Enter password for new rule:
Enter it again:
It's okay
# Create database
$ createdb new_db
#register in the database and give the user ykla access to the database。
$psql
psql (16.7)
Type "help" for help.

postgres=#ALTER USER ykla WITH ENCRYPTED PASSWORD 'password';
ALLER ROLLE
postgres=#
postgres =#GRANT ALL PRIVILES ON DATABASE new_db TO ykla;
GRANT
# Exiting the database
postgres=#q
$exit
root@ykla:
````

# Deep in PostgreSQL Service Management

# Initialization proposal #

THE INITIALIZATION OF THE DATABASE PROPOSAL IS TO USE __CODESPAN_0, WHICH IS THE EASIEST WAY. BUT THERE ARE SOME TECHNIQUES IN THERE。

Here is how to use __CODESPAN_0_rc script parameters。

THE PARAMETER __CODESPAN_0_ IS __CODESPAN_1_. THE MEANING IS CLEAR: ASSIGNED TO UTF-8 AND TO ASCII。

SUGGEST THE FOLLOWING SETTINGS FOR __CODESPAN_0:

```sh
# sysrc postgresql_initdb_flags="--encoding=utf-8 --lc-collate=C -A scram-sha-256 -W"
```

Explanation:

-_CODESPAN_0_FOR SPECIFYING THE DEFAULT AUTHENTICATION METHOD. OTHERWISE THE DEFAULT AUTHENTICATION METHOD IN __CODESPAN_1 IS __CODESPAN_2, I.E. NO PASSWORD LOGIN
- __CODESPAN_0_ IS USED TO REQUEST THE __CODESPAN_1_ USER PASSWORD AT THE TIME OF INITIALIZATION, SO THAT THE PASSWORD IS SET WITHOUT LOGIN。

THIS WOULD SIMPLIFY SOME INITIALIZATION. IT IS ALSO POSSIBLE TO CONTROL INITIALIZATION WITH __CODESPAN_0_ PARAMETERS。

# # Manage multiple database examples (clusters)

PostgreSQL can run several examples on a machine, which is very useful when testing different configurations and separating environments。

The tool for managing multiple database examples is commonly used on the Debian/Ubuntu system by ___CODESPAN_0, i.e., the encapsulation of __CODESPAN_1_。

FreeBSD does not have this tool, but the rc script on FreeBSD PostgreSQL contains these management features and is easy to use。

two naming examples will be created below: main, dev。

## # Configure Examples

```sh
# 增加一个 main 实例
# sysrc postgresql_profiles+=main  

# add a dev instance
# sysrc postgresql_profiles+=dev

# Of course, you can set several examples at once
# sysrc postgresql_profiles #

# corresponds to main case data catalogue2
# sysrc postgresql_main_data=/var/db/postgres/main

# corresponds to dev data directory3
#sysrc postgresql_dev_data=/var/db/postgres/dev

# Data directories must be set for each instance
# (see previous two)

# set initialization parameter 1 for main instance
# dev instance default to initialize and compare
# Sysrc postgresql_main_initdb_flags #

# Enable or close for each instance
# Sysrc postgresql
# Sysrc postgresql_dev_enable
````

Note:

-1 place the example name in the rc parameter name, which is the parameter name for the corresponding example。
- 2 ___ CODESPAN_0, __ CODESPAN_1_ ARE STILL AVAILABLE. THIS IS WHEN THESE PARAMETERS ARE USED AS DEFAULT VALUES FOR EXAMPLE PARAMETERS AND WHEN NO EXAMPLE PARAMETER IS FOUND. BUT THE DEFAULT PARAMETER WILL NOT BE USED WHEN YOU CLEARLY CONFIGURE THE EXAMPLE PARAMETER。
-3 In managing multiple examples, it is recommended that only the parameters associated with the example name be used, rather than those without the example name. The benefits are clarity and control flexibility, and different examples can be set up differently。

## # Initialise the directory of examples

```sh
# service postgresql initdb
```

This will initiate two database examples。

This method can also be used for initialization of the final designation of the example name of the order and for new examples:

```sh
# service postgresql initdb main
# service postgresql initdb dev
```

Note:**
>
> Two different examples must be run on different ports, so the port number of the corresponding example needs to be modified。

HERE __CODESPAN_0_USE THE DEFAULT __CODESPAN_1_PORT WITHOUT MODIFICATION; __CODESPAN_2_USE __CODESPAN_3_PORT TO MODIFY THE CORRESPONDING PROFILE

Modify __CODESPAN_0_. Found port rows, amend as follows:

```ini
port = 5433
```

# Start stop and restart #

```sh
# service postgresql start
# service postgresql status
# service postgresql restart
# service postgresql stop
```

This is done for all examples. Example:

```sh
# service postgresql start # 启动服务
===> postgresql profile: main 
start postgresql
===> postgresql profile: dev
start postgresql
# service postgresql status # 查看状态
===> postgresql profile: main
status postgresql
pg_ctl: server is running (PID: 2624)
/s/usr/local/bin/postgres "-D" "/var/db/postgres/main"
===> postgresql profile: dev
status postgresql
pg_ctl: server is running (PID: 2641)
/s/usr/local/bin/postgres "-D" "/var/db/postgres/dev"
# service postgresql restart # 重启服务
===> postgresql profile: main
restart postgresql
===> postgresql profile: dev
restart postgresql
# service postgresql status # 查看状态
===> postgresql profile: main
status postgresql
pg_ctl: server is running (PID: 2685)
/s/usr/local/bin/postgres "-D" "/var/db/postgres/main"
===> postgresql profile: dev
status postgresql
pg_ctl: server is running (PID: 2701)
/s/usr/local/bin/postgres "-D" "/var/db/postgres/dev"
# service postgresql stop # 停止服务
===> postgresql profile: main
stop postgresql
===> postgresql profile: dev
stop postgresql
# service postgresql status # 查看状态
===> postgresql profile: main
status postgresql
pg_ctl: no server running
===> postgresql profile: dev
status postgresql
pg_ctl: no server running
```

You can specify an instance name to operate alone:

```sh
# service postgresql start dev
# service postgresql restart dev
# service postgresql status dev
# service postgresql stop dev
```

Example:

```sh
# service postgresql start dev
start postgresql
# service postgresql status dev
status postgresql
pg_ctl: server is running (PID: 2807)
/s/usr/local/bin/postgres "-D" "/var/db/postgres/dev"
# service postgresql restart dev
restart postgresql
# service postgresql stop dev
stop postgresql
```

# Install pgAdmin4

The following curriculum is based on FreeBSD 13.0。

pgAdmin4 is the most popular open-source application for managing the PostgreSQL database server. pgAdmin4 provides a functional graphical user interface to easily manage the database. It was written in Python and Javascript/jQuery. It can be used in many environments, such as Linux, Windows, Unix, and in desktop and server mode。

Note**
>
>PgAdmin4 will not be installed unless the PostgreSQL database is installed。

pgAdmin4 needs to be run in python environments and installed through python pip, so python is installed first. This is the default version of Python 3.8, note that there is no python environment by default on FreeBSD 13. The following commands are available:

```sh
# python
python: Command not found   # 说明当前未安装 python 环境
```

# Install Python and pip

```sh
# pkg install python
```

the pip is the Python package manager. It is used to install and manage the Python package and the relying package relationship。

the virtualenv is used to create a virtual python environment, a python environment specific to the project。

This is actually being installed by creating a separate Python environment by virtualenv。

install pip from py38-pip package:

```sh
# pkg install py38-pip
```

# # install configuration virtualenv

Creates a separate Python environment using virtualenv. Virtualenv will create its own Python installed environment, which does not support a library with a global or another virtual environment. Runs the following commands to install Virtualenv。

```sh
# pkg install py38-virtualenv #（本次安装 python 版本是 3.8 故使用 py38）
```

Create a virtual environment for pgAdmin4 by running the following commands

```sh
# virtualenv-3.8 pgadmin4
```

If the creation is completed, the following display shows that a virtual environment called __CODESPAN_0_ was created under the root directory of the root user of root。

```python
Using base prefix '/usr/local'
New python executable in /home/vagrant/pgadmin4/bin/python3.8
Also creating executable in /home/vagrant/pgadmin4/bin/python
Installing setuptools, pip, wheel…done.
done.
```

# # install sqlite3

```sh
#pkg install py38-sqlite3
```

Activate the created virtual environment。

```sh
#source pgadmin4/bin/activate.csh
```

you'll see the shell has become (pgadmin4) (the following operations are performed under the shell)

Examples include:

```python
(pgadmin4) root@ykla:~ #

```

## Install pgAdmin4

The pip source is now always required to use https, which needs to be installed because of the lack of SSL certificates。

```python
(pgadmin4) root@ykla:~# pkg install ca_root_nss
```

then switch the pip to the source, here using the qinghua source:

```python
pip config set global.index-url https://pypi.tuna.tsinghua.edu.cn/simple
```

some of them depend on openjpeg for installation

```python
(pgadmin4) root@ykla:~# pkg install openjpeg
```

If wrong:

```python
WARNING: Retrying (Retry(total=3, connect=None, read=None, redirect=None, status=None)) after connection broken by 'SSLError(SSLCertVerificationError(1, '[SSL: CERTIFICATE_VERIFY_FAILED] certificate verify failed: certificate is not yet valid (_ssl.c:1136)'))': /simple/pgadmin4/
```

It's caused by incorrect times

```sh
ntpdate ntp.api.bz
(pgadmin4) root@ykla:~#  ntpdate ntp.api.bz
17 Dec 16:35:36 ntpdate[1453]: step time server 114.118.7.161 offset +401965.911037 sec
```

Then you can install pgAmdin4 and its dependent environment

```sh
(pgadmin4) root@ykla:~# pkg install rust
(pgadmin4) root@ykla:~# pip install pgadmin4
```

Note**
>
>If the memory is insufficient (less than 4GB) and there is no swap, __CODESPAN_0 __, add a swap if this problem arises。

Configure and run pgAdmin4

Create profile for pgAdmin4 after installation, copy pgAdmin4 profile:

```python
(pgadmin4) root@ykla:~# cp ./pgadmin4/lib/python3.8/site-packages/pgadmin4/config.py  ./pgadmin4/lib/python3.8/site-packages/pgadmin4/config_local.py
```

edits a local copy of the configuration file with the ee editor。

```sh
(pgadmin4) root@ykla:~# ee ./pgadmin4/lib/python3.8/site-packages/pgadmin4/config_local.py
```

FOUND __CODESPAN_0_ TO CHANGE THE DEFAULT SERVER INTERCEPTION ADDRESS TO `0.0.0.0`_. FOUND __CODESPAN_2_PORT FOR REABLE APPLICATION LISTENING。

Examples include:

```sh
DEFAULT_SERVER = '0.0.0.0'
DEFAULT_SERVER_PORT = 5050
```

Manually create software directories:

```sh
(pgadmin4) root@ykla:~# mkdir  -p /var/lib/pgadmin
(pgadmin4) root@ykla:~# mkdir /var/log/pgadmin
```

The following command is executed after the configuration file editing is completed to initialize the account number and login password。

```sh
(pgadmin4) root@ykla:~# pgadmin4
```

Examples are shown below:

```python
NOTE: Configuring authentication for SERVER mode.
Enter the email address and password to use for the initial pgAdmin user account:
Email address: your_email		# 输入你的邮件地址
Password: your_new_password		# 输入你的登录密码
Retype password:				# 再次输入密码
Starting pgAdmin 4. Please navigate to http://0.0.0.0:5050 in your browser.
```

Now we have installed and run pgAdmin4 and can access the web control panel by __CODESPAN_0_:

![...gitbook/assets/pglogin.png]

![...gitbook/assets/pglogin2.png]

![.. ..gitbook/assets/pglogin3.png]

# Keep pgAdmin4 running backstage

If the service closes the next time you want to run, use the installed user pgadmin4 (in this case __CODESPAN_0_) to enter the root directory and execute the following command:

```sh
root@ykla:~# source pgadmin4/bin/activate.csh
(pgadmin4) root@ykla:~# pgadmin4 &
```

HINT: `&` FOR RUNNING BACKSTAGE

ENTER __CODESPAN_0_ IN THE CURRENT INTERFACE AFTER THE SERVICE IS STARTED, PRESS THE RETURN BUTTON TO SWITCH TO THE FRONT-OFFICE COMMAND LINE TO ALLOW THE SERVICE PROGRAM TO RUN IN THE BACK-OFFICE。

Upgrade pgAdmin4

this is a test of whether to use a pip directly to upgrade an old version。

the pgadmin4 update is more frequent, if it is necessary to upgrade the pgadmin4 directory created with the original virtualenv and then execute the following instructions again with the installed user:

```python
root@ykla:~# virtualenv-3.8 pgadmin4
```

Activate after Virtual Directory is created

```python
root@ykla:~# source pgadmin4/bin/activate.csh
```

Do not open service after active, directly execute upgrade

```python
(pgadmin4) root@ykla:~# pip install --upgrade pgadmin4
```

Start-up after upgrade

```python
(pgadmin4) root@ykla:~# pgadmin4
```

The login account and password are still the same (no update hint after login, see the version as the latest)。

# section 17.10 programtheus monitor deployment

# Frame

[Frame]

prometheus monitor deployment as shown

- prometheus is the center of the entire surveillance
- gravana for graphical display of surveillance data
-exporter for data collection; prometheus supports multiple options: search __CODESPAN_0_
-alertmanager for warnings
- prometheus can use multiple remote storages

note: prometheus, grafana, exporter alertmanager, etc. do not need to be installed on the same machine or the same system, or on monitored nodes. the following prometheus, gravana, alertmanager is installed on the same machine, exporter as required。

In addition: If you have a problem with service opening, check ___CODESPAN_0_. The profile is mostly in yaml format, note indentation. If it's prometheus, you can check it first。

# Install basic tools

# install prometheus #

```sh
# pkg install prometheus2
```

Or:

```
# cd /usr/ports/net-mgmt/prometheus2/ 
# make install clean
```

# # Service line #

```sh
# service prometheus enable
# service prometheus start
```

# install gravana #

```sh
# pkg install grafana
```

Or:

```sh
# cd /usr/ports/www/grafana/ 
# make install clean
```

# # Service line #

```sh
# service grafana enable
# service grafana start
```

# # install node_exporter

```sh
# pkg install node_exporter
```

Or:

```sh
# cd /usr/ports/sysutils/node_exporter/ 
# make install clean
```

# # Service line #

```sh
# service node_exporter enable
# service node_exporter start
```

Configure

# prometheus

the main profile for prometheus is ___CODESPAN_0_, in which it is found:

```yml
scrape_configs:
  # The job name is added as a label `job=<job_name>` to any timeseries scraped from this config.
  - job_name: "prometheus"

    # metrics_path defaults to '/metrics'
    # scheme defaults to 'http'.

status_configs:
- targets:
````

__CODESPAN_0 is the node used to configure data collection, and the default __CODESPAN_1 here is the prometheus service itself。

ADD THE FOLLOWING:

```ini
scrape_configs:
  # The job name is added as a label `job=<job_name>` to any timeseries scraped from this config.
  - job_name: "prometheus"

    # metrics_path defaults to '/metrics'
    # scheme defaults to 'http'.

    static_configs:
      - targets: ["localhost:9090"]

-job_name: "node_exporter_local"
status_configs:
- targets:
````

restart programtheus:

```sh
service prometheus restart
```

This adds a new surveillance node to the prometheus, the mission name is ___CODESPAN_0_. Do not add multiple hosts to __CODESPAN_1_。

prometheus provides a web interface (default port number:9090) to view the monitoring target information as follows:

[Survey target] (..gitbook/assets/prometheus_target.png)

Graph page: Monitoring indicators can be viewed to support expressions. For example:

[Example of free memory] (./.gitbook/assets/prometheus_example_node_memory_free.png)

a little familiarization with the interface shows that it is not easy to look at the data, see the panel, etc. it's time to use gravana to show data in a more friendly way。

# gravaana #

Browser opens the web page of grafana (default port __CODESPAN_0_): default username `admin`_, password `admin`_. The following figure toggle the Chinese interface

[gravana switch chaines interface]

new connection to prometheus first

[contract prometheus 1] (..getbook/assets/grafana_contract_prometheus_1.png)

[contract prometheus 2] (..getbook/assets/grafana_contract_prometheus_2.png)

[contract prometheus 3] (..getbook/assets/grafana_contract_prometheus_3.png)

Create dashboard with created connection (import preset dashboard)

[Build dashboard 1] (..gitbook/assets/grafana_dashboard_create_1.png)

[Build dashboard 2] (..gitbook/assets/grafana_dashboard_create_2.png)

[Build dashboard 3] (..gitbook/assets/grafana_dashboard_create_3.png)

[Build dashboard 4] (. ./ .gitbook/assets/grafana_dashboard_create_4.png)

[Build dashboard 5] (..gitbook/assets/grafana_dashboard_create_5png)

# Security authentication

Only login grafana needs a password by default. Connections between components at http: e. g. __CODESPAN_0 __ can be obtained directly from __CODESPAN_1 __, so monitor data; prometheus can be accessed directly from __CODESPAN_2 __. It is not safe to expose such information directly in a non-experimental environment, and therefore safe certification is necessary。

Basic authentication

# prometheus

- EDIT __CODESPAN_0_, IN THE FOLLOWING FORMAT:

```yml
basic_auth_users:
  prometheususer: $2a$10$mxpc1PdYgOwvGepNtCuBKO6RXVUzLDg8feOvuz6szOsBa9M28ECfe
```

In the second line: the colon is a user name, and the impostor is a bcrypt Hash value -- this is generated using the str tool, and other tools can be used, assuming the password is __CODESPAN_0_:

```sh
# pkg install sttr
$ sttr bcrypt prometheuspassword
$2a$10$mxpc1PdYgOwvGepNtCuBKO6RXVUzLDg8feOvuz6szOsBa9M28ECfe%
```

HERE'S __CODESPAN_0_ EXCEPT THAT THE OUTPUT IN THE TERMINAL APPEARS WITHOUT A LINE BREAK, AND IGNORES IT。

- EDIT __CODESPAN_0_

add the following three rows to the programtheus configuration:

```
    basic_auth:
      username: prometheususer
      password: prometheuspassword
```

Note indentation, full example:

```yml
scrape_configs:
  # The job name is added as a label `job=<job_name>` to any timeseries scraped from this config.
  - job_name: "prometheus"

    # metrics_path defaults to '/metrics'
    # scheme defaults to 'http'.

    static_configs:
      - targets: ["localhost:9090"]
    basic_auth:
      username: prometheususer
      password: prometheuspassword

-job_name: "node_exporter_local"
status_configs:
- targets:
````

- modify prometheus start configuration and restart

```sh
# sysrc prometheus_args="--web.config.file='/usr/local/etc/prometheus_webconfig.yml'"
# service prometheus restart
```

When accessing __CODESPAN_0_, prometheus will request to log in first

[login prometheus] (. .gitbook/assets/prometheus_basic_auth_login.png)

the corresponding gravana sets the authentication information when connecting the data source

# asic_auth #

here's an example of this

- EDIT __CODESPAN_0_, IN THE FOLLOWING FORMAT:

```yml
basic_auth_users:
  node_exporter_user: $2a$10$XoJoz.x.m9FTEbaTF3hBsehE9C8zCWjCQUHkSL0Isk53UnUTjR4hi
```

- modify node_exporter start configuration and restart

```
# sysrc node_exporter_args="--web.config.file='/usr/local/etc/node_exporter_webconfig.yml'"
# service node_exporter restart
```

- EDIT __CODESPAN_0, AS FOLLOWS:

```yml
scrape_configs:
  # The job name is added as a label `job=<job_name>` to any timeseries scraped from this config.
  - job_name: "prometheus"

    # metrics_path defaults to '/metrics'
    # scheme defaults to 'http'.

    static_configs:
      - targets: ["localhost:9090"]
    basic_auth:
      username: tome
      password: jake

-job_name: "node_exporter_local"
status_configs:
- targets:
basic_auth:
username: node_exporter_user
password: node_exporter_password
````

restart prometheus

```sh
service prometheus restart
```

# # ca certificate authentication

in cases where security requirements are high, a ca certificate certification may also be used to enhance security, but this is not an approach that every exporter supports。

here again, for example, node_exporter, assuming node_exporter node ip is 10.011.1。

Could not close temporary folder: %s

```sh
# 生成 CA 私钥
openssl genpkey -algorithm RSA -out ca.key
# 生成 CA 证书
openssl req -new -x509 -key ca.key -out ca.crt -days 3650 -subj "/CN=my-ca"
```

### generate prometheusend certificate

```sh
# 生成 Prometheus 客户端私钥
openssl genpkey -algorithm RSA -out prometheus.key
# 生成客户端证书请求
openssl req -new -key prometheus.key -out prometheus.csr -subj "/CN=prometheus-client"
# 使用 CA 对客户端证书请求进行签名
openssl x509 -req -in prometheus.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out prometheus.crt -days 3650
```

### generate node_exporterend certificates

1. Create an OpenSSL profile to specify the SAN (Subject Alternative Name) at the time the certificate is generated。

create a file like san.cnf. it reads as follows:

```ini
[ req ]
distinguished_name = req_distinguished_name
x509_extensions = v3_ca
prompt = no

[req_distinguished_name]
CN = node-exporter-server

[v3_ca]
# ADD SAN FIELD
subjectAltName =@alt_names

[alt_names]
DNS.1 = node-exporter-server.example.com
IP.1 = 10.0.55.1 # ADD IT IF YOU USE AN IP ADDRESS
````

2. USE SAN CONFIGURATION WHEN GENERATING CERTIFICATE REQUESTS

USE THIS PROFILE TO GENERATE A CERTIFICATE SIGNATURE REQUEST (CSR) AND A CERTIFICATE。

```sh
# 首先，生成私钥
openssl genpkey -algorithm RSA -out node_exporter.key
#然后，生成带有 SAN 字段的 CSR：
openssl req -new -key node_exporter.key -out node_exporter.csr -config san.cnf
用 CA 签署证书
openssl x509 -req -in node_exporter.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out node_exporter.crt -days 3650 -extensions v3_ca -extfile san.cnf
```

Specifies that the SAN (Subject Alternative Name) is important, otherwise it may not be accessible. You can also configure certificates to ignore certification in prometheus, but this is contrary to security, so no more references are made here。

## configure prometheus and node_exporter

EDIT __CODESPAN_0_, AS FOLLOWS:

```yml
tls_server_config:
  cert_file: /path/to/node_exporter.crt
  key_file: /path/to/node_exporter.key
  client_ca_file: /path/to/ca.crt
  client_auth_type: "RequireAndVerifyClientCert"
```

The last sentence is important, and only this option is safe。

MODIFY __CODESPAN_0_

```yml
  - job_name: "node_exporter_local"
    static_configs:
      - targets: ["10.0.55.1:9100"]
    scheme: 'https'
    tls_config:
      cert_file: '/path/to/prometheus.crt'
      key_file: '/path/to/prometheus.key'
      ca_file: '/path/to/ca.crt'
```

Both documents are mentioned in [Basic accreditation] (#basic authentication) and are used in the same way。

Note also the location and access of the key and the certificate file and give only minimum access rights。

restart prometheus and node_exporter simply。

# pushgateway

this is all presented in a pull format, drawn by prometheus from every exporter, pushgateway is where the monitoring point automatically pushes the data to pushgateway, then pulls the data from pushgateway by prometheus. suitable for temporary and bulk assignments。

1. install pushgateway

```sh
# pkg install pushgateway
# service pushgateway enable
# service pushgateway start
```

configure pushgateway in prometheus

EDIT __CODESPAN_0_ ADD THE FOLLOWING:

```yml
  - job_name: "pushgateway"
    static_configs:
      - targets: ["localhost:9091"]
```

Examples of temporary mandates

Assuming there is a management script to view the zombie process, as follows:

```sh
num=$(ps aux |awk 'NR>1 {print $8}'|grep Z|wc -l)
echo "process_zombie $num"|curl --data-binary @- http://10.0.55.1:9091/metrics/job/check_processes
```

The first line is used to check the number of zombie processes, and the second line sends the number of zombie processes to the Pushgateway. (Note: Data sent must end __CODESPAN_0_)

Call the police

prometheus alarm relies on the alertmanager component. This example is given in the case of jail_exporter (the configuration of the installation is simpler, see above, no more. __CODESPAN_0 is also required to write __CODESPAN_1_ to open the system accountkeeping function)。

Installation:

```sh
# pkg install alertmanager
```

2. alertmanager router rules

only simple emails are shown here, and other forms of notification are also supported。

```yml
global:
  smtp_smarthost: 'smtp.sina.com:25'
  smtp_from: 'xxxxx@sina.com'
  smtp_auth_username: 'xxxxx'
  smtp_auth_password: 'xxxxxxxxxxxxxxx'
templates:
  - '/etc/alertmanager/template/*.tmpl'
route:
  group_by: ['alertname']
  group_wait: 30s
  group_interval: 5m
  repeat_interval: 3h
  receiver: safreya

routes:
- watchers:
-alertname = "jail"
receiver: xxxx
routes:
- watchers:
- severity is "critical."
receiver: xxxx

receevers:
-name: 'xxxx'
email_configs:
- to: 'xxxx@qq.com'
````

of which global specifies the global configuration, the smtp service is specified here. route specifies the router rule for sending. receevers specifies the recipient information。

3. Configure warning rules

PREPARATION OF A RULE DOCUMENT SUCH AS __CODESPAN_0_:

```yml
groups:
- name: jails-alerts
  rules:
  - alert: jail_down
    expr: absent(jail_id{name="dox"})
    for: 5m
    labels:
      severity: critical
    annotations:
      summary: "jail dox is down"
      description: "jail dox is down"
```

COULD NOT CLOSE TEMPORARY FOLDER: %S。

__CODESPAN_0_specify a warning trigger condition expression, which is a jail called dox. If there is no jail id, trigger the alarm。

{\CHFFFFFF}{\CH00FF00} REFERS TO THE WAITING TIME TO TRIGGER THE ALARM, WHICH IS FIVE MINUTES. THAT IS, IF RESOLVED WITHIN 5 MINUTES, NO WARNING IS SENT

4. introduction of rule files in prometheus configuration file and connection to alertmanager

```yml
# Alertmanager configuration
alerting:
  alertmanagers:
    - static_configs:
        - targets:
          - 10.0.55.1:9093

♪ Load rules once and periodically evaluate them ♪.
# i don't know #
- "first_rules.yml"
- "second_rules.yml"
"/usr/local/etc/prometheus/alert.rules.yml"
````

restart prometheus and alertmanager

```sh
service prometheus restart
service alertmanager restart
```

6. Testing

__CODESPAN_0_Close jail, trigger rule, send alarm e-mail in five minutes. __CODESPAN_1_open jail and reset the alarm rule to inactive。

# Remote storage

prometheus data supports remote storage. take the example of influxdb below。

1. install configuration influxdb:

```sh
# pkg install influxdb
# service influxd enable
# service influxd start
```

note the influxdb service name is influxd。

Considering security concerns, you should write __CODESPAN_0, and open http authentication in http section:

```ini
[http]
auth-enabled = true
```

2. create influxdb users and databases

ENTER THE COMMAND LINE CLIENT WITH __CODESPAN_0_

```sh
create database "prometheus"
create user prometheus with password '123'
grant read on prometheus to prometheus
grant write on prometheus to prometheus
```

restart influxdb only。

configure prometheus to connect

EDIT __CODESPAN_0_

```yml
remote_write:
  - url: "http://10.0.55.1:8086/api/v1/prom/write?db=prometheus&u=prometheus&p=123"
remote_read:
  - url: "http://10.0.55.1:8086/api/v1/prom/read?db=prometheus&u=prometheus&p=123"
```

Influxdb for FreeBSD pkg is v1 version with api configuration for v1

restart prometheus simply。

4. Certification

A DATABASE USING __CODESPAN_0_ COMMAND, SEARCH FOR DATA INDICATORS WILL BE:

```sh
use prometheus
select * from jail_id
1739497283285000000 jail_id  192.168.0.100:9452 jail_exporter prometheus 1
1739497298285000000 jail_id  192.168.0.100:9452 jail_exporter dox        4
1739497298285000000 jail_id  192.168.0.100:9452 jail_exporter prometheus 1
1739497313285000000 jail_id  192.168.0.100:9452 jail_exporter dox        4
1739497313285000000 jail_id  192.168.0.100:9452 jail_exporter prometheus 1
1739497328285000000 jail_id  192.168.0.100:9452 jail_exporter dox        4
1739497328285000000 jail_id  192.168.0.100:9452 jail_exporter prometheus 1
1739497343285000000 jail_id  192.168.0.100:9452 jail_exporter dox        4
1739497343285000000 jail_id  192.168.0.100:9452 jail_exporter prometheus 1
1739497358285000000 jail_id  192.168.0.100:9452 jail_exporter dox        4
1739497358285000000 jail_id  192.168.0.100:9452 jail_exporter prometheus 1
1739497373285000000 jail_id  192.168.0.100:9452 jail_exporter dox        4
1739497373285000000 jail_id  192.168.0.100:9452 jail_exporter prometheus 1
```

# References

[exporter communication reference] (https://github.com/prometheus/exporter-toolkit/blob/master/docs/web-configration.md)

[prometheus configuration] (https://github.com/prometheus/prometheus/blob/main/docs/conformation/conformation.md)

[Remote Storage Relaed] (https://prometheus.io/docs/opulating/institutions/#remote-endpoints-and-storage)

[alertmanager referral]

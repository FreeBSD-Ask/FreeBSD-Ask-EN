# Section 17.10 programtheus monitor deployment

# Frame

[Framework] (. . .gitbook/assets/mermaid.png)

Prometheus monitor deployment as shown

- Prometheus is the center of the entire surveillance.
- gravana for graphical display of surveillance data
-exporter for data collection; prometheus supports multiple options: `pkg search-L name-D prometheus '
-Alertmanager for warnings
- Prometheus can use multiple remote storages.

Note: Prometheus, Grafana, Exporter alertmanager, etc. do not need to be installed on the same machine or the same system, or on monitored nodes. The following prometheus, gravana, alertmanager is installed on the same machine, exporter as required.

In addition: If there is a problem with service opening, check `/var/log/daemon.log ' . The profile is mostly in yaml format, note indentation. In the case of prometheus, the correctness may be checked first by `promtool check ' .

# Install basic tools

# Install prometheus #

```sh '
# pkg install prometheus2
````

Or:

````
#cd /usr/ports/net-mgmt/prometheus2/
# Make install clean
````

# # Service line #

```sh '
♪ Service prometheus able
# Service prometheus start
````

# Install gravana #

```sh '
# Pkg install grafana
````

Or:

```sh '
#cd/usr/ports/www/grafana/
# Make install clean
````

# # Service line #

```sh '
♪ Service gravaana enough
# Service gravaana start
````

# # Install node_exporter

```sh '
# pkg install node_exporter
````

Or:

```sh '
# cd/usr/ports/sysutils/node_exporter/
# Make install clean
````

# # Service line #

```sh '
♪ service node_exporter able
# For service node_exporter start
````

Configure

# Prometheus

The main profile for prometheus is `/usr/local/etc/prometheus.yml ' , where:

``yml
Scrape_configs:
♪ The job name is aded as a label ♪ to any timeserves scraped from this config.
-job_name: "prometheus"

# Metrics #
# Schime damages to 'http'.

Status_configs:
- Targets:
````

`scrape_configs ' is the node used to configure data collection, and the default `targets:["localhost:9090"] `is prometheus services per se.

Add `node_exporter ' to monitor host information and write under `scrape_configs ' as follows:

```ini '
Scrape_configs:
♪ The job name is aded as a label ♪ to any timeserves scraped from this config.
-job_name: "prometheus"

# Metrics #
# Schime damages to 'http'.

Status_configs:
- Targets:

-job_name: "node_exporter_local"
Status_configs:
- Targets:
````

Restart programtheus:

```sh '
I don't know.
````

This added a new surveillance node to prometheus, with the mission 'node_exporter_local ' . More than one host can be added to `[] '.

Prometheus provides a web interface (default port number:9090) to view the monitoring target information as follows:

[Monitoring target](./.gitbook/assets/prometheus_target.png)

Graph page: Monitoring indicators can be viewed to support expressions. For example:

! [Examples of free memory] (. .gitbook/assets/prometheus_example_node_memory_free.png)

A little familiarization with the interface shows that it is not easy to look at the data, see the panel, etc. It's time to use gravana to show data in a more friendly way.

# gravaana #

Browser opens the web page of gravana (default port `3000 '): default user name `admin ' , password `admin ' . The following figure toggle the Chinese interface

[grafana Switch Chinese Interface] (. .gitbook/assets/grafana_setting_zh_language.png)

New connection to prometheus first

! [connection prometheus 1] (./.gitbook/assets/grafana_contract_prometheus_1.png)

[connection prometheus 2] (. .gitbook/assets/grafana_contract_prometheus_2.png)

! [connecting prometheus 3] (. .gitbook/assets/grafana_contract_prometheus_3.png)

Create dashboard with created connection (import preset dashboard)

! [Build dashboard 1] (.. .gitbook/assets/grafana_dashboard_create_1.png)

! [Build dashboard 2] (. . . .gitbook/assets/grafana_dashboard_create_2.png)

! [Build dashboard 3] (.. .gitbook/assets/grafana_dashboard_create_3.png)

! [Build dashboard 4] (.. .gitbook/assets/grafana_dashboard_create_4.png)

! [Build dashboards 5] (..gitbook/assets/grafana_dashboard_create_5png)

# Security authentication

Only login grafana needs a password by default. Links between components are available at http: e.g. `node_exporter ' can access `http://ip:9100/`directly so monitor data; prometheus can access directly at `http://ip:9090/`. It is not safe to expose such information directly in a non-experimental environment, and therefore safe certification is necessary.

Basic authentication

# prometheus

- Edit `/usr/local/etc/prometheus_webconfig.yml ' in the following format:

``yml
Basic_auth_users:
Prometheususer: $2a$10 mxpc1PdYgOwvGepNtCuBKO6RXVULDg8feOvuz6szBa9M28ECfe
````

In the second line: the colon is a user name, the impostor is a bcrypt Hash value -- this is generated using the str tool or other tools, assuming the password is `prometheuspassword ' :

```sh '
# pkg install str
$ sttr bcrypt prometheuspassword
$2a$10 mxpc1PdYgOwvGepNtCuBKO6RXVUzLDg8feOvuz6szBa9M28ECfe%
````

`% ' here is just that the output in the terminal appears without a line break, and ignores it.

- Edit `/usr/local/etc/prometheus.yml'

Add the following three rows to the programtheus configuration:

````
Basic_auth:
_Other Organiser
Password: prometheuspassword
````

Note indentation, full example:

``yml
Scrape_configs:
The job name is aded as a♪ To any timesellers scraped from this config.
-job_name: "prometheus"

# Metrics #
# Schime damages to 'http'.

Status_configs:
- Targets:
Basic_auth:
_Other Organiser
Password: prometheuspassword

-job_name: "node_exporter_local"
Status_configs:
- Targets:
````

- Modify prometheus start configuration and restart

```sh '
# sysrc prometheus_args= --web.config.file='/usr/local/etc/prometheus_webconfig.yml'
# Service prometheus present
````

Visit `http://ip:90900/ ' , prometheus will request to log in first

[Loging on prometheus] (./.gitbook/assets/prometheus_basic_auth_login.png)

The corresponding gravana sets the authentication information when connecting the data source

# Asic_auth #

Here's an example of this.

- Edit `/usr/local/etc/node_exporter_webconfig.yml ' in the following format:

``yml
Basic_auth_users:
Node_exporter_user: $2a$10XoJoz.x.m9FtebaTF3hBsehE9C8zCWjCQUHkSL0Isk53UnUTjR4hi
````

- Modify node_exporter start configuration and restart

````
# sysrc node_exporter_args= --web.config.file='/usr/local/etc/node_exporter_webconfig.yml'
♪ Service node_exporter present
````

- Edit `/usr/local/etc/prometheus.yml', as follows:

``yml
Scrape_configs:
♪ The job name is aded as a label ♪ to any timeserves scraped from this config.
-job_name: "prometheus"

# Metrics #
# Schime damages to 'http'.

Status_configs:
- Targets:
Basic_auth:
username: tome
Password: Jake

-job_name: "node_exporter_local"
Status_configs:
- Targets:
Basic_auth:
username: node_exporter_user
Password: node_exporter_password
````

Restart Prometheus

```sh '
I don't know.
````

# # ca certificate authentication

In cases where security requirements are high, a ca certificate certification may also be used to enhance security, but this is not an approach that every exporter supports.

Here again, for example, node_exporter, assuming node_exporter node ip is 10.011.1.

Could not close temporary folder: %s

```sh '
# Generate CA private key
It's not like it's a good idea.
# Generate CA certificates
"/CN=my-ca"
````

### Generate prometheusend certificate

```sh '
# Generate Prometheus client private key
It's not like you're going to have to do it.
# Generate client certificate request
"/CN=prometheus-client"
# Use CA to sign client certificate requests
I'm sorry, I'm sorry.
````

### Generate node_exporterend certificates

1. Create an OpenSSL profile to specify the SAN (Subject Alternative Name) at the time the certificate is generated.

Create a file like san.cnf. It reads as follows:

```ini '
[req]
= req_distinguished_name
x509_extensions = v3_ca
Prompt = no

[req_distinguished_name]
CN = node-exporter-server

[v3_ca]
# Add SAN field
SubjectAltName =@alt_names

[Alt_names]
DNS.1 = node-exporter-server.example.com
IP.1 = 10.0.55.1 # Add it if you use an IP address
````

2. Use SAN configuration when generating certificate requests

Use this profile to generate a certificate signature request (CSR) and a certificate.

```sh '
# First, generate a private key
It's not like you're in trouble.
# Then generate CSRs with SAN fields:
I'm not sure if you're going to do this.
Sign Certificate with CA
I'm sorry, I'm sorry.
````

Specifies that the SAN (Subject Alternative Name) is important, otherwise it may not be accessible. You can also configure certificates to ignore certification in prometheus, but this is contrary to security, so no more references are made here.

## Configure prometheus and node_exporter

Edit `/usr/local/etc/node_exporter_webconfig.yml ' as follows:

``yml
tls_server_config:
cart_file: /path/to/node_exporter.crt
Key_file: /path/to/node_exporter.key
clint_ca_file: /path/to/ca.crt
"RequireAndVerifyClit"
````

The last sentence is important, and only this option is safe.

Modify `/usr/local/etc/prometheus.yml'

``yml
-job_name: "node_exporter_local"
Status_configs:
- Targets: ["10.0.55.1:9100"]
Scheme: 'https'
tls_config:
curt_file: '/path/to/prometheus.crt'
Key_file: '/path/to/prometheus.key'
c_file: '/path/to/ca.crt'
````

Both documents are mentioned in [basic authentication] (#basic authentication) and are used in the same way.

Note also the location and access of the key and the certificate file and give only minimum access rights.

Restart prometheus and node_exporter simply.

# Pushgateway

It's all in a pull by prometheus from every exporterPull, Pushgateway is where the monitoring point automatically pushs the data to Pushgateway, then pulls the data from Pushgateway by Prometheus. Suitable for temporary and bulk assignments.

1. Install Pushgateway

```sh '
# pkg install Pushgateway
♪ Service Pushgateway enough
# Service Pushgateway start
````

Configure pushgateway in prometheus

Edit `/usr/local/etc/prometheus.yml ' to add the following:

``yml
-job_name: "pushgateway"
Status_configs:
- Targets: ["localhost:9091"]
````

Examples of temporary mandates

Assuming there is a management script to view the zombie process, as follows:

```sh '
{\cHFFFFFF}{\cH00FF00} {\cHFFFFFF}{\cH00FF00} {\cHFFFFFF}{\cH00FF00} {\cHFFFFFF}{\cH00FFFF} {\cHFFFFFF}{\cH00FF00} {\cHFFFFFF}{\cH00FF00} {\cHFFFFFF}
eccurl-data-binary@-http://10.0.55.1:9091/métrics/job/check_processes
````

The first line is used to check the number of zombie processes, and the second line sends the number of zombie processes to the Pushgateway. (Note: The data sent must end \n'

Call the police

Prometheus alarm relies on the alertmanager component. This example is given in the case of jail_exporter (the configuration of the installation is simpler, see above, no more. There is also a need to write `kern.ract.enable=1 ' in `/boot/loader.conf ' to turn on the system account keeping function.

Installation:

```sh '
# Pkg install alertmanager
````

2. Alertmanager router rules

Only simple emails are shown here, and other forms of notification are also supported.

``yml
Global:
smtp_smarthost: 'smtp.sina.com:25'
smtp_from: 'xxxx@sina.com'
smtp_auth_username: 'xxxx'
Smtp_auth_password: 'xxxxxxxxxxxxxxxxx'
TERMINATES:
- '/etc/alertmanager/template/*.tmpl'
Route:
['alertname']
Group_wait: 30s
Group_interval: 5m
Repeat_interval: 3h
I'm sorry, but I'm sorry.

routes:
- Watchers:
-Alertname = "jail"
Receiver: xxxx
routes:
- Watchers:
- Severity is "critical."
Receiver: xxxx

receevers:
-name: 'xxxx'
Email_configs:
- to: 'xxxx@qq.com'
````

Of which Global specifies the global configuration, the smtp service is specified here. Route specifies the router rule for sending. receevers specifies the recipient information.

3. Configure warning rules

Preparation of a rule-based document such as `/usr/local/etc/prometheus/alert.rules.yml`:

``yml
I'm sorry.
- Name: jails-alerts
RULES:
- I'm sorry.
Expr: absent
For: 5m
Labels:
Severity: criminal
Annotations:
"jail dox is down"
"jail dox is down"
````

`alert ' designates the name of the alarm.

`expr ' specifies a warning trigger condition expression, which is a Jail named dox. If there is no jail id, trigger the alarm.

`for ' refers to the waiting time to trigger the alarm, which is 5 minutes. That is, if resolved within 5 minutes, no warning is sent.

4. Introduction of rule files in prometheus configuration file and connection to alertmanager

``yml
♪ Alertmanager configuration
There's nothing wrong with that, but it's not that.
Here's the thing.
- status_configs:
- Targets:
- 10.0.55.1:9093

♪ Load rules once and periodically evaluate them ♪
# I don't know #
- "first_rules.yml"
- "second_rules.yml"
"/usr/local/etc/prometheus/alert.rules.yml"
````

Restart prometheus and alertmanager

```sh '
I don't know.
It's just that I've been working for a long time.
````

6. Testing

`jail-r dox ' closes jail, triggers rules, sends alarm e-mails five minutes later. `jail-c dox ' opens jail and the alarm rules are replaced with inactive.

# Remote storage

Prometheus data supports remote storage. Take the example of influxdb below.

1. Install configuration influxdb:

```sh '
# pkg install influxdb
# For service influxd enough
# Service influxd start
````

Note the influxdb service name is influxd.

Considering security concerns should be written `/usr/local/etc/influxd.conf ' , which opens the http authentication:

```ini '
[http]
= true
````

2. Create influxdb users and databases

Use `influx 'to enter the command line client

```sh '
"prometheus"
"Create user prometheus with password '123."
♪ Grant read on prometheus to prometheus ♪
I'm going to tell you, Grant write on prometheus to prometheus
````

Restart influxdb only.

Configure prometheus to connect

Edit `/usr/local/etc/prometheus.yml'

``yml
Remote_write:
-url: "http://10.0.55.1:8086/api/v1/prom/write?db=prometheus&u=prometheus&p=123"
Remote_read:
-url: "http://10.0.55.1:8086/api/v1/prom/read?db=prometheus&u=prometheus&p=123"
````

Influxdb for FreeBSD pkg is v1 version with api configuration for v1

Restart prometheus simply.

4. Certification

A database using a `influx ' command to search for data indicators can:

```sh '
I'm sorry.
♪ From jail_id ♪
173949728328500000 jail_id 192/168.0.100: 9452 jail_exporter prometheus 1
173949729885 million jail_id 192/168.0.100: 9452 jail_exporter dox 4
173949729825000 jail_id 192/168.0.100: 9452 jail_exporter prometheus 1
1739497313285 million jail_id 192.168.0.100: 9452 jail_exporter dox 4
1739497313285 million jail_id192.168.0.100: 9452 jail_exporter prometheus 1
173949732805000 jail_id 192/168.0.100: 9452 jail_exporter dox 4
173949732805000 jail_id 192.168.0.100: 9452 jail_exporter prometheus 1
173949734325 million jail_id192.168.0.100: 9452 jail_exporter dox 4
1739497343280.00000 jail_id192.168.0.100: 9452 jail_exporter prometheus 1
173949735885 million jail_id 192.168.0.100: 9452 jail_exporter dox 4
173949735885 million jail_id 192.168.0.100: 9452 jail_exporter prometheus 1
173949737285 million jail_id 192/168.0.100: 9452 jail_exporter dox 4
173949737285 million jail_id 192.168.0.100: 9452 jail_exporter prometheus 1
````

# references

[exporter configuration reference] (https://github.com/prometheus/exporter-toolkit/blob/master/docs/web-configration.md)

[prometheus configuration reference] (https://github.com/prometheus/prometheus/blob/main/docs/conformation/configration.md)

[remote storage-related] (https://prometheus.io/docs/opulating/integrations/#remote-endpoints-and-storage)

[alertmanager configuration reference] (https://prometheus.io/docs/alering/latest/configration/)

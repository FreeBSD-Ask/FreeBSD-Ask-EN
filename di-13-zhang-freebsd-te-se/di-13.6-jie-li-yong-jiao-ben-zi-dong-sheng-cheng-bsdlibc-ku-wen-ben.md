# Section 13.6 Automatically generate BSDlibc library text using scripts

# Forum programme

- original address [where's bsd libc documentation?] (https://forums.freebsd.org/threads/wheres-bsd-libc-documentation.63107/)。
- author mrclksr。

The original programme has lapsed。

# Improvement programme

Improvements to the original programme:

- ___ CODESPAN_0 __ __ __ CODESPAN_1 __ not only match libc, but also libcalendar and so on, the library starting with libc. It can be written as CODESPAN_2 to correct this problem
- The organization of the text is not properly organized, it is not a combination of functional modules, etc., and it is not appropriate for learning, but it is feasible for quick-checking。

---|---

The required package is first installed。

- install with pkg:

```sh
# pkg install groff ghostscript10
```

- Or install with Ports:

```sh
# cd /usr/ports/textproc/groff/ && make install clean
# cd /usr/ports/print/ghostscript10/ && make install clean
```

---|---

Then do the script:

```sh
#!/bin/sh
fetch https://mirrors.ustc.edu.cn/freebsd/releases/amd64/14.2-RELEASE/src.txz   # 下载 src
tar jxvf src.txz usr/src/lib/libc/*.[23]    # 解压 man2，man3
mv usr/src/lib/libc libc          # 减小目录层级
rm -rf usr
find libc -name *.[23] > content.list    # 向 content.list 写入 man2，man3 路径
cat content.list | sed -e 's/libc\///' -e 's/\/.*$//' | uniq |sort > level1.list   # 删除路径中 libc/ 前缀，删除尾部到 /,
                                                                                   # 目地是保留 libc 路径下的第一层路径名，作为一级目录名使用
# 生成 level1.list 后可调整 level1.list 中的行顺序，以指定章节顺序
###################################################################

# generate level 2.list as a level 2 directory, format path: title
# the inner cycle extracts the document title by grouping the level 1
# write level2.list after each group is sorted by title
cat /dev/null > level2.list # level2.list. because i'm working over and over again
for i in __CODESPAN_0;do
cat /dev/null >level15.list
for j in __CODESPAN_0;do
col2=`cat  $j | sed -n '/.Sh NAME/,/.Sh/p' | egrep '^.Nd [^ ]+' | sed -e 's/^.Nd //' -e 's/\"//g'` # Ripping document title
epho $j: $col2 >level15.list
don't do that
cat level15.list sort-t:-r-k2 > level2.list
don't do that
# generate level 2.list to reorder rows in level 2.list to specify the order of subsections in the chapter
### # # # # # # # # # # #


# toc.mdoc for generating directories
#bookmark.info label for generating pdf
# index.list logs page numbers for every key word
# mktoc has to run twice, first obtains the number of pages in the directory and second uses the number of pages in the directory as an offset to calculate the full page number
mktoc(){
cat /dev/null > toc.mdoc
cat /dev/null > bookmark.info
cat /dev/null > index.list
n=$1 # start page number
xsflag=1
chapterid = 0
_Other Organiser
chapterid = $(capterid + 1)
sectionid = 0
# Total by Chapter
echo "[[ / /Title ($lv1) / Page $n /Count $titlecount /View [/XYZ Null 0]/OUT pdfmark">bookmark.info#pdf
first = 1 # directory, insert the name of the chapter before the subsections of each chapter, first to mark section 1
for lv2 in __CODESPAN_0;do
title=`cat  $lv2 | sed -n '/.Sh NAME/,/.Sh/p' | egrep '^.Nd [^ ]+' | sed -e 's/^.Nd //' -e 's/\"//g'`
nextp=__CODESPAN_0_# Calculates the number of small sections
if [$first-eq 1];then # insert title before section 1 of each chapter
if [$xsflag-eq 1];then # Chapter I, Section 1, is the first section of the entire directory using XS tags
 >.XS $n > toc.mdoc
xsflag = 0
i'm sorry, else
".XA $n" > toc.mdoc
f
echo "$chapterid. ${lv)> toc.mdoc# directory does not support multi-level directories, but only by tag
first=0
f
sectionid = $((sectionid + 1))
echo ".XA $n" > toc.mdoc # Writes the number of the section page
echo ' ' '$sectionid. $title '> toc.mdoc# writes subheadings
echo "[[ /Title ($title) / Page $n /View [/Fit] /OUT pdfmark" > bookmark.info#pdf
# there are several keywords in the section, key words and page numbers written to index.list
for key in_CODESPAN_0;do
"$key:$n" >index.list
don't do that
# Compute new page numbers
don't do that
don't do that
echo ".XE" > toc.mdoc# directory end mark
echo ".PX" > toc.mdoc
> toc.ps# directory to ps format
♪ I'm sorry ♪

### # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #  # # # # # # # # # # # # # # # # # # # # # # # # # # # #  # # # # # # # # # # # #

# Each document is converted into a ps format and collled into a document with the Dd(document date) tag replaced with __PAGENO__ to replace it with a page number later
for lv2 in __CODESPAN_0;do
cat $lv2 sed-e 's/^.Dd.*/.Dd._PAGENO__/'-e '/.OS.*/d' mandoc-Tps > libc.ps
don't do that

### # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #  # # # # # # # # # # # # # # # # # # # # # # # # # # # #  # # # # # # # # # # # #
# Process page numbers
mktoc 1 # first page number of the text is 1
tocpages = __CODESPAN_0 # Calculating Table of Contents Pages
== sync, corrected by elderman ==
mktoc $newstart # first page of text close to directory page number
tocpages=`expr $tocpages + 0`
cat libc.ps wk-v p=$tocpages '
if ($0 ~ / (PAGENO\)/ {
t = sprintf("(%s)", +p);
sub(/(_PAGENO\)/, t);
♪ I'm sorry ♪
$ 0;
}' > libc.ps.tmp # generates page numbers for each page
cat libc.ps.tmp > > toc.ps # spell toc.ps file, at this time toc.ps is complete


## # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #   # # #   #   # # #   #  #  #  # #  #  # # # # # #

# Generate an index in alphabetical order to key words and merge it with the chapter label
sort-f index.list > index.list.tmp # ignore case for keyword sorting
i don't know
cut-c 1 index.list tr[:upper:] [:lower:] | uniq > index.level1 # extract the initials for index by letter
indexcount=__CODESPAN_0 # Calculates a total of subsections (groups)
echo "[[ / /Title(INDEX) /Count $indexcount /View [/XYZ Null Null 0]/OUT pdfmark" >bookmark.info# index to write to INDEX chapter label
".DS C" > prindex.mdoc
"INDEX" >printindex.mdoc
echo ".DE" > prindex.mdoc
>prindindex.mdoc
echo "2C" > prindex.mdoc
".LB 0 0 0" >prindindex.mdoc
_ for a in __CODESPAN_0;do # Group in initial to index
# Calculating the number of keywords per initial
echo "[[ / /Title ($a) /Count$account /View [/XYZ null 0]/OUT pdfmark" >bookmark.info # Group names
for i in __CODESPAN_0;do # Write tags for each keyword
== sync, corrected by elderman ==
page=__CODESPAN_0_
echo "[ / /Title ($key) / Page $page /View [/XYZ null 0]/OUT pdfmark">bookmark.info
".LI" >printindex.mdoc
printf '%-40s %4d\n' "$key" $page >>printindex.mdoc
don't do that
don't do that
".LE" > prindex.mdoc
## # # # # # # # # # # # # # # # # # # # # # # #
>toc.ps
ps2pdf toc.ps # convert to pdf without bookmarks
# generate labeled libc.pdf with bookmark.info and unlabeled toc.pdf
gs-sDEVICE=pdfwrite-q-dBATCH-dNOPAUE-soutputfile=libc.pdf bookmark.info-f toc.pdf

*content.listbookmark.info libc.ps libc.ps.tmp
````

# Available text

RUNS A SCRIPT TO FIND PDF DOCUMENTS IN THE SAME PATH FOLDER. AVAILABLE DOCUMENTS SEE:

[https://github.com/FreeBSD-Ask/BSDlibc] (https://github.com/FreeBSD-Ask/BSDlibc)

# Section 15.2 Packet Filter (PF)

PF (Packet Filter, package filter) is a firewall that has been transplanted by OpenBSD and provides a large number of functions, including ALTQ (Alternate Queuing, cross-Queuing)。

# ENABLE PF

```sh
# kldload pf # ① 加载内核模块
# 复制示例文件作为默认配置规则集文件，否则 pf 无法启动 ②
# cp /usr/share/examples/pf/pf.conf /etc/
# service pf enable # 设置 pf 开机启动
# service pf start  # 启动 pf
```

-1 IF NOT, THEN HINT __CODESPAN_0_. OR YOU CAN RESTART IT AGAIN。

- 2 otherwise hint:

```sh
/etc/rc.d/pf: WARNING: /etc/pf.conf is not readable.
```

# CODESPAN_0__

pf The management command is __CODESPAN_0, with the following examples of common operations:

```sh
# 启动 pf，相当于 service pf start
# pfctl -e

# that's the prohibition rule. almost equivalent to service pf stop
# pfctl-d

# Load rules in the rules set
# pfctl-f/etc/pf.conf

# Parsing the rules, but unloaded. -f Parameters can also be associated with other parameters, e. g. -N means only the NAT rules, -R means only the filter rules, -A only the queue rules, -O only the options rules
# pfctl-nf/etc/pf.conf

# View all pf objects. If you want to look for specific object information, all can be replaced with nat, Queue, rules, Anchors, States, Sources, Info, Running, Labels, Timeouts, Memory, Tables, osfp, Interfaces
# pfctl-s all

# clean up pf all rules
# Pfctl-F all
````

If you want to see specific rules, all can be replaced with nat, queue, rules, statuses, Sources, info, Tables, osfp。

However, the above operation does not regulate the rules and therefore there is a need to modify the Rules Collection document, as is often the case for example:

```
# 整理所有输入的数据
scrub in all

# Deny all visits
all # defaultly expressly forbids all access. block is an action, all from any source to any target in a short print, indicating the source address to the target address。

# Unlock access to the loop interface, the loop interface is not external
pass quick on lo0 all # quick keyword means if the rules match, stop, no more follow-up rules

# ADD RULES FOR TCP ACCESS TO 80 PORTS TO ALLOW ANY DEVICE TO ACCESS 80 PORTS WITH TCP PROTOCOL
pass in quick proto tcp from any to 192,168.184 port 80 #proto tcp is access protocol, port 80 is target port

# Allow echo messages to any device visited
pass out quickproto tcp from 192,168.184 port 80 to any # allow the machine to send out the 80 port response

# Add 80 port to 8080 port flow rules
# transmit traffic to intranet address 192,168.1.166 port 8080

# allow this machine to interact with external equipment
passquick into icmp all icmp- type 8 code 0 #icmp- type 8 is a query request, code 0 means return code 0

# Allow traceroute commands to be executed by ICMP protocol
pass out quick within icmp from 192,168.184 to any icmp- type 11 code 0 #icmp- type 11 for time outtime

# Allow trackroute to execute with UDP protocols, port number starting with 33434
pass out quickproto udp from 192,168.184 to any port 33434 > < 34500 # Default UDP protocol, port number from 33434 plus 1 for every forward port number
````

THE LIST OF RULES THAT MAY BE USED `/etc/pf.conf` IS AS FOLLOWS:

```
# 数据包标准化
scrub in all

# Forward rules
# pay attention to the order of rules, which according to pf.conf rules should be before the filter rules. please refer to help

# Filter rules
block all traffic on lo0 all

# Sets any device to access the 22, 80, 443, 4200, 10,000 ports of the server
pass in quick proto tcp from any to 192,168.184 port {22, 80, 443, 4200, 10000}

# Set the server to access the 22, 80, 443, 4200, 10,000 ports of external equipment
pass out quick proto tcp from 192,168.184 port {22, 80, 443, 4200, 10000} to any

# Sets the server to access the 80, 443 ports of any network device and maintains their status
pass out quick proto tcp from 192,168.1.184 to any port {80, 443} keep state

# SET SERVER ACCESS TO DNS SERVER (UDP PORT 53)
pass out quick prod from any to any port 53 keep state

# SET SERVER ACCESS TO DHCP SERVER (UDP PORT 67)
pass out quick prod from any to any port 67 keep state

# ALLOW SERVERS TO SEND ICMP REQUESTS
i'm sorry

# ALLOW SERVERS TO SEND ICMP OVERTIME MESSAGES (TTL OVER)
pass out quick into icmp from 192,168.184 to any icmp-type 11 code 0

# ALLOW SERVER ACCESS TO UDP RANGE PORT 33434 TO 34500
pass out quick proto udp from 192,168.1.184 to any port 33434 > < 34500
````

Save file, then execute the command at the terminal:

```sh
# 加载规则集文件中的规则 就可以看到效果了。
# pfctl -Fa -f /etc/pf.conf 
```


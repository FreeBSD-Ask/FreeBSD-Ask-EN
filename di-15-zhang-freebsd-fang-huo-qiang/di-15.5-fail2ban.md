# Section 15.5 Fail2Ban (based on IPFT, PF, IPF)

According to the developer [Office Note] (https://github.com/fail2ban/fail2ban), Fail2Ban may block multiple authentication error hosts, [BY UPDATING THE SYSTEM FIREWALL RULES TO REJECT NEW CONNECTIONS FROM IP ADRESSES] (https://github.com/fail2ban/fail2ban/wiki/How-fail2ban-works). Fail2Ban is written almost entirely by Python (Python 96.0%). This is an adaptation of the three firewalls that are common in FreeBSD - IPFT, PF, IPF - you don't need all the firewalls, you just choose the firewall you like。

# Install Fail2Ban

- install with pkg:

```sh
# pkg install security/py-fail2ban
```

- Or install with Ports:

```sh
# cd /usr/ports/security/py-fail2ban/ 
# make install clean
```

- Configure services:

```sh
# service fail2ban enable
```

# see fail2ban after installation

```sh
# pkg info -D security/py-fail2ban
py311-fail2ban-1.1.0_1:
On install:
Please do not edit the fail2ban.conf, jail.conf, or any other
files in the distributen as they will be overwritten upon each
upgrade of the port. Instead, create new files named *.local e.g.
fail2ban.local or jail.local.
# 请不要直接修改 fail2ban.conf、jail.conf 或其他官方提供的配置文件，
# 因为它们会在每次升级该软件包时被覆盖。
# 应该创建 *.local 文件，如 fail2ban.local 或 jail.local，来自定义配置。

For more information, see the official manual:
http://www.fail2ban.org/wiki/index.php/MANUAL_0_8#Configuration
# More information can be found in the official manual。

If you have control files or actions and you are upgrading from
0.9. please check them.
# if you define custom filters or operations and upgrade them from 0.9 x, check their compatibility。

Users of pf: please read the notes in action.d/pf.conf and the
discussion at https://github.com/fail2ban/fail2ban/pull/1925
# users using pf firewalls should read the comments in action.d/pf.conf
# And the relevant notes in the GitHub discussion link above。

Please don't take that fail2ban will put seriously lights' around the
you should've done it yourself.
# note: fail2ban automatically packs port numbers in big brackets in action orders
So you don't have to add。
````

# Fail2Ban Configuration Explanation

Note**
>
> This __CODESPAN_0_, not the jail in the BSD. This jail is literally the word "prohibited."。

THE CONFIGURATION EXAMPLE IS __CODESPAN_0_ (DO NOT EDIT DIRECTLY, SEE ABOVE). LISTS ONLY WHAT IS REQUIRED:

```ini
# DEFAULT 是全局定义的配置，之后每个 jail 都可以单独覆盖这些设置。

[DEFAULT]

# "ignoreip" can be an IP address, a CIDR subnet mask or a list of DNS hosts. Fail2ban
# Do not block the host that matches the address in this list. You can define multiple addresses using spaces (and/or comma separator)。
# "ignoreip" is the white list
# ignoreip = 127.0.0.1/8 #1

# "maxretry" default number of retries
macretry = 5

# if the host fails every time in the past "findtime" seconds, the host will be blocked。
# Defines the frequency of the ban。
findtime = 10m

# "bantime" is the time when the host is blocked, in integer or time abbreviation for seconds (m-minute, h-hour, d-day, w-week, mo-month, y-year)。
# That's how long to try again。
bantime = 10m

[sshd]
♪ i can ♪
# I don't know
# see jail.conf(5)

# "filter" defines the filter used by jail. one
# by default, jail 's name matches its filter name。
# I don't know
filter = %(_name_)s [mode=%(mode)s]
# For example:
# filter = sshd
# I don't know
# operation shortcuts. to define the action parameter。

# Fail2Ban also needs firewalls to carry out the ban。
# default blocking operations (e. g. iptables, iptables-new, iptables-multireport, shorewall, etc.). two
# it defines the action_* variable, which can be covered in the overall or specific part of the jail. local file。
# banaction = iptables-multiport
# banging_allports #
````

-1 Available filter name:

```sh
root@ykla:/home/ykla # ls /usr/local/etc/fail2ban/filter.d/
……省略一部分输出……
bsd-sendmail.conf		mssql-auth.conf			slapd.conf
bsd-sshd.conf			murmur.conf			softethervpn.conf
bsdftp.conf			mysqld-auth.conf		sogo-auth.conf
courier-auth.conf		nginx-botsearch.conf		sshd.conf
```

It needs to be noted that the file starting with __CODESPAN_0 (e. g. __CODESPAN_1) is a patch from FreeBSD Port maintainer. But it is not used here. Should use __CODESPAN_2_ directly。

- 2 View Firewalls supported by Fail2Ban:

```sh
# ls /usr/local/etc/fail2ban/action.d/
bsd-ipfw.conf				ipfw.conf				ipfilter.conf
……省略其他防火墙……
```


# Fail2Ban Ban Configuration

CREATES AND EDITS A FILE __CODESPAN_0, WHICH READS:

```ini
[DEFAULT]
ignoreip=192.168.0.0/24
maxretry = 3
findtime = 10m
bantime = 8h

[sshd]
= true
philter=sshd
action=bsd-ipfw
````

Cannot initialise Evolution's mail component

- WHITE LIST, NOT BLOCKED IP SECTION. `192.168.0.0/24`, I.E. __CODESPAN_1_TO `192.168.0.254`_
- CODESPAN_0 IS AN EXAMPLE OF A FIREWALL. YOU CAN CHOOSE. SEE BELOW。

>** Warning**
>
> IF YOU USE IPFW, YOU MUST USE __CODESPAN_0_ INSTEAD OF __CODESPAN_1_. BECAUSE IT'S NOT GOING TO WORK

# Configure firewalls

fail2ban:

```sh
# service fail2ban start
```

IPFW

Fail2Ban configuration as above。

# # Configure self-starter services #

```sh
# sysrc firewall_enable="YES"
```

>** Warning**
>
>** Don't** follow __CODESPAN_0_ any more. Otherwise you won't be connected to ssh。

### MODIFY IPFW DEFAULT

- IPFW RULE IS "DEFAULT." WE CHANGE TO "DEFAULT PERMISSION."

```sh
# echo net.inet.ip.fw.default_to_accept="1" >> /boot/loader.conf
# reboot # 重启生效
```

- VIEW IPFW RULES

```sh
# ipfw list
……省略一部分……
65535 allow ip from any to any
```

References

- [man ipfw (8)] (https://man.freebsd.org/cgi/man.cgi?ipfw (8)), man page
- [#fail2ban] (https://dapeng.li/learning/fail2ban/d4.html) this section structure is based on

# PF #

### fail2ban profile

REPLACE CODESPAN_1 FROM CODESPAN_0 ABOVE WITH CODESPAN_2_, THE REST OF WHICH DOES NOT REQUIRE CHANGE。

### # MODIFY PF PROFILE

- COPY AN EXAMPLE FILE, OTHERWISE THE PF CANNOT START。

```sh
# cp /usr/share/examples/pf/pf.conf /etc/ 
```

- EDIT __CODESPAN_0_, WRITE:

```ini
table <f2b> persist
anchor "f2b/*"
block drop in log quick on em0 from <f2b> to any
```

- CODESPAN_0: __ CODESPAN_1 _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ , _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _。

Service

```sh
# kldload pf # 加载内核模块，后边就不需要了
# service pf enable # 开机自启
# service pf start # 启动 PF 防火墙！
```

References

- [i'm sorry, but i'm sorry, but i'm sorry
- [Fail2ban on FreeBSD drops] (https://github.com/fail2ban/fail2ban/issues/1915)


# # IPFILTER (IPF)

### fail2ban profile

REPLACE CODESPAN_1 FROM CODESPAN_0 ABOVE WITH CODESPAN_2_, THE REST OF WHICH DOES NOT REQUIRE CHANGE。

Service

- copy the example file as the default configuration set file, otherwise there will be no rule after ipfilter starts. an example of a rule with a file does not affect the use

```sh
# cp /usr/share/examples/ipfilter/ipf.conf.sample /etc/ipf.rules
```

- start ipfilter

```sh
# service ipfilter enable
# service ipfilter start
```

Yeah. {\i1 \cH30D3F4}Finally, we can use it by default

# Test Effects

- TEST ACTIVE ZIP IP TO SEE EFFECTS

```sh
# fail2ban-client set sshd banip 192.168.179.1
```

- TTY OUTPUT

```sh
Mar 25 15:27:B8 gkla sshd[970]: error : maximum authentication attempts exceeded for ykla from 192.168.179.1 port 8652 ssh2 [ preauth ]
```

the linked ssh service will also be forcibly disconnected。

# See state #

```sh
# fail2ban-client status sshd
Status for the jail: sshd
|- Filter
|  |- Currently failed:	1
|  |- Total failed:	4
|  `- File list:	/var/log/auth.log
`- Actions
   |- Currently banned:	1
   |- Total banned:	1
   `- Banned IP list:	192.168.179.1
```

UNTIE IP

```sh
# fail2ban-client set sshd unbanip 192.168.179.1
1
# fail2ban-client status sshd
Status for the jail: sshd
|- Filter
|  |- Currently failed:	1
|  |- Total failed:	4
|  `- File list:	/var/log/auth.log
`- Actions
   |- Currently banned:	0
   |- Total banned:	1
   `- Banned IP list:
```

# Fragmentation and unfinished business

- THE LOG __CODESPAN_0 IS __CODESPAN_1_1_

# Section 15.5 Fail2Ban (based on IPFT, PF, IPF)

According to the developer [official statement] (https://github.com/fail2ban/fail2ban), Fail2Ban may block multiple authentication errors, [i.e. new connections from those IP addresses are rejected by updating the system firewall rules] (https://github.com/fail2ban/fail2ban/wiki/How-fail2ban-works). Fail2Ban is written almost entirely by Python (Python 96.0%). This is an adaptation of the three firewalls that are common in FreeBSD - IPFT, PF, IPF - you don't need all the firewalls, you just choose the firewall you like.

# Install Fail2Ban

- Install with pkg:

```sh '
# pkg install security/py-fail2ban
````

- Or install with Ports:

```sh '
#cd/usr/ports/security/py-fail2ban/
# Make install clean
````

- Configure services:

```sh '
♪ Service fair2ban capable
````

# See fail2ban after installation

```sh '
# pkginfo-D security/py-fail2ban
py311-fail2ban-1.1.0_1:
On install:
Please do not delete the fail2ban.
If you're in the dark, as they will be overwrite upon each other,
Instead, new files named *.local e.g.
It's not like I'm gonna be here.
# Please do not directly modify the profile of fail2ban.conf, jail.conf or other official documents.
# Because they'll be covered every time the package is upgraded.
# Should create *.local files, such as fail2ban.local or jail.local, from definition configuration.

For more information, see the official manual:
http://www.fail2ban.org/wiki/index.php/MANUAL_0_8#Configuration
# More information can be found in the official manual.

If you have control files or actions and you are upgrading from
0.9. Please check them.
# If you define custom filters or operations and upgrade them from 0.9 x, check their compatibility.

Users of pf: please read the notes in action.d/pf.conf and the
Discussion at https://github.com/fail2ban/fail2ban/pull/1925
# Users using pf firewalls should read the comments in action.d/pf.conf.
# And the relevant notes in the GitHub discussion link above.

Please don't take that fail2ban will put seriously lights' around the
You should've done it yourself.
# Note: fail2ban automatically packs port numbers in big brackets in action orders,
So you don't have to add.
````

# Fail2Ban Configuration Explanation

Note**
>
> This `jail ' is not the jail (a container) in the BSD. This jail is literally the word "prohibited."

The configuration example is in `/usr/local/etc/fail2ban/jail.conf ' (do not edit directly, see above). Lists only what is required:

```ini '
# DEFAULT is a global defined configuration, after which each jail can separately overwhelm these settings.

[DEFAULT]

# "ignoreip" can be an IP address, a CIDR subnet mask or a list of DNS hosts. Fail2ban
# Do not block the host that matches the address in this list. You can define multiple addresses using spaces (and/or comma separator).
# "ignoreip" is the white list
# ignoreip = 127.0.0.1/8 #1

# "maxretry" default number of retries
Macretry = 5

# If the host fails every time in the past "findtime" seconds, the host will be blocked.
# Defines the frequency of the ban.
Findtime = 10m

# "bantime" is the time when the host is blocked, in integer or time abbreviation for seconds (m-minute, h-hour, d-day, w-week, mo-month, y-year).
# That's how long to try again.
Bantime = 10m

[sshd]
♪ I can ♪
# I don't know
# See jail.conf(5)

# "filter" defines the filter used by jail. One.
# By default, Jail 's name matches its filter name.
# I don't know
Filter = %(_name_)s [mode=%(mode)s]
# For example:
# Filter = sshd
# I don't know
# Operation shortcuts. To define the action parameter.

# Fail2Ban also needs firewalls to carry out the ban.
# Default blocking operations (e. g. iptables, iptables-new, iptables-multireport, shorewall, etc.). Two.
# It defines the action_* variable, which can be covered in the overall or specific part of the jail. local file.
# banaction = iptables-multiport
# Banging_allports #
````

-1 Available filter name:

```sh '
Root@ykla:/home/ykla#ls/usr/local/etc/fail2ban/filter.d/
...leave some output...
I don't know.
I'm sorry, bsd-sshd.conf murmur.conf softethervpn.conf
I don't know, bsdftp.conf mysqld-auth.conf sogo-auth.conf
It's a good idea.
````

Note that documents starting with `bsd-` (e.g. `bsd-sshd.conf ' ) are patches played by FreeBSD Port maintainers. But it is not used here. `sshd.conf ' should be used directly.

- 2 View Firewalls supported by Fail2Ban:

```sh '
#ls /usr/local/etc/fail2ban/action.d/
I don't know what you're talking about.
...and omit other firewalls...
````


# Fail2Ban Ban Configuration

Create and edit the document `/usr/local/etc/fail2ban/jail.d/sshd.conf ' , which reads as follows:

```ini '
[DEFAULT]
ignoreip = 192.168.0.0/24
Macretry = 3
Findtime = 10m
Bantime = 8h

[sshd]
= true
Philter=sshd
action=bsd-ipfw
````

Cannot initialise Evolution's mail component.

- White list, not blocked IP section. `192.168.0.0/24 ' i.e. `192.168.0.0 ' to `192.168.0.254 '
- `bsd-ipfw ' is an example firewall. You can choose. See below.

>** Warning**
>
>If you use IPFW, you must use `bsd-ipfw ' instead of `ipfw ' . Because `ipfw ' will not work!

# Configure firewalls

Fail2ban:

```sh '
# Service fail2ban start
````

IPFW

Fail2Ban configuration as above.

# # Configure self-starter services #

```sh '
# Yes #
````

>** Warning**
>
>** Don't** move on `start ' anymore. Otherwise you won't be connected to ssh.

### Modify IPFW Default

- IPFW rule is "Default." We change to "Default permission."

```sh '
#echo net.inet.ip.fw.default_to_accept="1">/boot/loader.conf
♪ Reboot ♪
````

- View IPFW rules

```sh '
# ipfw list
. . . . . . . . . . .
65535 open ip from any to any
````

References

- [man ipfw (8)] (https://man.freebsd.org/cgi/man.cgi?ipfw (8), man page
- [fail2ban] (https://dapeng.li/Learning/fail2ban/d4.html) This section is structured on this basis

# PF #

### fail2ban profile

Replace `action=bsd-ipfw ' in the above profile `/usr/local/etc/fail2ban/jail.d/sshd.conf ' with `action=pf[port={22 23}, name=ssh] ' , otherwise not required.

### # Modify PF Profile

- Copy an example file, otherwise the PF cannot start.

```sh '
#cp/usr/share/examples/pf/pf.conf/etc/
````

- Edit `/etc/pf.conf ' to read:

```ini '
<f2b>persist
"f2b/*"
Block drop in logq on em0 from <f2b> to any
````

- `em0 ' : The `em0 ' above is my card name, and you can change it to your own, using the command `ifconfig ' .

Service

```sh '
# kldload pf # load the kernel module, the back is not needed
♪ service pf available ♪
♪ service pf start ♪
````

References

- [fail2ban does not feed pf table] (https://forums.freebsd.org/threads/fail2ban-does-not-feed-pf-table67798/)
- [Fail2ban on FreeBSD drops complete pf firstall rules] (https://github.com/fail2ban/fail2ban/issues/1915)


# # IPFILTER (IPF)

### fail2ban profile

Replace `action =bsd-ipfw ' in `/usr/local/etc/fail2ban/jail.d/sshd.conf ' with `action =ipfilter ' , the rest not required.

Service

- Copy the example file as the default configuration set file, otherwise there will be no rule after ipfilter starts. An example of a rule with a file does not affect the use

```sh '
#cp/usr/share/examples/ipfilter/ipf.conf.sample/etc/ipf.rules
````

- Start ipfilter.

```sh '
# With service #
# With service #
````

Yeah. {\i1 \cH30D3F4}Finally, we can use it by default

# Test Effects

- Test active zip IP to see effects

```sh '
# fail2ban-client set sshd banip 192.168.179.1
````

- TTY Output

```sh '
Mar 25:27: B8 gkla sshd [970]: Error: maximmagment attests exported for ykla from 192.168.179.1 port 8652 ssh2 [real]
````

The linked ssh service will also be forcibly disconnected.

# See state #

```sh '
# fail2ban-client status sshd
Status for the jail: sshd
File
Currently failed: 1
Total failed: 4
`-File list: /var/log/auth.log
`-Actions
Currently banged: 1
Total Banned: 1
`- Banned IP list: 192.168.179.1
````

Untie IP

```sh '
# fail2ban-client set sshd unbanip 192.168.179.1
One.
# fail2ban-client status sshd
Status for the jail: sshd
File
Currently failed: 1
Total failed: 4
`-File list: /var/log/auth.log
`-Actions
Currently Banned: 0
Total Banned: 1
`-Banned IP list:
````

# Fragmentation and unfinished business

- `fail2ban ' log at `/var/log/fail2ban.log '

# Section 15.4 ipfirewall (IPFW)

IPFIREWALL (IPFW, IP firewall) is a firewall application initiated by FreeBSD and developed and maintained by FreeBSD.

ipfw exists as a loadable module in the inner core of the basic system.

>** Warning**
>
>IPFW Default will have a rule, rule number `655535 ' , which cannot be deleted: this rule will cut off all traffic. Therefore, do not activate IPFW before the firewall is configured, or face trouble being blocked outside the firewall.

# Service

- Automatically activate the corresponding kernel module of the firewall:

```sh '
#sysrc first_enable=YES #https://github.com/freebsd/freebsd-src/blob/main/libexec/rc/rc.d/routing#L387
````

Or...

````
♪ service ipfw effective ♪
````


- Start ipfw:

```sh '
# Service ipfw start

I'm sorry.
Fairwall logging within.
If config: interface ipfw0 already exists
Firewall logging pseudo-interface (ipfw0) created.
````

- View ipfw status:

```sh '
# For service #

ipfw is acceptable
````

# Other RC configuration

````
# Sysrc first_type # Failure to do so would call the default rule 65535-deny ip from any to any, rejecting all IPs. You'll have to go back to the physics machine. Basically equals net.inet.ip.fw.default_to_accept=1
# Sysrc firstall_script="/usr/local/etc/ipfw.rules" # specify the path to the ipfw rule and edit the rule here
# Sysrc first_loging #
# Sysrc first_logif #
````

Follow the configuration rules above:

```sh '
# ipfw list
001 open ip from any to any via lo0
00200 deny ip from any to 127.0.0/8
00300 deny ip from 127.0.0/8 to any
00400 Deny ip from any to #1
00500 Denny ip from #1 to any
00600 open ipv6-icmp from -- to ff02:16:
00700 all open ipv6-icmp from fe80:10 to fe80:10
00800 all open ipv6-icmp from fe80:10 to ff02:16
001 open ipv6-icmp from any to any icmp6types1
01000 all open ipv6-icmp from any to any icmp6types 2,135,136
# Look out here #
65535 deny ip from any to any
````

# Edit `/usr/local/etc/ipfw.rules ' files


Specify firewall rules:

```sh '
cmd= "ipfw-q add" # Defines a variable cmd to simplify the command for subsequent additions.
The ipfw-q-fflush #-q option indicates a silent mode and avoids output of redundant information.

# Loopback
$cmd 10 allow all from any to any via lo0 # allows all traffic through loop interface lo0.
$cmd 20
$cmd 30
$cmd 40 deny tcp from any to any frag # rejects all subsession TCP data packets and helps prevent certain types of attacks.

# Stateful
$cmd 50 check-state # Checks the current status of the session and allows established sessions to continue communication.
$cmd 60 allow tcp from any to any installed # allows all established TCP connections to pass.
$cmd 70 allow all from any to any out keep-state# allows all outward traffic and creates a state record of it so that the response flow can be automatically passed.
$cmd 80 allow icmp from any to any # allows all ICMP data packages to support network diagnostic and error reporting functions.

# Open port for ssh
$cmd 110 allow tcp from any to any 22 out
$cmd 120 allow tcp from any to any 22 in

# open port for samba # allows port traffic (137-139 and 445) associated with Samba file sharing services to ensure that Samba services are functioning.
$130 allow tcp from any to any 139 out
$140 allow tcp from any to any 139 in
$cmd 150 allow tcp from any to any 445 out
$160 allow tcp from any to any 445 in
170 centimeters from any to any 137 out
180 bucks from any to any 137 in
$190 allow pop from any to any 138 out
200 bucks from any to any 138 in


#deny and log everything # refuses all unspecified traffic and records it in logs to facilitate audit and failure clearance.
500 centimetre log all from any to any
````

Each rule is structured essentially as follows:

```sh '
#ipfw add [rule number] 1 [action] [agreement] from [source address] to [target address] [other conditions]
````

-1 In order of priority, the smaller the number, the higher the number, the higher the priority, the priority to be given to the same, large rules.

`$cmd 500 deny log all from any to any' > `ipfw add 500 deny log all from any to any '

Note**
>
>ipfw is a one-time order, which will take effect immediately upon execution, but will not perpetuate the rule. You must write to the specified rule file.


- `655535 refusal ip from any to any '

```sh '
#echo net.inet.ip.fw.default_to_accept="1">/boot/loader.conf
````

- View ipfw rules

```sh '
# ipfw list
001 open ip from any to any via lo0
00200 deny ip from any to 127.0.0/8
00300 deny ip from 127.0.0/8 to any
00400 Deny ip from any to #1
00500 Denny ip from #1 to any
00600 open ipv6-icmp from -- to ff02:16:
00700 all open ipv6-icmp from fe80:10 to fe80:10
00800 all open ipv6-icmp from fe80:10 to ff02:16
001 open ipv6-icmp from any to any icmp6types1
01000 all open ipv6-icmp from any to any icmp6types 2,135,136
65535 open ip from any to any
````





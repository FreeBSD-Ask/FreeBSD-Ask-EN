# Section 15.4 ipfirewall (IPFW)

IPFIREWALL (IPFW, IP firewall) is a firewall application initiated by FreeBSD and developed and maintained by FreeBSD。

ipfw exists as a loadable module in the inner core of the basic system。

>** Warning**
>
>IPFW DEFAULT WILL HAVE A RULE, RULE NUMBER __CODESPAN_0, WHICH CANNOT BE DELETED: THIS RULE WILL CUT OFF ALL TRAFFIC. THEREFORE, DO NOT ACTIVATE IPFW BEFORE THE FIREWALL IS CONFIGURED, OR FACE TROUBLE BEING BLOCKED OUTSIDE THE FIREWALL。

# Service

- Automatically activate the corresponding kernel module of the firewall:

```sh
# sysrc firewall_enable="YES"  # 参见 https://github.com/freebsd/freebsd-src/blob/main/libexec/rc/rc.d/routing#L387
```

Or..

```
# service ipfw enable # 须重启后生效
```


- start ipfw:

```sh
# service ipfw start

I'm sorry.
Fairwall logging within.
if config: interface ipfw0 already exists
Firewall logging pseudo-interface (ipfw0) created.
````

- view ipfw status:

```sh
# service ipfw status

ipfw is acceptable
````

# OTHER RC CONFIGURATION

```
# sysrc firewall_type="open"  # 允许任何访问。如果不这么做，会调用默认规则 65535——deny ip from any to any，拒绝所有 IP。你就只能去物理机上再操作了。基本等同于 net.inet.ip.fw.default_to_accept="1"
# sysrc firewall_script="/usr/local/etc/ipfw.rules"  # 指定 ipfw 规则的路径，在此处编辑规则
# sysrc firewall_logging="YES"  # 这样 ipfw 就可以打印日志
# sysrc firewall_logif="YES"  # 把日志打印到 `ipfw0` 这个设备里
```

Follow the configuration rules above:

```sh
# ipfw list
00100 allow ip from any to any via lo0
00200 deny ip from any to 127.0.0.0/8
00300 deny ip from 127.0.0.0/8 to any
00400 deny ip from any to ::1
00500 deny ip from ::1 to any
00600 allow ipv6-icmp from :: to ff02::/16
00700 allow ipv6-icmp from fe80::/10 to fe80::/10
00800 allow ipv6-icmp from fe80::/10 to ff02::/16
00900 allow ipv6-icmp from any to any icmp6types 1
01000 allow ipv6-icmp from any to any icmp6types 2,135,136
65000 allow ip from any to any # 注意此处
65535 deny ip from any to any
```

# EDIT __CODESPAN_0_FILE


Specify firewall rules:

```sh
cmd="ipfw -q add" # ​定义一个变量 cmd，用于简化后续添加规则的命令。
ipfw -q -f flush # -q 选项表示静默模式，避免输出冗余信息。

# loopback
$cmd 10 allow all from any to any via lo0 # allows all traffic through loop interface lo0。
$cmd 20。
$cmd 30。
$cmd 40 deny tcp from any to any frag # rejects all subsession TCP data packets and helps prevent certain types of attacks。

# stateful
$cmd 50 check-state # checks the current status of the session and allows established sessions to continue communication。
$cmd 60 allow tcp from any to any installed # allows all established TCP connections to pass。
$cmd 70 allow all from any to any out keep-state# allows all outward traffic and creates a state record of it so that the response flow can be automatically passed。
$cmd 80 allow icmp from any to any # allows all ICMP data packages to support network diagnostic and error reporting functions

# open port for ssh
$cmd 110 allow tcp from any to any 22 out
$cmd 120 allow tcp from any to any 22 in。

# open port for samba # allows port traffic (137-139 and 445) associated with Samba file sharing services to ensure that Samba services are functioning。
$130 allow tcp from any to any 139 out
$140 allow tcp from any to any 139 in
$cmd 150 allow tcp from any to any 445 out
$160 allow tcp from any to any 445 in
170 centimeters from any to any 137 out
180 bucks from any to any 137 in
$190 allow pop from any to any 138 out
200 bucks from any to any 138 in


#deny and log everything # refuses all unspecified traffic and records it in logs to facilitate audit and failure clearance。
500 centimetre log all from any to any
````

Each rule is structured essentially as follows:

```sh
# ipfw add [规则编号] ① [动作] [协议] from [源地址] to [目标地址] [其他条件]
```

-1 In order of priority, the smaller the number, the higher the number, the higher the priority, the priority to be given to the same, large rules。

__CODESPAN_0> `ipfw add 500 deny log all from any to any`

Note**
>
>ipfw is a one-time order, which will take effect immediately upon execution, but will not perpetuate the rule. you must write to the specified rule file。


- WE CAN CHANGE THE DEFAULT REJECTION RULE TO A DEFAULT PERMISSION

```sh
# echo net.inet.ip.fw.default_to_accept="1" >> /boot/loader.conf
```

- view ipfw rules

```sh
# ipfw list
00100 allow ip from any to any via lo0
00200 deny ip from any to 127.0.0.0/8
00300 deny ip from 127.0.0.0/8 to any
00400 deny ip from any to ::1
00500 deny ip from ::1 to any
00600 allow ipv6-icmp from :: to ff02::/16
00700 allow ipv6-icmp from fe80::/10 to fe80::/10
00800 allow ipv6-icmp from fe80::/10 to ff02::/16
00900 allow ipv6-icmp from any to any icmp6types 1
01000 allow ipv6-icmp from any to any icmp6types 2,135,136
65535 allow ip from any to any # 注意此处是默认允许了，后面没了
```





# Section 15.3 IPFilter

IPF (IPFilter, IP filter) is an open source software by Darren Reed. For information purposes only, the following have not been tested.

If you want to enable ipf, you can execute the following command:

```sh '
# Copy the example file as the default configuration set file, otherwise there will be no rule after ipfilter starts. An example of a rule with a file does not affect the use
#cp/usr/share/examples/ipfilter/ipf.conf.sample/etc/ipf.rules
````

- Start ipfilter.

```sh '
# With service #
# With service #
````

- Start ipnat.

ipnat is part of IPF and is dedicated to handling the maintenance of NAT rules.

````
# Copy example file as default configuration set file, otherwise ipnat cannot start
#cp /usr/share/examples/ipfilter/ipnat.conf.sample/etc/ipnat.rules
Set ipnat start
♪ Service ipnat enough
# Start ipnat
♪ Service ipnat start
````

Note that after the ipfilter service is restarted, ipnat also needs to be restarted.

I don't...

The ipf management commands are mainly used ipf, ipfstat and ipnat, for example:

````
# Start ipfilter, equivalent to service ipfilter start
ipf-e

# Stop ipfilter, equal to service ipfilter stop
ipf-d

# Load rules in the rules set
ipf-f/etc/ipf.rules

# View all rules
ipfstat

# View rules, i for input rules, o for output rules, h for flow through the rules, n for record number
ipfstat-iohn

# Enter surveillance mode, press Q Quit
ipfstat-t

# Clean up loaded rules
ipf-Fa

# Load the NAT rules in the rule book files
ipnat-f/etc/ipnat.rules

# Summarize and show NAT status
I don't know.

# The list shows the NAT rule, plus h for the flow through the rule
ipnat-lh

# Clear loaded NAT rules
ipnat-CF

# The above operation does not regulate the rules, so there is also a need to modify the Rule Book document, for example:

# Deny all visits
All # ipfilter is the implicitly-prohibited firewall, so all access is prohibited by the following rules:

# Deny all traffic
Block in all #block is action, block is rejection, pass is pass; in for data direction, in for in, out, data direction is required in ipfilter

# All is short from any to any, from source to target address, usually using a web segment (e.g. 192.168.1.0/24) or an IP address (e.g. 192.1681.100), anny is a special word, indicating any address
````

````
# Deny all external traffic
Block out all

# Release all back-ring traffic
Pass in quick on lo0 all #quick keyword means if the rules match, stop, no more follow-up rules.

# Release all back-ring output traffic
# Unlock access to the loop interface, loop out quick on lo0 all

# Allow any device to access its 80 port by TCP protocol
Pass in quickproto tcp from any to 192,168.184 port = 80 #proto tcp is access protocol with commonly used tcp, udp, tcp/dp, icmp, without writing, supporting all protocols; port = 80 is the target port

# Allows this machine to send echo messages out
Pass out quickproto tcp from 192,168.1.184 to any # Allow echo information to any device visited

# Add 80 port to 8080 port flow rules
Rdr em0192.168.184 port 80 - > 192.168.184 port 8080 # forward flow to the 8080 port of the machine, usually used for port mapping

# Allow this machine to pass the ICMP protocol ping external device
Pass out quick Proto icmp from 192,168.1.184 to any icmp- type 8 keep state

# Allow external devices to pass the ICMP protocol ping-in
Pass in quick Proto icmp from any to 192,168.184 icmp- type 8 keep state

# Allow this machine to travel through the ICMP protocol
# ICMP type 0 is an echo

# Allows this machine to trackroute via the UDP protocol, starting with port number 33434, with each forward port number plus 1
Pass out quickproto dup from 192,168.184 to any port 33434 > < 34500 keep state # trackroute default UDP protocol, port number from 33434
````

The common set of rules documents `/etc/ipf.rules ' are as follows:

````
# Deny all traffic
Block in all

# Reject all outbound traffic
Block out all

# Release all traffic back to the ring interface
# Allow communication between this machine and the loop interface

# Release all output traffic back to the ring interface
Pass out quick on lo0 all

# Sets any device to access the 22, 80, 443, 4200, 10,000 ports of the server
Pass in quickproto tcp from any to 192,168.184 port = {22,80,443,423,420010,000} # Allow external devices to access the specified port by TCP protocol

# Allow this machine to send out traffic at the 22, 80, 443, 4200, 10,000 ports
Pass out quickproto tcp from 192,168.184 port = {22,80,443,4200 10,000} to any # allow access to these ports of any external device via TCP protocol

# Allow this machine access to the 80 and 443 ports of external equipment and maintain connectivity
Pass out quickproto tcp from 192,168.1.184 to any port = {80,443} keep state # set the 80, 443 port of any network device to access and connect

# Set up your own access to the DNS server
Pass out quick program dupp from any to any port = 53 keep state

# Set up the DHCP server
Pass out quick program from any to any port = 67 keep state

# Allow this machine to send ICMP ping requests to any external device
Pass out quick Proto icmp from 192,168.1.184 to any icmp- type 8 keep state

# Allow external equipment to send ICMP ping requests
# Allow external devices pinging

# Allow this machine to send an ICMP response to any external device
Pass out quickproto icmp from 192,168.1.184 to any icmp- type 0 # ICMP type 0 is a response, allowing this machine to respond to ping request

# Set this machine to trackroute using the UDP protocol, starting with port number 33434 and gradually increasing
Pass out quickproto dup from 192,168.184 to any port 33434 > < 34500 keep state # trackroute default UDP protocol, port number from 33434

# Unlock the appropriate port before data is forwarded and external devices are allowed access to the 8080 port
Pass in quickproto tcp from any to 192,168.184 port = 8080 # Allow external equipment to access the 8080 port of this machine via TCP protocol
````

The frequently used NAT rule book file `/etc/ipnat.rules ' is as follows:

````
# Set the flow of the 8080 port to the 80 port
# Transmit the 8080 port traffic from the EM0 net to the 80 port of the machine
````

Save file, then execute the command at the terminal:

````
# Clear all loaded rules and load rules in /etc/ipf.rules files
ipf -Fa -f /etc/ipf.rules # -Fa clean all rules, -f to load specified rule files

# Clear all NAT rules loaded and load NAT rules in / etc/ipnat.rules files
ipnat -CF-f /etc/ipnat.rules # -CF Cleanup NAT, -f to load specified NAT rule files
````


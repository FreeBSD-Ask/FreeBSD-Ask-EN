# Section 15.3 IPFilter

IPF (IPFilter, IP filter) is an open source software by Darren Reed. For information purposes only, the following have not been tested。

if you want to enable ipf, you can execute the following command:

```sh
# 复制示例文件作为默认配置规则集文件，否则 ipfilter 启动后会没有规则。示例文件自带的规则不影响使用
# cp /usr/share/examples/ipfilter/ipf.conf.sample /etc/ipf.rules
```

- start ipfilter

```sh
# service ipfilter enable 
# service ipfilter start
```

- start ipnat

ipnat is part of IPF and is dedicated to handling the maintenance of NAT rules。

```
# 复制示例文件作为默认配置规则集文件，否则 ipnat 无法启动
# cp /usr/share/examples/ipfilter/ipnat.conf.sample /etc/ipnat.rules 
# 设置 ipnat 开机启动
# service ipnat enable 
# 启动 ipnat
# service ipnat start
```

note that after the ipfilter service is restarted, ipnat also needs to be restarted。

---|---

the ipf management commands are mainly used ipf, ipfstat and ipnat, for example:

```
# 启动 ipfilter，相当于 service ipfilter start
ipf -E

# stop ipfilter, equal to service ipfilter stop
ipf-d

# Load rules in the rules set
ipf-f/etc/ipf.rules

# View all rules
ipfstat

# view rules, i for input rules, o for output rules, h for flow through the rules, n for record number
ipfstat-iohn

# ENTER SURVEILLANCE MODE, PRESS Q QUIT
ipfstat-t

# Clean up loaded rules
ipf-Fa

# LOAD THE NAT RULES IN THE RULE BOOK FILES
ipnat-f/etc/ipnat.rules

# SUMMARIZE AND SHOW NAT STATUS
i don't know

# The list shows the NAT rule, plus h for the flow through the rule
ipnat-lh

# CLEAR LOADED NAT RULES
ipnat-CF

# The above operation does not regulate the rules, so there is also a need to modify the Rule Book document, for example:

# Deny all visits
all # ipfilter is the implicitly-prohibited firewall, so all access is prohibited by the following rules:

# Deny all traffic
block in all #block is action, block is rejection, pass is pass; in for data direction, in for in, out, data direction is required in ipfilter

# All is short from any to any, from source to target address, usually using a web segment (e.g. 192.168.1.0/24) or an IP address (e.g. 192.1681.100), anny is a special word, indicating any address
````

```
# 拒绝所有外部流量
block out all  # 放开回环接口的访问权限，回环接口不对外部

# Release all back-ring traffic
pass in quick on lo0 all #quick keyword means if the rules match, stop, no more follow-up rules

# Release all back-ring output traffic
# unlock access to the loop interface, loop out quick on lo0 all

# ALLOW ANY DEVICE TO ACCESS ITS 80 PORT BY TCP PROTOCOL
pass in quickproto tcp from any to 192,168.184 port = 80 #proto tcp is access protocol with commonly used tcp, udp, tcp/dp, icmp, without writing, supporting all protocols; port = 80 is the target port

# Allows this machine to send echo messages out
pass out quickproto tcp from 192,168.1.184 to any # allow echo information to any device visited

# Add 80 port to 8080 port flow rules
rdr em0192.168.184 port 80 - > 192.168.184 port 8080 # forward flow to the 8080 port of the machine, usually used for port mapping

# Allow this machine to pass the ICMP protocol ping external device
pass out quick Proto icmp from 192,168.1.184 to any icmp- type 8 keep state

# Allow external devices to pass the ICMP protocol ping-in
pass in quick proto icmp from any to 192,168.184 icmp- type 8 keep state

# Allow this machine to travel through the ICMP protocol
# ICMP type 0 is an echo

# Allows this machine to trackroute via the UDP protocol, starting with port number 33434, with each forward port number plus 1
pass out quickproto dup from 192,168.184 to any port 33434 > < 34500 keep state # trackroute default UDP protocol, port number from 33434
````

COMMON RULEBOOK __CODESPAN_0_:

```
# 拒绝所有进入的流量
block in all  # 拒绝任何来自外部的输入流量

# Reject all outbound traffic
block out all

# Release all traffic back to the ring interface
# allow communication between this machine and the loop interface

# Release all output traffic back to the ring interface
pass out quick on lo0 all

# Sets any device to access the 22, 80, 443, 4200, 10,000 ports of the server
pass in quickproto tcp from any to 192,168.184 port = {22,80,443,423,420010,000} # Allow external devices to access the specified port by TCP protocol

# Allow this machine to send out traffic at the 22, 80, 443, 4200, 10,000 ports
pass out quickproto tcp from 192,168.184 port = {22,80,443,4200 10,000} to any # allow access to these ports of any external device via TCP protocol

# Allow this machine access to the 80 and 443 ports of external equipment and maintain connectivity
pass out quickproto tcp from 192,168.1.184 to any port = {80,443} keep state # set the 80, 443 port of any network device to access and connect

# SET UP YOUR OWN ACCESS TO THE DNS SERVER
pass out quick program dupp from any to any port = 53 keep state

# SET UP THE DHCP SERVER
pass out quick program from any to any port = 67 keep state

# Allow this machine to send ICMP ping requests to any external device
pass out quick Proto icmp from 192,168.1.184 to any icmp- type 8 keep state

# Allow external equipment to send ICMP ping requests
# allow external devices pinging

# ALLOW THIS MACHINE TO SEND AN ICMP RESPONSE TO ANY EXTERNAL DEVICE
pass out quickproto icmp from 192,168.1.184 to any icmp- type 0 # ICMP type 0 is a response, allowing this machine to respond to ping request

# Set this machine to trackroute using the UDP protocol, starting with port number 33434 and gradually increasing
pass out quickproto dup from 192,168.184 to any port 33434 > < 34500 keep state # trackroute default UDP protocol, port number from 33434

# Unlock the appropriate port before data is forwarded and external devices are allowed access to the 8080 port
pass in quick program tcp from any to 192,168.184 port = 8080 # Allow external devices to access the 8080 port of their own machine via TCP protocol
````

THE COMMONLY USED NAT RULE BOOK FILE ____CODESPAN_0_ IS AS FOLLOWS:

```
# 设置本机 8080 端口到 80 端口的流量转发
rdr on em0 proto tcp from any to 192.168.1.184 port 8080 -> 192.168.1.184 port 80 # 将来自本机 em0 网卡的 8080 端口流量转发到本机的 80 端口
```

Save file, then execute the command at the terminal:

```
# 清理已加载的所有规则，并加载 /etc/ipf.rules 文件中的规则
ipf -Fa -f /etc/ipf.rules  # -Fa 清理所有规则，-f 用来加载指定的规则文件

# Clear all NAT rules loaded and load NAT rules in / etc/ipnat.rules files
ipnat -CF-f /etc/ipnat.rules # -CF Cleanup NAT, -f to load specified NAT rule files
````


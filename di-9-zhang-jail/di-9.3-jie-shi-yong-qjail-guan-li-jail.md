# Section 9.3 Use Qjail to manage Jail

Qjail is a deployment tool for the Jail environment, reproduced from ezjail 3.1. Jail management tools include ezjail, Qjail, ocage, etc. ezjail has not had a critical update since it was updated to 3.4.2 in 2015. ezjail's ports update relies on portsnap, which is now obsolete. iocage relies on the ZFS file system, which cannot be used by users using the UFS file system. Qjail has no problems in these areas. ezjail does not support Jail 's vnet function, ocage and Qjail support. ezjail and Qjail write with sh, ocage with python.

Jail, deployed below, is conceptually structured as follows:

![..gitbook/assets/qjailnetstrutt.png]

# Keep jail's ip

In `/etc/rc.conf '

```sh '
Lined_interfaces= "lo1" # cloned lo1 and separated as far as possible from host network configuration. One.
If config_lo1_lias0="inet 192.168.1.0-9" # Host ip 10.2.15, the segment is selected to separate the host segment, at your discretion
````

Note**
>
>1 If it is to generate multiple ports, it should also be described in the same line, separated by spaces, instead of creating a separate line, such as lined_interfaces = "lo1 lo2". Multi-line, one line only.

Run

```sh '
♪ service net first
````

The lo1 will get 10 ip addresses, and the 9 ips below will be used for jail.

# Install Qjail tool

- Install with pkg:

```sh '
# Pkg install qjail
````

- Or install with Ports:

```sh '
#cd/usr/ports/sysutils/qjail/
# Make install clean
````

Enable qjail

```sh '
# Sysrc qjail_enable
````

# Deployment of directory structure used by Qjail

There are two ways to deploy the directory structure used by Qjail before using Qjail:

# Appendix: Automatic download from official mirror station

```sh '
♪ qjail stall
````

Qjail downloads base.txz files from FreeBSD official network, with the following examples:

```sh '
♪ qjail stall
Resolving service delivery: ftp.freebsd.org:80
Requesing http://ftp.freebsd.org/pub/FreeBSD/releases/amd64/amd/64/131-RELEASE/base.txz
Remote size / mtime: 19536380 / 1652346155
I don't know.
````

# # Appendix: Download from a mirror station inside the country

It is also possible to use mirrors manually because of internal network problems, using as an example the China University of Science and Technology mirrors (downloading is a version number, Qjail requires that the version be consistent with the host host, here is FreeBSD amd 64 13.1)

```sh '
#fetch https://mirrors.ustc.edu.cn/freebsd/release/amd/64/13.1-RELEASE/base.txz
♪ qjail install base.txz
````

The `sharedfs ' `template ' `archive ' `flavors ' will automatically generate four directories when the `/usr/jail ' structure is deployed:

- **Sharedfs** contains a read-only operating system executable file, mounted as nulllfs, shared among the Jails to save storage space.
-**template** configuration containing operating systems that will be copied to each jail base file system
- **archive** Save archive files generated by jail ARchive
-**flavors** contains system styles (flavors) and user-created self-defined styles, in fact, self-defined profiles, etc.

# Deployment jail

```sh '
# qjail create-n lo1-4192.168.1.1 jail1
````

- '-n ' specifies the use of lo1 as a network interface
- `4 ' Specify ipv4 address.

After the creation of jail1, the corresponding `jail1 ' directory (`/usr/jails/jail1/`) under the `/usr/jails/` catalogue is generated to save the corresponding document.

You can create your own profile in the `flavors ' directory mentioned above for copying to the new jail when you deploy Jail. For example, if new `/usr/jails/flavors/default/usr/local/etc/pkg/repos/ FreeBSD.conf ' are created, the document will be automatically copied to the corresponding jail, i. e.

```sh '
#qjail create-n lo1-4192.168.1.2 jail2
````

The `/usr/jails/jail2/usr/local/etc/pkg/repos/FreeBSD.conf ' is automatically created after the creation of jail2 and modified the default pkg image of all jail. This file was not generated for jail1 because the corresponding file was not written in the flavors directory when the jail1 was generated.

# Qjail Basic Usage

List Qjail managed jail

```sh '
♪ qjail list
````

- Enable jail

```sh '
♪ qjail start ♪
Start jail1
````

- Stop, Jail.

```sh '
♪ qjail stop ♪
♪ qjail stop jail1 ♪
````

- Restart, jail.

```sh '
♪ qjail restart ♪
♪ qjail restart jail1 ♪
````

- Access to jail console

```sh '
# qjail Console jail1 # enter jail1 console
````

After entering the jail console, this is the root account of the jail (entry to the jail console without the need to enter a password), as jail may open an external service and suggest setting the account password for security considerations

- Backup Jail

```sh '
♪ qjail armed-A ♪
♪ qjail armed jail1 ♪ Back up jail1
````

- Restore Jail from backup

```sh '
qjail restore jail1
````

- Delete jail

```sh '
# qjail delete jail1 # delete jail1
♪ qjail delete-A ♪
````

# Update jail

The section that updates Jail below is not for a single Jail, but for each Jail, as these files are shared with the Nullfs.

# Update basic systems in jail

The documents in the Sharedfs mentioned above.

```sh '
Qjail update-b
````

# Update ports

There are two options: `-p ' (lowercase), `-P ' (highcase), and `-p ' (lowcase) to update jail ' s ports tree using portsnap. `-P ' (highcase) updates jail ' 'ports with the hosts 'ports. If the hosts already exist, it is recommended to use `-P ' (fastcase) to avoid double downloading of ports.

```sh '
Qjail update-P
````

Update system source code

```sh '
qjail update-S
````

Update process

Please install the configuration `gitup ' .

Start updating:

```sh '
# Freebsd-update setch install
# Giveup src
# Giveup ports
♪ qjail stop
Qjail update-b
Qjail update-S
♪ qjail update-P
♪ qjail start
````

# jail settings

Qjail can use the `qjail config ' command to set up another setting for each jail, and the specified jail must be disabled before running `qjail config ' .

There are more options for `qjail config ' commands, a few commonly used ones are listed here, more please refer to the pamphlet

[qjail -- United for development of jail environment] (https://www.freebsd.org/cgi/man.cgi?query=qjail&manpath=FreeBSD+13.1-RELEASE+and+Ports)

# # # '-h ' #

```sh '
♪ qjail config-h jail1
````

Quick start ssh service for jail1 and create a new sheel Group user, username and password are the same as jail, and this user login for the first time requires that the password be changed. You can also configure your own sshd service after you login to the jail console.

## `-m ` `-M'

```sh '
♪ qjail config-m jail1
````

Sets the jail1 to start manually (manual state), `qjail_enable= "YES" `in /etc/rc.conf ` will automatically start each jail on system start-up, set as manual start-up will not automatically start the corresponding jail on system start-up and will have to start with `qjail start jailname ' .

For lowercase `-m ' options, there are uppercase `-M ' options for turning off manual start-up, i.e., clearing the manual state, and you can automatically start jail on system startup. There are many similar options in Qjail, where the lowercase letter option allows a function, and the uppercase letter option closes the corresponding function. If the options for both lower and uppercase appear below, there will be no excessive explanation.

## `-r ' `-R '

```sh '
♪ qjail config-r jail1
````

Sets jail1 as not allowed to start (norun state), which is equivalent to disables the jail.

# # `-y ` `-Y #

```sh '
♪ qjail config-y jail1
````

Enables SysV IPC of this jail to install PostgreSQL in jail. This option needs to be opened. PostgreSQL runs on this feature.

# Network settings

Note**
>
> Some tutorials will teach you the ability of `qjail config-k jailname ' to open raw_sockets to access the extranet, which is actually an error. Raw_sockets is just a ping-like tool that needs to be used, not that Internet access has to open raw_sockets. And open raw_sockets itself in jail is a default security design for the jail environment. So unless you have to use a ping or something in the jail, the jail that is built in whatever way does not recommend the raw_sockets function.

Jail at this time is not able to connect to the network because jail is bound to the lo1 network interface, lo1 does not have direct access to the Extranet, then set the network through pf, where `em0 ' is an Extranet interface

- In `/etc/pf.conf '

```sh '
Nat pass on em0 inet from lo1 to any - > em0 # so jail can access the network and connect from lo1 interface to em0 via nat
rdr pass on em0 inet proto tcp from any to em0 port 22 - > 192.168.1.1 port 22 # to allow access outside the host machine to the specified jail, re-direct the port, re-direct the tcp connection to the 22 tcp interface to the 192.168.1.1 address (i.e. jail1)
````

- Activate the firewall.

```sh '
# Service pf available
# Service pf start
````

At this point, Jail, bound on lo1, can access the host's external network, which can connect Jail's port 22 through host 22.

# Example: Deployment PostgreSQL jail

Assume that Jail ip has been reserved as described above and that the `qjail order is successfully operated.

Here, for example, PostgreSQL 15, other versions apply.

# Operation in host #

```sh '
# qjail create-n lo1-4192.168.1.3 postgres
♪ qjail config-y postgres ♪
♪ qjail start postgres
````

Edit `/etc/pf.conf '

```sh '
# As explained above #
rdr pass on em0 inlet proto tcp from any to em0 port 5432 - > 192,168.1.3 port 5432 # does not recommend this sentence, which is used to make postgresql outside of Jail accessible, which should take into account security and practical needs to open port forwarding, does not recommend direct postgresql connection to the outside
````

Enable pf

```sh '
# Service pf start
````

Enter the jail console called postgres

```sh '
♪ qjail console popgles
````

## jail console operation

The following commands are running under the jail console, and the use of mirrors for the pkg installation is up to you. If you use mirrors, you can set them like a host in the jail console.

- Install with pkg:

```sh '
# pkg install postgresql15-server
````

- Or install with Ports

```sh '
#cd/usr/ports/datases/postgresql15-server/ & make install clean
````

I don't...

Configure PostgreSQL:

```sh '
# Service postgresql available
#mkdir-p-m0700/var/db/postgres/data15
# Down postgress: postgres / var/db/postgres/data15 # This directory should belong to postgres users
# su postgres # # here to popgres users, watch for the next hint
$Initdb-A scram-sha-256-E UTF8-W-D/var/db/postgres/data15
$xit # Back to jail root user, note the hint changes
# Service postgresql start
````

Use `/usr/local/etc/rc.d/postgresql initdb ' instead of `/usr/local/ec/rc.d/postgresql inidb ' to change the `pg_hba.conf ' file back and forth to avoid later setting the password for the database, with a brief description of the options:

-** `-A '** Specify the default authentication method used in pg_hba.conf for local users

-**-E`** Select the code for the template database.

- ** `-W '** Allow initdb hint to request a password for a database super user

-**-D '** Specifies the directory where the database collection should be stored

Up to this PostgreSQL service can already be run.

If the `qjail config-y postgres ' commands are forgotten to open SysV IPC in the course of the process, the following error may occur:

Error Initializing Database Cluster

![..gitbook/assets/qjailpostgresiniterror.png]

Error starting PostgreSQL

![..getbook/assets/qjailpostgresstarteror.png]

I don't...

The error can be corrected by implementing `qjail config-y postgres ' under the host control at this time, as follows:

```sh '
♪ qjail stop postgres
♪ qjail config-y postgres
♪ qjail start postgres
````

Reentering the jail console allows normal initialization of the database cluster and operation of PostgreSQL services.
。
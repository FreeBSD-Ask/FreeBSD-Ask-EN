# Section 9.3 Use Qjail to manage Jail

Qjail is a deployment tool for the Jail environment, reproduced from ezjail 3.1. Jail management tools include ezjail, Qjail, ocage, etc. ezjail has not had a critical update since it was updated to 3.4.2 in 2015. ezjail's ports update relies on portsnap, which is now obsolete. iocage relies on the ZFS file system, which cannot be used by users using the UFS file system. Qjail has no problems in these areas. ezjail does not support Jail 's vnet function, ocage and Qjail support. ezjail and Qjail write with sh, ocage with python。

Jail, deployed below, is conceptually structured as follows:

![..gitbook/assets/qjailnetstrutt.png]

# keep jail's ip

WRITE IN __CODESPAN_0_

```sh
cloned_interfaces="lo1"  # 克隆出 lo1，尽量和宿主机网络配置分开。①
ifconfig_lo1_alias0="inet 192.168.1.0-9" # 宿主机 ip 为 10.0.2.15, 选择该网段是为了和宿主机网段分开，请自行斟酌
```

Note**
>
>1 if it is to generate multiple ports, it should also be described in the same line, separated by spaces, instead of creating a separate line, such as lined_interfaces = "lo1 lo2". multi-line, one line only。

Run

```sh
# service netif restart
```

the lo1 will get 10 ip addresses, and the 9 ips below will be used for jail。

# Install Qjail tool

- install with pkg:

```sh
# pkg install qjail
```

- Or install with Ports:

```sh
# cd /usr/ports/sysutils/qjail/ 
# make install clean
```

enable qjail

```sh
# sysrc qjail_enable=YES
```

# Deployment of directory structure used by Qjail

There are two ways to deploy the directory structure used by Qjail before using Qjail:

# Appendix: Automatic download from official mirror station

```sh
# qjail install
```

Qjail downloads base.txz files from FreeBSD official network, with the following examples:

```sh
# qjail install
resolving server address: ftp.freebsd.org:80
requesting http://ftp.freebsd.org/pub/FreeBSD/releases/amd64/amd64/13.1-RELEASE/base.txz
remote size / mtime: 195363380 / 1652346155
...
```

# # Appendix: Download from a mirror station inside the country

It is also possible to use mirrors manually because of internal network problems, using as an example the China University of Science and Technology mirrors (downloading is a version number, Qjail requires that the version be consistent with the host host, here is FreeBSD amd 64 13.1)

```sh
# fetch https://mirrors.ustc.edu.cn/freebsd/release/amd64/13.1-RELEASE/base.txz
# qjail install base.txz
```

The `/usr/jails` directory will automatically generate __CODESPAN_1_ __CODESPAN_2_CODESPAN_3___ __ CODESPAN_4_ four directories when the __CODESPAN_4_ is deployed:

- **sharedfs** contains a read-only operating system executable file, mounted as nulllfs, shared among the jails to save storage space。
-**template** configuration containing operating systems that will be copied to each jail base file system
- **archive** save archive files generated by jail archive
-**flavors** contains system styles (flavors) and user-created self-defined styles, in fact, self-defined profiles, etc

# deployment jail

```sh
# qjail create -n lo1 -4 192.168.1.1 jail1
```

-__CODESPAN_0_specify the use of lo1 as a network interface
-_CODESPAN_0_specify the ipv4 address。

When you generate jail, the ___CODESPAN_0_ directory corresponds to the __CODESPAN_1_catalogue (__CODESPAN_2_), and the corresponding file is saved。

You can create your own profile in the above-mentioned directory __CODESPAN_0_ to copy it to the new jail when you deploy Jail. If you create a new __CODESPAN_1_, then when you create a new jail, you will automatically copy the file to the corresponding jail, i. e

```sh
# qjail create -n lo1 -4 192.168.1.2 jail2
```

Creates __CODESPAN_0_ automatically after the creation of jail2, which modifys all post-jail default pkg mirrors. This file was not generated for jail1 because the corresponding file had not been written in the flavors directory when the jail1 was generated。

# Qjail Basic Usage

List Qjail managed jail

```sh
# qjail list
```

- enable jail

```sh
# qjail start # 启动所有 jail
# qjail start jail1 # 启动 jail1
```

- stop, jail

```sh
# qjail stop # 停止所有 jail
# qjail stop jail1 # 停止 jail1
```

- restart, jail

```sh
# qjail restart # 重启所有 jail
# qjail restart jail1 # 重启 jail1
```

- access to jail console

```sh
# qjail console jail1  # 进入 jail1 控制台
```

after entering the jail console, this is the root account of the jail (entry to the jail console without the need to enter a password), as jail may open an external service and suggest setting the account password for security considerations

- backup jail

```sh
# qjail archive -A  # 备份所有 jail
# qjail archive jail1  # 备份 jail1
```

- restore jail from backup

```sh
# qjail restore jail1  # 从备份中恢复 jail1
```

- delete jail

```sh
# qjail delete jail1  # 删除 jail1
# qjail delete -A     # 删除所有 jail
```

# update jail

the section that updates jail below is not for a single jail, but for each jail, as these files are shared with the nullfs。

# update basic systems in jail

the documents in the sharedfs mentioned above

```sh
# qjail update -b
```

# update ports

Here are two options: __CODESPAN_0 (lowcase), __CODESPAN_1 (highcase), __ CODESPAN_2_ (lowcase) with portsnap to update jail's ports tree. __CODESPAN_3_(highcase) updates jail's ports using the ports of the host. If the hosts already exist, it is recommended to use __CODESPAN_4_(caps) to avoid double downloading of the ports。

```sh
# qjail update -P  # 这里注意要大写
```

Update system source code

```sh
# qjail update -S # 大写
```

Update process

PLEASE INSTALL __CODESPAN_0_。

Start updating:

```sh
# freebsd-update fetch install
# gitup src
# gitup ports
# qjail stop
# qjail update -b
# qjail update -S
# qjail update -P
# qjail start
```

# jail settings

Qjail can use the __CODESPAN_0_ command to set another setting for each jail, and to run __CODESPAN_1_, the specified jail must be disabled。

__CODESPAN_0_ COMMAND OPTIONS ARE AVAILABLE. PLEASE REFER TO THE MANUAL PAGE

[qjail-Utilityfor development of jail environment] (https://www.freebsd.org/cgi/man.cgi?query=qjail&manpath=FreeBSD+13.1-RELEASE+and+Ports)

# CODESPAN_0__

```sh
# qjail config -h jail1
```

quick-start ssh service for jail1 to create a new wheel group user with the same username and password as jail, and use this user login for the first time to change the password. you can also configure your own sshd service after you login to the jail console。

# CODESPAN_0 _ CODESPAN_1 _

```sh
# qjail config -m jail1
```

Sets the jail1 to be started manually (manual state), CODESPAN_0___ by writing __CODESPAN_1_, and then automatically by starting each jail, set for manual start-up, without automatically starting the corresponding jail at system start-up, using __CODESPAN_2_。

The lowercase __CODESPAN_0_, with the uppercase __CODESPAN_1_, is used to turn off the manual start-up, i.e. to clear the manual state, and can automatically start jail on system startup. There are many similar options in Qjail, where the lowercase letter option allows a function, and the uppercase letter option closes the corresponding function. If the options for both lower and uppercase appear below, there will be no excessive explanation。

# CODESPAN_0 _ CODESPAN_1 _

```sh
# qjail config -r jail1
```

sets jail1 as not allowed to start (norun state), which is equivalent to disables the jail。

# CODESPAN_0 _ CODESPAN_1 _

```sh
# qjail config -y jail1
```

Enables SysV IPC of this jail to install PostgreSQL in jail. This option needs to be opened. PostgreSQL runs on this feature。

# Network settings

Note**
>
Some of them will teach you the ability to open an offline view with ___CODESPAN_0_, which is an error. Raw_sockets is just a ping-like tool that needs to be used, not that Internet access has to open raw_sockets. And open raw_sockets itself in jail is a default security design for the jail environment. So unless you have to use a ping or something in the jail, the jail that is built in whatever way does not recommend the raw_sockets function。

Jail at this time is not able to connect to the network because jail is bound to the lo1 network interface, lo1 does not have direct access to the network, then set the network through pf, where __CODESPAN_0_ is the Extranet interface

- WRITE IN __CODESPAN_0_

```sh
nat pass on em0 inet from lo1 to any -> em0  # 使 jail 可以访问网络，从 lo1 接口发出的连接通过 nat 转发到 em0
rdr pass on em0 inet proto tcp from any to em0 port 22 -> 192.168.1.1 port 22  # 使宿方机外可以访问指定 jail，端口重定向，把连接到 em0 上 22 端口上的 tcp 连接重定向到 192.168.1.1 地址（即 jail1）的 22 端口上
```

- Activate the firewall

```sh
# service pf enable
# service pf start
```

at this point, jail, bound on lo1, can access the host's external network, which can connect jail's port 22 through host 22。

# Example: Deployment PostgreSQL jail

Assumes that the jail ip has been reserved as described above and that the __CODESPAN_0_ command has been successfully run。

Here, for example, PostgreSQL 15, other versions apply。

# Operation in host #

```sh
# qjail create -n lo1 -4 192.168.1.3 postgres
# qjail config -y postgres   #  开启 SysV IPC
# qjail start postgres
```

EDIT __CODESPAN_0_

```sh
nat pass on em0 inet from lo1 to any ->em0  # 上文已作说明
rdr pass on em0 inet proto tcp from any to em0 port 5432 -> 192.168.1.3 port 5432 # 不建议写下此句，作用为使宿方机外可以访问 jail 中的 postgresql，此处应考虑安全和实际需要开启端口转发，不建议直接向外提供 postgresql 连接
```

enable pf

```sh
# service pf start
```

enter the jail console called postgres

```sh
# qjail console postgres
```

## jail console operation

the following commands are running under the jail console, and the use of mirrors for the pkg installation is up to you. if you use mirrors, you can set them like a host in the jail console。

- install with pkg:

```sh
# pkg install postgresql15-server
```

- Or install with Ports

```sh
# cd /usr/ports/databases/postgresql15-server/ && make install clean
```

---|---

Configure PostgreSQL:

```sh
# service postgresql enable
# mkdir -p -m 0700 /var/db/postgres/data15  # 注意版本号
# chown postgres:postgres /var/db/postgres/data15  # 这个目录应属于 postgres 用户
# su postgres   # 这里切换到 postgres 用户，注意下面提示符的变化
$ initdb -A scram-sha-256 -E UTF8 -W -D /var/db/postgres/data15
$ exit   #  回到 jail root 用户，注意提示符变化
# service postgresql start
```

Here, use __CODESPAN_0 instead of __CODESPAN_0, which is the hint at installation, to change __CODESPAN_1_files back and forth in order to avoid subsequent setting of the database password

-**_CODESPAN_0_** Specifies the default authentication method used in pg_hba.conf for local users

-**_CODESPAN_0_** SELECT THE ENCODING FOR THE TEMPLATE DATABASE。

- **_CODESPAN_0_** Allow initdb hint to request a password for a database super user

-**_CODESPAN_0_** SPECIFIES THE DIRECTORY WHERE THE COLLECTION OF DATABASES SHOULD BE STORED

Up to this PostgreSQL service can already be run。

If you forget to use the __CODESPAN_0_ command to open SysV IPC during the course above, the following error may occur:

Error Initializing Database Cluster

![..gitbook/assets/qjailpostgresiniterror.png]

Error starting PostgreSQL

![..getbook/assets/qjailpostgresstarteror.png]

---|---

`qjail config -y postgres` CAN CORRECT THE ERROR AT THIS TIME UNDER THE HOST CONTROL AS FOLLOWS:

```sh
# qjail stop postgres
# qjail config -y postgres
# qjail start postgres
```

Reentering the jail console allows normal initialization of the database cluster and operation of PostgreSQL services。

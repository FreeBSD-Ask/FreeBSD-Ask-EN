# Section 21.7 Gentoo Linux Compatibility Layer


# Build basic systems

```sh
# sysrc linux_enable="YES"
# service linux start
# service dbus enable #一般桌面已经配置
# service dbus start #一般桌面已经配置
```

```sh
# wget https://mirrors.ustc.edu.cn/gentoo/releases/amd64/autobuilds/20230101T164658Z/stage3-amd64-systemd-20230101T164658Z.tar.xz #该链接不固定！自己找。
# mkdir -p /compat/gentoo
# tar xpvf stage3-amd64-systemd-20230101T164658Z.tar.xz -C /compat/gentoo --numeric-owner
```

EDIT __CODESPAN_0_, ADD:

```sh
# Device        Mountpoint              FStype          Options                      Dump    Pass#
devfs           /compat/gentoo/dev      devfs           rw,late                      0       0
tmpfs           /compat/gentoo/dev/shm  tmpfs           rw,late,size=1g,mode=1777    0       0
fdescfs         /compat/gentoo/dev/fd   fdescfs         rw,late,linrdlnk             0       0
linprocfs       /compat/gentoo/proc     linprocfs       rw,late                      0       0
linsysfs        /compat/gentoo/sys      linsysfs        rw,late                      0       0
/tmp            /compat/gentoo/tmp      nullfs          rw,late                      0       0
#/home           /compat/gentoo/home     nullfs          rw,late                      0       0
```

```sh
# mount -al # 检查有无编写错误
```

Edit:

_CODESPAN_0_

Accession:

```sh
MAKEOPTS="-j2"
GENTOO_MIRRORS="https://mirrors.ustc.edu.cn/gentoo"
FEATURES="-ipc-sandbox -mount-sandbox -network-sandbox -pid-sandbox -xattr -sandbox -usersandbox"
```

Common configuration:

```sh
# mkdir -p /compat/gentoo/etc/portage/repos.conf # 此时位于 FreeBSD！
# cp /compat/gentoo/usr/share/portage/config/repos.conf /compat/gentoo/etc/portage/repos.conf/gentoo.conf # 此时位于 FreeBSD！
# cp /etc/resolv.conf /compat/gentoo/etc/ # 此时位于 FreeBSD！复制 DNS 解析。
```

# Gentoo for source

```sh
# ee /compat/gentoo/etc/portage/repos.conf/gentoo.conf # 此处位于 FreeBSD！
```

AMEND __CODESPAN_0 TO `sync-uri = rsync://mirrors.tuna.tsinghua.edu.cn/gentoo-portage`_。

```sh
# chroot /compat/gentoo /bin/bash # 此处位于 Gentoo!
```

Get Gentuo ebuild database snapshots

```sh
# emerge-webrsync
```


# After changing source

test installation

```sh
ykla / # emerge -v screenfetch

.
Are you sure.


These are the packs that would be made, in order:

Calculating endeavours... done!
Dependency resolution took 2.51 s.

[ebuild N] App-misc/screenfetch-3.9.1: :gentoo USE= "-X-curl" 76 KiB

.

Recording app-misc/screenfetch in "world" favorites file...

Completed (1 of 1) app-misc/screenfetch-3.9.1: gentoo
````

Software can be installed normally。


```sh
ykla / # screenfetch
grep: warning: stray \ before "
grep: warning: stray \ before "
         -/oyddmdhs+:.                ykla@ykla
     -odNMMMMMMMMNNmhy+-`             OS: Gentoo 
   -yNMMMMMMMMMMMNNNmmdhy+-           Kernel: x86_64 Linux 6.2.10
 `omMMMMMMMMMMMMNmdmmmmddhhy/`        Uptime: 1h 26m
 omMMMMMMMMMMMNhhyyyohmdddhhhdo`      Packages: 295
.ydMMMMMMMMMMdhs++so/smdddhhhhdm+`    Shell: bash 5.1.16
 oyhdmNMMMMMMMNdyooydmddddhhhhyhNd.   Resolution: No X Server
  :oyhhdNNMMMMMMMNNNmmdddhhhhhyymMh   WM: Not Found
    .:+sydNMMMMMNNNmmmdddhhhhhhmMmy   Disk: 8.9G / 45G (20%)
       /mMMMMMMNNNmmmdddhhhhhmMNhs:   CPU: Intel Core i5-3230M @ 2x 2.594GHz
    `oNMMMMMMMNNNmmmddddhhdmMNhs+`    RAM: 3209MiB / 4038MiB
  `sNMMMMMMMMNNNmmmdddddmNMmhs/.     
 /NMMMMMMMMNNNNmmmdddmNMNdso:`       
+MMMMMMMNNNNNmmmmdmNMNdso/-          
yMMNNNNNNNmmmmmNNMmhs+/-`            
/hMMNNNNNNNNMNdhs++/-`               
`/ohdmmddhys+++/:.`                  
  `-//////:--.                       
ykla / # 
```

# shell script


Script content:

```sh
#/bin/sh

rootdir=/compat/gentoo
fetch https://mirrors.ustc.edu.cn/gentoo/releases/amd64/autobulds/latest-stage3-amd64-systemd.txt
gentoodownload=$US$
this post is part of our special coverage global development 2011


url= "https://mirrors.ustc.edu.cn/gentoo/releases/amd64autobuilds/"

"Begin to install last Gentoo Linux..."
"check motors..."

♪ check the linux motore
if [ "$(sysrc-n linux_enable)] = "NO"; then
"Linux module should be loaded."
now, read answer
if you don't mind, case dollar in
[Nn] [OO]| [Nn]
"linux module not loaded"
exit 1
;
[Yy] [Ee] [S] [Yy]|"]
== sync, corrected by elderman ==
;
that's it
f
"start linux."
it's not a good idea

♪ check dbus
if
"dbus-daemon not found
now, read answer
if you don't mind, case dollar in
[Nn] [OO]| [Nn]
"dbus not mentioned"
exit 2
;
[Yy] [Ee] [S] [Yy]|"]
pkg install-y dbus
;
that's it
f

if ["sysrc-n dbus_enable"]
"dbus should be able."
now, read answer
if you don't mind, case dollar in
[Nn] [OO]| [Nn]
"dbus not running"
exit 2
;
[Yy] [Ee] [S] [Yy]|"]
== sync, corrected by elderman ==
;
that's it
f
"start dbus."
it's a service dbus start

"now we will bootstream gentoo."

fetch ${url}/$gentoodownload
mkdir-p {rootdir}
*.tar.nz-C {rootdir}-numeric-owner
i'm sorry stage3-amd64-system*.tar.xx

if it's not "YES"
"nullfs should read
now, read answer
if you don't mind, case dollar in
[Nn] [OO]| [Nn]
"nulfs not load"
exit 3
;
[Yy] [Ee] [S] [Yy]|"]
sysrc-f /boot/loader.conf nulls_load=yes
;
that's it
f

if
i'm sorry
kldload-v nulls
f

"mount some fs for linux"
> > ecc/fstab
epho "tmpfs $ {rootdir}/dev/shmtmpfs rw, late, size=1g, mode=17770" >/etc/fstab
>/etc/fstab
>/etc/fstab
> et ecc/fstab
echo "/tmp ${rootdir}/tmp nullfs rw, late 0" >/etc/fstab
#cho "/home {rootdir}/home nulls rw, late 0" > /etc/fstab
"mount-al."

"For Gentoo Linux, we should change 'compat.linux.osrelease' to upgrade Linux Kernel version, continue?"
now, read answer
if you don't mind, case dollar in
[Nn] [OO]| [Nn]
"clos to access"
exit 4
;
[Yy] [Ee] [S] [Yy]|"]
> / etc/syscl.conf
it's a good time, sysctl compat.linux.osrelease=6.2.10
;
that's it
"complete!"
echo "to use: chorot $ {rootdir}/bin/bash"
echo"
"I will set back
"Continue?"
now, read answer
if you don't mind, case dollar in
[Nn] [OO]| [Nn]
"set your gentuo by yourself. bye!"
exit 0
;
[Yy] [Ee] [S] [Yy]|"]
>${rootdir}/etc/resolv.conf



"Now write MAKEOPTS FEATURES in /compat/gentoo/etc/portage/make.conf-using USTC imrors for GENTOO_MIRRORS"
"MAKEOPTS=\-j2\> /${rootdir}/etc/portage/make.conf
ec \ \ \ \ \ \ \ > > { { { { { rootdir}/etc/portage/make.conf
"FEATURES=-ipc-sandbox-mount-sandbox-network-sandbox-sandbox-xattr-sandbox-usersandbox"

"Now setting soft sources-Using TUNA imror for emerge-websync."
mkdir-p {rootdir}/etc/portage/repos.conf
cp {rootdir}/usr/share/portage/config/repos.conf {rootdir}/etc/portage/repos.conf/gentoo.conf
sed-i "'s/rsync.gento.org/mirrors.tsinghua.edu.cn/'${rootdir}/etc/portage/repos.conf/gentoo.conf

"I will run emerge-websync"
/bin/bash-c "emerge-websync"

"all done."
"Now you can run 'choot /compat/gentoo//bin/bash'Intogenoo"
;
that's it
````


# Section 21.4 ArchLinux Compatibility Layer (based on ArchLinux Bootstream)

Video tutorial: [07-FreeBSD-ArchLinux Compatible Script Defense] (https://www.bilibili.com/video/BV1wg4y1w7QV)

# ArchLinux Compatibility Layer

![.. ..gitbook/assets/arch.png]


> ** Note**
>
>ArchLinux Compatibility appears to have slightly more than Ubuntu Compatibility because of the running Google Crome Browser。

[Install Arch Linux from the current Linux reference] (https://wiki.archlinuxcn.org/wiki/%E4%BB%8E%E7%E8%E%E%B0%E6%E9C%89_Linux_%E5%E8%E1%E1%E7%89%E8%E8%E8%E8%E8%E8%E8%E8%E2%8%E2%E2%8%E4%E8%E4%E3%E3%A3%85_Arch_Linux)。

Because the default kernel for Linux Compatibility is 3.17, it's too low. If constructed directly, Arch Compatibility will report `FATAL: kernel too old`in error at chroot. The kernel version of the Linux Compatible layer needs to be changed to 6.12.20 (or other higher) to:

```sh
# echo "compat.linux.osrelease=6.12.20" >> /etc/sysctl.conf
```

It can enter into force permanently。

# Build basic systems #

```sh
# sysrc linux_enable="YES"
# service linux start
# service dbus enable #一般桌面已经配置
# service dbus start #一般桌面已经配置
```

```sh
# mkdir -p /compat
# fetch http://mirrors.cqu.edu.cn/archlinux/iso/latest/archlinux-bootstrap-x86_64.tar.zst
# tar --use-compress-program=unzstd -xpvf archlinux-bootstrap-x86_64.tar.zst -C /compat --numeric-owner # 若有报错 tar: Error exit delayed from previous errors. 请无视之。-
# mv /compat/root.x86_64 /compat/arch # 重命名 /
```

Mount File System

WRITE __CODESPAN_0_IN_CODESPAN_1___。

WRITE THE FOLLOWING LINES TO __CODESPAN_0_:

```sh
# Device        Mountpoint            FStype          Options                      Dump    Pass#
devfs           /compat/arch/dev      devfs           rw,late                      0       0
tmpfs           /compat/arch/dev/shm  tmpfs           rw,late,size=1g,mode=1777    0       0
fdescfs         /compat/arch/dev/fd   fdescfs         rw,late,linrdlnk             0       0
linprocfs       /compat/arch/proc     linprocfs       rw,late                      0       0
linsysfs        /compat/arch/sys      linsysfs        rw,late                      0       0
/tmp            /compat/arch/tmp      nullfs          rw,late                      0       0
#/home           /compat/arch/home     nullfs          rw,late                      0       0
```

Check the wall with no errors:

```sh
# mount -al
```

if the hint does not have a home folder, create it:

```sh
# mkdir /compat/arch/home
```

Restart:

```sh
# reboot
```

Basic configuration

# # initialize pacman keyring #

```sh
# cp /etc/resolv.conf /compat/arch/etc/ # 此时位于 FreeBSD！复制 DNS 解析。
# chroot /compat/arch /bin/bash # 此时已经是 Arch 兼容层了！
# pacman-key --init
# pacman-key --populate archlinux
```

Change source

Because the newly installed Arch does not have any text manager, we need to edit the files in FreeBSD:

```sh
# ee /compat/arch/etc/pacman.d/mirrorlist # 此时位于 FreeBSD！将下行添加至文件顶部。

Server = https://mirrors.tuna.tsinghua.edu.cn/archlinux/$repo/os/$arch
````

Installation of some basic software:

```sh
# pacman -S base base-devel nano yay wqy-zenhei
```

###archlinuxcn source configuration

```sh
# nano /etc/pacman.conf # 将下两行添加至文件底部。

[archlinuxcn]
Server = https://mirrors.tuna.tsinghua.edu.cn/archlinuxcn/$arch
````

Import key:

```sh
# pacman -S archlinuxcn-keyring
```

**TIP: THIS STEP MAY TAKE 10 MINUTES OR MORE AT __CODESPAN_0. PLEASE WAIT. **

Since direct root is prohibited for yay and software like the installation aur, it is necessary to create a user with normal permission in chroot (the original user in FreeBSD tested is not available):

```sh
# useradd -G wheel -m test
```

edit sudo profile (not if red alert):

```sh
# nano /etc/sudoers
```

DELETE __CODESPAN_0... __CODESPAN_1..。
DELETE __CODESPAN_0... __CODESPAN_1..。

unmount fakeroot to fakeroot-tcp, otherwise it is not possible to use aur:

>The Bug See <https://archlinuxarm.org/forum/viewtopic.php?t=14466>

```sh
# pacman -S fakeroot-tcp #会询问是否卸载 fakeroot，请确认并卸载。
```

Note that if a password is set for __CODESPAN_0 but still hints for a password error, you need to open a new terminal and enter __CODESPAN_1_1_ to restart FreeBSD and then proceed。

Area Settings

> ** Tip: The Chinese input method cannot be used in ArchLinux graphics without setting. **

EDIT __CODESPAN_0 AND DELETE __CODESPAN_1 __ __ CODESPAN_2_。

Regenerated area file:

```sh
# locale-gen
```

# Shell script

The script reads as follows:

```sh
#/bin/sh

rootdir=/compat/arch
url = "https://mirrors.cqu.edu.cn/archlinux/iso/latest/archlinux-bootstream-x86_64.tar.zst"

"begin to install achlinux..."
"check motors..."

♪ check the linux motore
if [ "$(sysrc-n linux_enable)] = "NO"; then
"Linux module should be loaded."
now, read answer
if you don't mind, case dollar in
[Nn] [OO]| [Nn]
"linux module not loaded"
exit 1
;
[Yy] [Ee] [S] [Yy]|"]
== sync, corrected by elderman ==
;
that's it
f
"start linux."
it's not a good idea

♪ check dbus
if
"dbus-daemon not found
now, read answer
if you don't mind, case dollar in
[Nn] [OO]| [Nn]
"dbus not mentioned"
exit 2
;
[Yy] [Ee] [S] [Yy]|"]
pkg install-y dbus
;
that's it
f

if ["sysrc-n dbus_enable"]
"dbus should be able."
now, read answer
if you don't mind, case dollar in
[Nn] [OO]| [Nn]
"dbus not running"
exit 2
;
[Yy] [Ee] [S] [Yy]|"]
== sync, corrected by elderman ==
;
that's it
f
"start dbus."
it's a service dbus start

"now we will bootstrap arclinux."

fetch $ {url}
mkdir /compat
= = = = = = = = =
i'm sorry archlinux-bootstream-x86_64.tar.zst
mv /compat/ root. x86_64 {rootdir}

if it's not "YES"
"nullfs should read
now, read answer
if you don't mind, case dollar in
[Nn] [OO]| [Nn]
"nulfs not load"
exit 3
;
[Yy] [Ee] [S] [Yy]|"]
sysrc-f /boot/loader.conf nulls_load=yes
;
that's it
f

if
i'm sorry
kldload-v nulls
f

"mount some fs for linux"
> > ecc/fstab
epho "tmpfs $ {rootdir}/dev/shmtmpfs rw, late, size=1g, mode=17770" >/etc/fstab
>/etc/fstab
>/etc/fstab
> et ecc/fstab
echo "/tmp ${rootdir}/tmp nullfs rw, late 0" >/etc/fstab
#cho "/home {rootdir}/home nulls rw, late 0" > /etc/fstab
"mount-al."

"for arclinux, we should change 'compat.linux.osrelease'.continue?"
now, read answer
if you don't mind, case dollar in
[Nn] [OO]| [Nn]
"clos to access"
exit 4
;
[Yy] [Ee] [S] [Yy]|"]
> /etc/sysctl.conf
it's not like it's a good idea, sysctl compat.linux.osrelease=6.12.20
;
that's it
"complete!"
echo "to use: chorot $ {rootdir}/bin/bash"
echo"
"but for easy use, i can do some init config."
"if agree: "
"i set up a search
"init pacman keeping"
"use tsinghuamiror"
"Continue?"
now, read answer
if you don't mind, case dollar in
[Nn] [OO]| [Nn]
"set your aschlinux by yourself.by!"
exit 0
;
[Yy] [Ee] [S] [Yy]|"]
>${rootdir}/etc/resolv.conf
/bin/bash-c "pacman-key-init"
/bin/bash-c "pacman-key-populate arclinux"
cat {rootdir}/etc/pacman.d/mirrorlist > mlst.tmp
epho 'Server = https://mirrors.tuna.tsinghua.edu.cn/archlinux/$repo/os/$arch' >${rootdir}/etc/pacman.d/mirrorlist
cat mlst.tmp > ${rootdir}/etc/pacman.d/mirrorlist
i'm sorry
 >rootdir}/etc/pacman.conf
epho 'Server = https://mirrors.tuna.tsinghua.edu.cn/archlinuxcn/$arch'>${rootdir}/etc/pacman.conf
"Refresh sources and systems."
/bin/bash-c "pacman-Syyu-noconform"
"Refresh key."
/bin/bash-c "Pacman-S-noconfirm achlinuxcn-keyring"
"Install yay."
/bin/bash-c "pacman-S-noconfil-base-devel-nano-y wqy-zenhei"
"Create user."
/bin/bash-c "userad-G sheel-m test"
"Now modify the sudo configation"
epho '%heel alll=(ALL)All' > ${rootdir}/etc/sudores
epho '%sudo Alll=(All:All)All' > ${rootdir}/etc/sudores
"change fakeroot."
/bin/bash-c "pacman-S-noconfirm fakeroot-tcp"
"Make localised settings"
echo 'zh_CN.UTF-8 UTF-8' > ${rootdir}/etc/locale.gen
/bin/bash-c "locale-gen"
"all done."
;
that's it
"Now you can run 'choot /compat/arch/ bin/bash' Into ArchLinux"
````

# References

- [linux-Linux ABI support] (https://man.freebsd.org/cgi/man.cgi?linux(4))


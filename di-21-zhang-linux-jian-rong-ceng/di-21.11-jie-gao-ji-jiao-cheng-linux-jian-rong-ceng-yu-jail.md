# Section 21.11 Linux Compatible Layer with Jail

# Preparatory work

This paper binds all jail to the virtual interface `lo1 ' , all jail is equivalent to a local area network under FreeBSD, and FreeBSD hosts are equivalent to a gateway to the Bureau ' s area network.

All Jail ' s network activities are subject to a network interface, `lo1 ' , so the use of the network requires a network relay, which is done using a pf firewall.

Note**
>
> This is key to accessing web access.

# Prepare the network interface #

```sh '
# Sysrc network_interfaces+= "lo1" #
# service network network #
````

# Ready pf firewall #

This is provided in two ways, on an as-needed basis.

Method I

Edit `/etc/pf.conf ' , add:

```sh '
I'm sorry.
{\bord0\shad0\alphaH3D}Nat pass on em0 int from <jails> to any--
````

A table called `jails ' was created in the firewall and the `persist ' sign was designated so that the firewall always maintains it (even if it is not quoted in the relevant rules).

The Table is a named structure of the pf firewall that preserves the combination of addresses and networks. The address in the `jails ' table can be accessed through NAT.

The `jails ' tables can be added to or subtracted from `pfctl ' to control network access. For example:

- `pfctl -t jails -T add 192.168.5.1 ' Add `192.168.5.1 ' to jails tables so that they can access the network
- `pftl-tjails-Tdelete 192,168.5.1 ' , `192,168.5' removed from the Jails Tables and made it impossible to access the network.

It is characterized by manual management of troubles but is flexible.

Method II

Write the rule directly in `/etc/pf.conf ' :

```sh '
{\cHFFFFFF}{\cH00FFFF} Nat pass on em0 inet from 192,168.5.1 to any-> em0
````

It is convenient to allow `192.168.5.1 ' access to the network, which is characterized by rules firmly embedded in the configuration without special needs.

## Enable pf firewall

>** Warning**
>
Whether you want to use a firewall or not, you don't have a network in Jail.

```sh '
# Service pf available
# Service pf start
````

# # Load necessary Linux compatibility inner core module #

```sh '
♪ Service Linux enough
# Service Linux start
````

This way you can automatically load the modules of the linux compatibility layer

# Ready directory #

```sh '
#mkdir /usr/jails # to save files that create jail
````

# Create debian jail

# Download basic systems #

Here is the example of Debian 12 (bookwork):

Build Ubuntu/ Debian

```sh '
# pkg installation debootstream #
#chmod 0700/usr/local/sbin/debootstream #
#mkdir-p/usr/jails/debian
#debootstream bookwork/usr/jails/debian https://mirrors.ustc.edu.cn/debian/ #USTC mirror station used here
````

Example output:

```sh '
I: Retrieving InRelease
I: Retrieving Packages
I: Validating Packages
I: Resolving relationships of requited packs...
I: Resolving relationships of case packs...
I: Checking common cause on https://mirrors.ustc.edu.cn/debian...
I: Retrieving adduser 3.130
I: Validating adduser 3.130
I don't know.
I: Expressing usr-is-merged...
I: Expressing util-linux-extra...
I: Expressing zlib1g...
````

Note**
>
> At the end, there may be a hint of error, simply ignore it.

# # Create debian jail instance

Creates an example of jail with Debian 12 Basic System, named Debian.

Basic configuration of the instance

Create `/etc/fstab.debian ' as follows:

```sh '
Devfs /usr/jails/debian/dev Devfs rw 0 0
tmpfs /usr/jails/debian/dev/shmtmpfs rw, size = 1g, mode = 1777 0 0
fdescfs/usr/jails/debian/dev/fd fdescfs rw, llinrdlnk 0
/usr/jails/debian/proc llinprocfs rw 0 0
linsysfs /usr/jails/debian/sys linsysfs rw 0 0
/tmp /usr/jails/debian/tmp nulfs rw 0 0
````

In `/etc/jail.conf ' , insert the following (if not new):

```sh '
#jail
host. hostname = debian; #jail
Mount.fstab = /etc/fstab.debian; #jail used fstab: Mount/dismount the corresponding file system when starting/ closing jail
path = /usr/jails/debian; #jail root directory
devfs_ruleset = 4; #jail mounted devfs rule set: 0 means no rule set, jail will inherit the jail rule set,
# Can only mount devfs when they enable all.mount, allow.mount.devfs and enforce_statfs less than 2
enforce_statfs = 1; # When set to 0, all mount points are available without restriction.
# When set to 1, only the mount point under the Jail root directory is visible.
# Set to 2 (default value) only to operate on the mount point where the Jail directory is located, and cannot mount devfs, tmpfs, etc.
Allow.mount; # Allow Mounting File System
# Allows to mount devfs
# See
# See
# Allow jail to survive without any process
Allow.raw_sockets; # Allows ping and socket etc. to see if writing is needed
interface = lo1; # Use lo1 as a network interface
ip4.addr = 192.168.5.1; # used ipv4 address
ip6 =disable; # Disable ipv6
♪ I'm sorry ♪
````

- `exec.start ' specifies the command to run when starting jail.

If freebsd does jail, `exec.start = 'sh /etc/rc ' , i.e. rc system start-up service using FreeBSD.

But debian uses systemd as init system. jail does not use systemd, so it cannot use the corresponding command (service command is available), so here with `/bin/tru ' do nothing safe return `true` on it.

The problem is (in the case of sshd services) when sshd services (`service ssh start ') are enabled in debian jail, and if the debian jail is restarted, sshd services will not start with jail again. It could then be written as `exec.start ' . This way you can start sshd service when you start debian jail.

If more services are available, the following could be prepared:

```sh '
"service ssh start"
"service dbus start"
````

- `exec.stop ' command to stop jail running.

If freebsd does jail, `sh/etc/rc.shutdown jail ' .

Here again, for the reasons of systemd `/bin/true ' safe return `true ' .

## # Enable example to allow access to the network

- Start, jail.

```sh '
# Jail-c debian
````

- Stop, Jail.

```sh '
# Jail-r debian
````

- Add the address of jail to the `jails ' table in the pf firewall to allow Jail to access the network:

```sh '
# pfftl-t jails-T add 192,168.5.1
````

Update System

Implementation:

```sh '
# jexec debian/bin/bash # at FreeBSD!
#apt remove rsyslog #
Debian!
````

Or use

```sh '
# Jexec-l debian/bin/bash-c 'apt remove rsyslog'
# Jexec-l debian/bin/bash-c 'apt update'
````

Thus, a linux jail based on Debian 12 has been successfully created, and the same method can create multiple jail based on Debian and ubuntu versions.

# Jail, turn yourself on

Start when it starts, jail.

```sh '
♪ Service jail enough
````

Defaultly starts all jail.

Furthermore, the name of jail, which is started on startup, can be specified in the `/etc/rc.conf ' variable `jail_list ' for editing `/etc/rc.conf ' for writing:

```sh '
= "debian"
````

or implementation

```sh '
# Sysrc jail_list+=debian
````

If the `jail_list ' variable is empty, all Jail configured in `/etc/jail.conf ' will be activated.

# Create Ubuntu jail

ubuntu jail was created in the same way as Ubuntu 22.04 (jammy).

# Build and configure basic systems #

```sh '
#mkdir-p/usr/jails/ubuntu
#debootstream jammy/usr/jails/ubuntu https://mirrors.ustc.edu.cn/ubuntu/
````

Create `/etc/fstab.ubuntu ' as follows:

```sh '
devfs /usr/jails/ubuntu/dev Devfs rw 0
tmpfs /usr/jails/ubuntu/dev/shmtmpfs rw, size = 1g, mode = 1777 0
fdescfs /usr/jails/ubuntu/dev/fd fdescfs rw, llinrdlnk 0 0
/usr/jails/ubuntu/proc llinprocfs rw 0
linsysfs /usr/jails/ubuntu/sys linsysfs rw 0 0
/tmp /usr/jails/ubuntu/tmpnulfs rw 0
````

Write the ubuntu configuration in `/etc/jail.conf ' as follows:

```sh '
ubuntu
- Hi. hostname = ubuntu;
= /etc/fstab.ubuntu;
path = /usr/jails/ubuntu;
devfs_ruleset = 4;
= 1;
Allow.mount;
Allow.mount.devfs;
Exec.start = '/bin/tru';
= '/bin/tru';
I don't know.
Allow.raw_sockets;
(b) Interface = lo1;
ip4.addr = 192.168.5.2;
ip6 = disable;
♪ I'm sorry ♪
````

# # Enable examples and allow Internet access

```sh '
# jail-c ubuntu # Enable instance
````

If `jail_enable=YES ' has been set in `/etc/rc.conf ' , it may also be used

```sh '
# Service jail start ubuntu
````

Openable for reference debian jail, execute

```sh '
# Sysrc jail_list+ubuntu
````

Add the address of jail to the `jails ' table in the pf firewall to allow jail access to the network:

```sh '
# pfctl-t jails-T add 192,168.5.2 #
````

Update System

```sh '
# jexec ubuntu / bin/bash # at FreeBSD!
Ubuntu #apt remove rsyslog # Ubuntu Jail!
Ubuntu #apt update # Ubuntu Jail!
````

Or use

```sh '
# Jexec-l debian/bin/bash-c 'apt remove rsyslog'
# Jexec-l debian/bin/bash-c 'apt update'
````

Process and same debian jail.

# Create AntiX llinux jail

AntiX is based on debian and does not use systemd.

# Download mirror files and depress them

First install `squashfs-tools ' to depress the linux filesystem mirror.

```sh '
# pkg install squashfs-tools
````

AntiX linux provides four mirror versions, full, base, core, net, download the core version here:

```sh '
#fetch https://mirrors.tuna.tsinghua.edu.cn/mxlinux-isos/ANTIX/Final/antiX-23.2/antiX-23.2_x64-core.iso
# mdconfig antiX-23.2_x64-core.iso
# Mount-t cd9660/dev/md0/mnt
#mkdir-p/usr/jails/antix
#unsquashfs-d/usr/jails/antix/mnt/antiX/linuxfs
#touch/usr/jails/antix/dev/fd
#touch/usr/jails/antix/dev/shm
````

# Configure Antix jail

Create `/etc/fstab.antix ' as follows:

```sh '
Devfs /usr/jails/antix/dev Devfs rw 0 0
tmpfs /usr/jails/antix/dev/shmtmpfs rw, size = 1g, mode = 1777 0 0
fdescfs /usr/jails/antix/dev/fd fdescfs rw, linrdlnk 0
/usr/jails/antix/proc llinprocfs rw 0 0
linsysfs /usr/jails/antix/sys linsysfs rw 0 0
/tmp /usr/jails/antix/tmp nulfs rw 0 0
````

In `/ewrite in tc/jail.conf ' (only antix is shown here)

```sh '
Antix
= antix;
Mount.fstab = /etc/fstab.antix;
Path = /usr/jails/antix;
devfs_ruleset = 4;
= 1;
Allow.mount;
Allow.mount.devfs;
Exec.start = '/etc/init.d/rc 3';
Exec.stop = '/etc/init.d/rc 0';
I don't know.
Allow.raw_sockets;
(b) Interface = lo1;
ip4.addr = 192.168.5.3;
ip6 = disable;
♪ I'm sorry ♪
````

Here `exec.start ' is set as `/etc/init.d/rc 3 ' .

As already mentioned in the part of debian jail, debian uses systemd as an initialization system. This cannot be used in jail, so it is started with `/bin/true ' to ensure that nothing is done and only returns the true value safely.

antiX does not use systemd as an initialization system, which can be initiated by rc: Here `/etc/init.d/rc 3 `specify antix jail to use rc to initialize jail at the 3rd running level on startup. The service running problem mentioned in the debian jail does not exist here (i.e. the service can be run directly at the jail start, for example sshd).

Update System

- Set it up and start.

```sh '
# Sysrc jail_list+=antix
# Jail-c anthix # or use service jail start anthix #
````

- Allow Internet access in pf, as above.

```sh '
# pfctl-t jails-T add 192,168.5.3
````

- Now enter jail:

```sh '
# jexec anix / bin/bash # FreeBSD
root@antix: / #echo "nameserver 223.5.5" > /etc/resolv.conf #jail, note the hint changes, set the address to resolve, use Ali DNS here
Root@antix:/ #echo "APT::Cache-Start 90000000;" > /etc/apt/apt.conf # 'APT::Cache-Start 'is the size of apt to use the cache, default 20m too small, increased by hint
root@antix: / #apt update # can first modify the files in `/etc/apt/sources.list.d/ ' to use mirror stations, please refer to the image station settings of debian in each mirror station
Root
When root@antix: / #mandb #apt upglade shows that mandb has several bugs and several more `mandb ' commands.
````

# Create Alpine jail

- Build basic systems

```sh '
#fetch http://mirrors.ustc.edu.cn/alpine/v3.17/releases/x86_64alpine-minorotfs-3.17.1-x86_64.tar.gz
#mkdir-p/usr/jails/alpine
#tar zxf alpine-minirotfs-3.17.1-x86_64.tar.gz-C/usr/jails/alpine/
#touch/usr/jails/alpine/dev/shm
#touch/usr/jails/alpine/dev/fd
````

- Create `/etc/fstab.alpine ' as follows:

```sh '
devfs /usr/jails/alpine/dev Devfs rw 0 0
tmpfs /usr/jails/alpine/dev/shmmpfs rw, size = 1g, mode = 1777 0 0
fdescfs /usr/jails/alpine/dev/fd fdescfs rw, llinrdlnk 0 0
/usr/jails/alpine/proc llinprocfs rw 0 0
linsysfs /usr/jails/alpine/sys linsysfs rw 0 0
#/tmp /usr/jails/alpine/tmp nulfs rw 0 0
````

- In `/etc/jail.conf ' ,

```sh '
Alpine
= alpine;
Mount.fstab = /etc/fstab.alpine;
Path = /usr/jails/alpine;
devfs_ruleset = 4;
= 1;
Allow.mount;
Allow.mount.devfs;
Exec.start = '/bin/true'; #minirotfs does not have an initialization system, so use '/bin/true', and openrc is set below
= '/bin/tru';
I don't know.
Allow.raw_sockets;
(b) Interface = lo1;
ip4.addr = 192.168.5.4;
ip6 = disable;
♪ I'm sorry ♪
````

- Set the starter up, then start.

```sh '
# Sysrc jail_list+alpine
# Jail-c alpine
````

- Allow Internet access in pf, as above.

```sh '
# pfctl-t jails-T add 192,168.5.4
````

- Now enter jail:

```sh '
Freebsd #jeexec alpine / bin/sh # Initially only sh, note the change of shell hint
# sed-i 's/dl-cdn. alpinelinux.org/mirrors.ustc.edu.cn/'/etc/apk/repositories#
> /etc/resolv.conf # originally did not have this file and built one of its own
It's better to install an openrc to get better experience, but it's not possible to start services, but only when they are installed.
#apk add openrc # install openrc as an initialization system
Alpine #mkdir /run/openrc
Alpine #touch/run/openrc/softlevel #openrc suggests that this document should be created in the docker/chroot/jail environment
Note the change of the shell hint
#freebsd #jail-r alpine # close alpine first so that openrc configuration in freebsd host
````

- Modify the configuration of alpine in `/etc/jail.conf ':

```sh '
Alpine
= alpine;
Mount.fstab = /etc/fstab.alpine;
Path = /usr/jails/alpine;
devfs_ruleset = 4;
= 1;
Allow.mount;
Allow.mount.devfs;
exec.start = '/sbin/openrc default '; # Here modified to use openrc as an initialization system for default run-level initialization systems
exec.stop = '/sbin/openrc shutdown '; # Here modified to use openrc as an initialization system to run off jobs at the shutdown running level
I don't know.
Allow.raw_sockets;
(b) Interface = lo1;
ip4.addr = 192.168.5.4;
ip6 = disable;
♪ I'm sorry ♪
````

- Restart Alpine.

```sh '
# Jail-c alpine
````

# GUI of jail

Organisationlbox installed FreeBSD 13.1 virtual machine.

Four jails have been deployed in FreeBSD virtual machines, as follows. There's a freebsd jail, which distinguishes it from the FreeBSD virtual machine in the virtualbox, which we call `freebsd-jail ' :

Windows 10 Physical Machine FreeBSD 13.1 Virtual Machine FreeBSD Jail (`freebsd-jail') + Debian Jail + Ubuntu Jail + Alpine Jail.

```sh '
# Jls
JID IP Address Hostname Path
112,168.5.3 Debian/usr/jails/debian
2121.168.5.4 ubuntu/usr/jails/ubuntu
3192.168.5.2 alpine/usr/jails/alpine
4192.168.5.1 Freebsd-jail/usr/jails/freebsd-jail
````

Each of the four jails is equipped with xclock, firebox, chrome, jwm.

In freebsd-jail, Debian, ubuntu, alpine (alpine using vnc method unsuccessful, other methods xclock, xterm running, firefox and crome unsuccessful) all worked, and jwm used to be aesthetic.

>** Skills**
>
> Do not install xorg.

Of which, in ubuntu 22.04, Firefox, chrome requires snap, snap needs ssystemd, unserviceable, so it is installed in the Deb package. The methodology is as follows:

```sh '
#wgethttps://dl.google.com/linux/direct/google-chrome-table_current_amd64.deb
#dpkg-i google-chrome-table
#apt install./google-chrome-stable_current_amd64.deb
````

# The terminal with X Server

Here's the MobaXterm. MobaXterm default configuration, no redundant configuration.

![.. ..getbook/assets/jailx11mobaxstart.png]

Ensure that Xserver is enabled to write down the `DISPLAY 'value in the format of `hostname:display Nuber.screennuber ' This is `192.168.56.1:0.0 '

Login jail (open-ended, can be ssh, can be jexec; open-ended, can be ordinary, not necessarily root, wheel group members)

```sh '
$export DISPLAY = 192.168.56.1: 0.0 #jail, this is sh/zsh/bash. csh/tcsh is 192,168.56.1:0.0, down
$ xcock
````

![..gitbook/assets/jailx11mobaxclock.png]

4 xclocks can be shown independently on Windows 10 desktops, with a better effect.

# Embedded X Server

X Server in X Server, which uses Xnest/Xephyr, Xnest/Xephyr for X11 applications is X Server and X Clinic for host X Server.

- Installation of Xnest or Xephyr in FreeBSD virtual machines. One or the other:

```sh '
# Pkg install Xnest
````

Or...

```sh '
# Pkg install Xephyr
````

- Enabled in FreeBSD

```sh '
$Xephyr: 1 -liten tcp# does not require root permissions
````

- `1 ' , i.e. `display number ' in the `DISPLAY ' value mentioned above. FreeBSD IP is `10.0.2.15 ' so the full `DISPLAY ' value is `10.0.2.15:1.0 ' . Since the `display number 'value for FreeBSD X Server is `0 ' , it starts with `1 '
- `-listen tcp ' Intercept TCP Port

- Of the four jails, do the same thing above

```sh '
$ export DISPLAY=10.2.2.15:1.0
$ xcock
````

Four jails can open xclock at the same time in a Xnest/Xephyr window on FreeBSD. But the xclock at this time is because there is no window manager, the interface is ugly, and even the minimum drag is impossible. You can do jwm before xclock, as follows.

```sh '
$ export DISPLAY=10.2.2.15:1.0
$jwm &
$ xcock
````

Note here that `jwm & `has been executed once enough, not every jail is required. Here's just the lightweight, xfce and so on. You can try it yourself.

Share host mode

- First on FreeBSD.

```sh '
$xhost+
````

- Close access control:

The following text was then added to the `fstab ' in Jail, where the example of `fstab ' in ubuntu jail is used, and other Jail references are sufficient.

```sh '
/tmp/.X11-unix/usr/jails/ubuntu/tmp/.X11-unix nulfsro 0
````

`mkdir-p/usr/jails/ubuntu/tmp/.X11-unix ' , if necessary, to ensure a mount point.

After restarting jail, execute in jail:

```sh '
DISPLAY = 0.0
$ xcock &
````

The following line appears in the `fstab ' document above

```sh '
#/tmp/usr/jails/ubuntu/tmpnulfs rw 0
````

Although it is written in many curricula, I think it's not safe to say so. If this is the case, the `/tmp ' directory of FreeBSD will be exposed to Jail and, because it is readable: the `/tmp ' directory of FreeBSD can be written in Jail. This undermines the isolation of Jail from FreeBSD and is not safe. Read only `/tmp/.X11-unix ' has greatly improved security.

# X Server tcp Intercept and xhost connection management

I use the sddm desktop manager here, and if you use another desktop manager, please refer to the corresponding desktop manager's document, in the same way.

New `/usr/local/etc/sdm.conf ' (if not) within FreeBSD, amend `Server Arguments ' to read as follows:

```sh '
[X11]
Server Arguments =-listen tcp
````

After restarting, FreeBSD adds the jail IP on to allow access (no root permission required):

```sh '
$ xhost +192.168.5.1 # It is not recommended to close access controls in `xhost + ' to avoid unexpected connections
````

Then in jail, execute:

```sh '
DISPLAY = 0.0
$ xcock &
````

- The `DISPLAY ' has been set here as `0.0 ' , `127.0.0.1: 0.0 ' , `10.0.2.15:0.0 ' , and several of the above methods can be tried together.

# VNC

Install vnc servicer in jail, using tightvnc-server, or tigervnc-server, for example in debian jail, in jail

```sh '
# Aapt install lightvncserver
$ vncpasswd
Password:
Verify:
Would you like to enter a view-only password (y/n)?
A view-only password is not used
$ vncserver: 0 # Also does not require root user, vncserver port number 5900 plus colon number, is now 5900, `1 ' port number 5901, and so on.
````

Use vnc client login

![.. ..gitbook/assets/jailx11vnc1.png]

![.. .gitbook/assets/jailx11vnc2.png]

![.. ..gitbook/assets/jailx11vnc3.png]Remarks

The host X Server tcp intercepts and xhost connection management is one of the least secure, being one of the reasons for the tcp interception default shutdown.

The shared host socket approach notes that the two points mentioned above are safe or secure.

The first four methods are "four writings" and all X Server connections. In addition to the terminal with X Server and the sharing socket, three other ways would be best to fit a desktop inside jail.

The terminals with X Server, shared host socket, vnc are more recommended. Either way, the linux jail doesn't require every X application to run, which is really hard to do, after all, not 100% compatibility, much better if there is freebsd jail.

Except for the shared host socket method, all other methods are non-jail environments that can be applied.


# References

Additional running software and methods are available at [https://wiki.freebsd.org/LinuxApps] (https://wiki.freebsd.org/LinuxApps).

Website:

- [12.2. Configure Linux Binary Compatibility Layer] (https://handbook.bsdcn.org/di-12-zhang-linux-er-jin-zhi-jian-rong-ceng/12.2.-pei-zhi-linux-er-jin-zhi-jian-rong-ceng.html)
- [linux -- Linux ABI support] (https://www.freebsd.org/cgi/man.cgi?linux)
- [wiki/Linuxulator] (https://wiki.freebsd.org/Linuxulator)
- [wiki/Linux Jails] (https://wiki.freebsd.org/Linuxjails)
- [12.3 Linux Userspace] (https://handbook.bsdcn.org/di-12-zhang-linux-er-jin-zhi-jian-rong-ceng/12.3.-linux-yong-hu-kong-jian.html)


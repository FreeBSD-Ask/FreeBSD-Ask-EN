# Section 10.2 Install Windows 11 (vm-bhyve) using bhyve

The following curriculum is based on FreeBSD 14.2 RELEASE + Windows 11 Iot Enterprise LTSC。

# Install solidware and required software

> Windows 11 IoT Enterprise LTSC, version 24H2 (x64) - DVD (English) System Link (from [oh, itelliyou] (https://text.it.itellyou.cn/):
>
> Because the Iot version removes installation restrictions such as TPM, memory size, etc。
>
> SHA256: 4F59662A96FC1DA48C1B415D369D08AF55DD64E8F1C84E0166D9E50405D7A
>
>_CODESPAN_0_

Load kernel modules:

>** Skills**
>
> just this once, and later vm-bhyve will load the module。

```sh
# kldload vmm
```

Inspection:

```sh
# kldstat | grep vmm
 7    1 0xffffffff83320000     44b0 vmmemctl.ko
10    1 0xffffffff83400000   33e438 vmm.ko
```

---|---

First, install UEFI solidware, VNC with vm-bhyve。

- install with pkg:

```sh
# pkg install bhyve-firmware vm-bhyve tigervnc-viewer
```

- Or install with Ports:

```
# cd /usr/ports/sysutils/bhyve-firmware/ && make install clean
# cd /usr/ports/sysutils/vm-bhyve/ && make install clean
# cd /usr/ports/net/tigervnc-viewer/ && make install clean
```

---|---

Specify the location in __CODESPAN_0_ to start vm with the virtual machine:

```sh
vm_enable="YES"
vm_dir="/home/ykla/vm" #注意该位置，以下操作都会用到
```

Create template path:

```sh
# mkdir -p /home/ykla/vm/.templates
```

Copy the template to the virtual machine template position:

```sh
# cp /usr/local/share/examples/vm-bhyve/* /home/ykla/vm/.templates
```

CREATE A VIRTUAL SWITCH, CODESPAN_0, WHICH YOU SPECIFIED IN THE TEMPLATE, CODESPAN_1 IS A WEB CARD I'M USING ON THE INTERNET, AND YOU NEED TO CHANGE IT TO YOUR OWN. OTHERWISE, YOU WILL CREATE A FAILED VIRTUAL MACHINE: CODESPAN_3:

```sh
# vm switch create public
# vm switch add public ue0
```

VIEW NEW __CODESPAN_0_:

```sh
root@ykla:~ # ifconfig

.

vm-public: flags = 1008843 < UP, BROADCAST, RUNING, SIMPLEX, MULTICAST, LOWEER_UP>Metric 0 mtu 1500
options = 0
others 62:bc:e8:9f:f7:e1
id 00:00:00:00:00:00:3000 priority 32768 hellotime 2 fwddelay 15
there's a lot of time left for me to get out of here
root id id 00:00:00:00 00:00, registration 32768 ifcost 0 port 0
== sync, corrected by elderman == @elder_man
if maxadr 0 port 1 priority 128 path cost 20000
_other organiser
nd6 options =9<PERFORMND, IFDISABLED>
````

>** Skills**
>
> If created wrong, it can be destroyed:
>
> ```sh '
# vm switch destroy public
> ````

View assigned virtual switches:

```sh
root@ykla:/usr/home/ykla # vm switch list
NAME    TYPE      IFACE      ADDRESS  PRIVATE  MTU  VLAN  PORTS
public  standard  vm-public  -        no       -    -     ue0
```

For the proper use of xhci mouse in a freeBSD host after 13.0, the driver hms (4) should be used, adding __CODESPAN_0_:

```sh
hw.usb.usbhid.enable=1
usbhid_load="YES"
```

# Configure virtual machine templates

> Note that if you run an old version of Windows 10 or when you want to install Microsoft SQL Server on Windows, you need to set the size of the disk sector to 512 using the parameter __CODESPAN_0。

Creates a window virtual machine based on a template, disk occupied 40GB:

```sh
# vm create -t windows -s 40G winguest
```

>** Skills**
>
> Command to destroy virtual machines:
>
> ```sh '
> root@ykla:/usr/home/ykla #vm
>
> Are you sure you want to fully remove this virtual Machine (y/n)
> ````

NOTE, HOWEVER, THAT THE TEMPLATE IS PROBLEMATIC AND NEEDS TO BE MODIFIED AS FOLLOWS. THE FILE PATH IS __CODESPAN_0_:

> ** Note**
>
> In the old FreeBSD version (formerly FreeBSD 14.0), CODESPAN_0 is the same as if it was softly connected to __CODESPAN_1_。
>
> FreeBSD 14 to drop, no longer soft connection, but direct __CODESPAN_0_。

```sh
loader="uefi" # 不支持 UEFI 的 windows 不能够启动，例如 XP 操作系统，但是请注意 win7 是支持 UEFI 的
graphics="yes" # 指定暂停虚拟机直至 VNC 链接。
xhci_mouse="yes"
cpu=2 # CPU，这个最好多给一些
memory=4G # 内存

# put up to 8 disks on a single heci conseller.
# without this, add a dsk pushes the following network addresses into higher slot numbers,
♪ which reasons wonders to see them as a new interface
"8"

♪ in fact, this should be changed to virtio-net and drivers in the general
# e1,000 works out-of-the-box
webwork0_type= "e1000"
# virtual switch

disk0_type
disk0_name="disk0.img"

# Windows exits the host to expose localtime by default, not UTC
utctime= "no" # Specifies which window uses UTC time to avoid a time difference of 8 hours

graptics_res= "120x1080" # Specifies the screen resolution of the VNC link, with available values listed below
uuid = "af86e094-56da-11ed-958f-20894999cc9"
"58:9c:fc:0c:5e:bb"
root@ykla:/usr/home/ykla#
````


# Install the system

Specifies that Windows iso files start normal installation. When running in installation mode, __CODESPAN_0_ will wait until the VNC client connects to the virtual machine. This allows you to grab any key to Boot from a CD/DVD. As you can see in ___CODESPAN_1_, at this point the virtual machine will be shown as a lock:

```sh
# vm install winguest /home/ykla/en-us_windows_11_iot_enterprise_ltsc_2024_x64_dvd_f6b14814.iso # 替换成你自己的路径
Starting winguest
  * found guest in /home/ykla/vm/winguest
  * booting...
```

Access Win11 from VNC



![.. ..gitbook/assets/win1.png]

WHEN __CODESPAN_0_ APPEARS, PRESS BACK SEVERAL TIMES QUICKLY。

>** Skills**
>
>If you forget to press back to UEFI shell, please stop the virtual machine and re-execut the installation steps above。
>
>! [UEFI shell] (. . . .gitbook/assets/win4.png)

![..gitbook/assets/win2.png]

![.. .gitbook/assets/win3.png]

![.. ..gitbook/assets/win5.png]

Please note that the second sentence should read "Chinese"

![.. ..gitbook/assets/win6.png]

We choose "Simplified, Mainland China"

![..gitbook/assets/win7.png]

START INSTALLATION. VNC CONNECTIONS WILL BE DISCONNECTED SEVERAL TIMES DURING INSTALLATION, AND RECONNECT IS SUFFICIENT。




Opens tigervnc-viewer input __CODESPAN_0_, clicks on the connection, and then press any key to enter the installation。


> Skills
>
>terminator virtual machine: If the virtual machine is jammed to the point that the order is not valid, use `kill -9` to avoid disrupting the machine, and if it really obstructs the physical machine, you can skip the waiting machine by __CODESPAN_1+ `C` at tty and force the shutdown
>
> ```sh '
>root@ykla: ~vm list
>NAME DATASTORE LOADER CPU MEMORY VNC AUTO STATE
>winguest default efi 2 4G 0.0.0.0: 5900 No Running (2072)
>root@ykla:/usr/home/ykla #vm stop winguest
>Sending ACPI shutdown to winguest
> ````
>
> If invalid:
>
> ````
♪ root@ykla: ♪ ps-el
>UID PDID C PRI NI NI VSZ RSS MWCHAN STAT TT TIME COMMAND
> 0 1858 1 68 0 16388 4 Wait IW 3 0:00.00()/bin/sh/usr/local/sbin/vm _run winguest/home/ykla/zh-cn_windows_11_business_editions_version_24h2_x64_dvdd
#kill-9 1858
> ````

# When installed #

![...gitbook/assets/win8.png]

Select "China"。

Once installed, open:

```sh
# vm start winguest
```

OPEN VNC CONNECTION ON IT。

![.. .gitbook/assets/win9.png]

Enter Username

![.. ..gitbook/assets/win10.png]

Enter password

![.. ..gitbook/assets/win11.png]

Repeat Enter Password

![.. ..gitbook/assets/win12.png]

Enter security concerns and repeat three requests for you to set up three different questions。

![.. ..gitbook/assets/win13.png]

Privacy settings. Free to adjust, then click "Accept "

![.. ..gitbook/assets/win14.png]

... it will be updated in the installation, and there may be some way to skip (validated oobe\bypassnro) and the reader is asked to study it。

![.. ..gitbook/assets/win15.png]

![.. ..gitbook/assets/win16.png]

Hanster system:

![.. ..gitbook/assets/win17.png]

![.. ..gitbook/assets/win18.png]

![.. ..gitbook/assets/win19.png]

![.. ..gitbook/assets/win20.png]

![.. .gitbook/assets/win21.png]

![.. ..gitbook/assets/win22.png]

# # troubleshooting and unfinished business

THERE'S A PROBLEM WITH RESTARTING YOUR OWN PHYSICS MACHINE. THERE'S ALSO THE PROBLEM WITH CODESPAN_0, COMPARED TO THE ABOVE, TO SEE IF THERE'S AN EXTRA NET CARD, TO DESTROY IT。

if the virtual machine has been stopped, check your network。

Look at the network. This is virtual

```sh
root@ykla:/usr/home/ykla # ifconfig
alc0: flags=8802<BROADCAST,SIMPLEX,MULTICAST> metric 0 mtu 1500
        options=c319a<TXCSUM,VLAN_MTU,VLAN_HWTAGGING,VLAN_HWCSUM,TSO4,WOL_MCAST,WOL_MAGIC,VLAN_HWTSO,LINKSTATE>
        ether 20:89:82:94:7c:c9
        media: Ethernet autoselect
        nd6 options=29<PERFORMNUD,IFDISABLED,AUTO_LINKLOCAL>
lo0: flags=8049<UP,LOOPBACK,RUNNING,MULTICAST> metric 0 mtu 16384
        options=680003<RXCSUM,TXCSUM,LINKSTATE,RXCSUM_IPV6,TXCSUM_IPV6>
        inet6 ::1 prefixlen 128
        inet6 fe80::1%lo0 prefixlen 64 scopeid 0x2
        inet 127.0.0.1 netmask 0xff000000
        groups: lo
        nd6 options=21<PERFORMNUD,AUTO_LINKLOCAL>
ue0: flags=8943<UP,BROADCAST,RUNNING,PROMISC,SIMPLEX,MULTICAST> metric 0 mtu 1500
        options=8000b<RXCSUM,TXCSUM,VLAN_MTU,LINKSTATE>
        ether f8:e2:3b:3f:ea:4c
        inet 192.168.31.169 netmask 0xffffff00 broadcast 192.168.31.255
        media: Ethernet autoselect (1000baseT <full-duplex>)
        status: active
        nd6 options=29<PERFORMNUD,IFDISABLED,AUTO_LINKLOCAL>
vm-public: flags=8843<UP,BROADCAST,RUNNING,SIMPLEX,MULTICAST> metric 0 mtu 1500
        ether 3a:e1:fa:98:33:b4
        id 00:00:00:00:00:00 priority 32768 hellotime 2 fwddelay 15
        maxage 20 holdcnt 6 proto rstp maxaddr 2000 timeout 1200
        root id 00:00:00:00:00:00 priority 32768 ifcost 0 port 0
        member: ue0 flags=143<LEARNING,DISCOVER,AUTOEDGE,AUTOPTP>
                ifmaxaddr 0 port 3 priority 128 path cost 20000
        groups: bridge vm-switch viid-4c918@
        nd6 options=9<PERFORMNUD,IFDISABLED>
root@ykla:/usr/home/ykla #
```

LOOK AT THE NETWORK. IT'S A VIRTUAL MACHINE. IT'LL COME UP WITH ANOTHER ONE

```sh
tap0: flags=8943<UP,BROADCAST,RUNNING,PROMISC,SIMPLEX,MULTICAST> metric 0 mtu 1500
        description: vmnet/winguest/0/public
        options=80000<LINKSTATE>
        ether 58:9c:fc:10:ff:d6
        groups: tap vm-port
        media: Ethernet autoselect
        status: active
        nd6 options=29<PERFORMNUD,IFDISABLED,AUTO_LINKLOCAL>
        Opened by PID 2519
```



# Optional Configuration

- See all virtuals:


```sh
root@ykla:/usr/home/ykla # vm list
NAME      DATASTORE  LOADER  CPU  MEMORY  VNC  AUTO  STATE
winguest  default    uefi    2    4G      -    No    Stopped
```

- View specified virtual status:

```sh
root@ykla:/usr/home/ykla # vm info winguest
------------------------
Virtual Machine: winguest
------------------------
  state: stopped
  datastore: default
  loader: uefi
  uuid: af86e094-56da-11ed-958f-208984999cc9
  cpu: 2
  memory: 4G

image by flickr-interface
number: 0
eulitude:
i'm sorry, i'm sorry
fixed-mac-address: 58:9c:fc:0c:5e:bb
fixed-device:

virtual-disk
number: 0
data-type: file
hecí-hd
options: -
system-path: /home/ykla/vm/winguest/disk0.img
bytes-size: 42949672960 (40,000 G)
bytes-used: 23557898240 (21.940G)
````


# # VNC CONFIGURATION OPTIONS

IF YOU WANT VNC TO LISTEN TO A SPECIFIC HOST IP ADDRESS, SPECIFY THE FOLLOWING OPTIONS:

```sh
graphics_listen="1.2.3.4"
```

You can also choose a port outside 5900. Obviously, if you have multiple virtual machines, you need a different port number for each virtual machine. If not specified, we will automatically select an available port, starting with 5900:

```sh
graphics_port="5901"
```

BY DEFAULT, THE SCREEN RESOLUTION IS SET TO __CODESPAN_0_. TO SPECIFY OTHER RESOLUTIONS, USE THE FOLLOWING PARAMETERS:

```sh
graphics_res="1600x900"
```

Please note that only the following resolution is currently supported:

```sh
1920x1200
1920x1080
1600x1200
1600x900
1280x1024
1280x720
1024x768
800x600
640x480
```

## Add VirtIO Web Drive

while the network adapter "e1000" is open and allows users to network, it is recommended to use the "virtio-net" device to the extent possible. there are many ways to install these drivers。

- if the machine can access the internet with an e1000 device, you can download and install the virtio drive directly in the virtual machine. once installed, the virtual machine is shut down, the equipment is changed in the virtual machine configuration and restarted。
- Virtual machines can be started in installation mode, but specify the VirtIO ISO file。

```sh
# vm install winguest virtio-installer.iso
```

- YOU CAN ADD CD DEVICES TO VIRTUAL MACHINES AND POINT TO ISO FILES

```sh
disk1_type="ahci-cd"
disk1_dev="custom"
disk1_name="/full/path/to/virtio-installer.iso"
```

ABOUT CPU

Most desktop versions of Windows do not support more than one physical CPU. By default, bhyve configures a single virtual CPU and a single core。

You can modify the sysctl variable __CODESPAN_0_ to tell bhyve to create a multi-core, not a single core for each CPU. For example, setting this sysctl to 4 will configure a virtual machine with 8 CPUs with 2 x 4 cores。

__CODESPAN_0 MUST BE SET IN __CODESPAN_1 (RELAUNCHING CAN ONLY BE EFFECTIVE)。

When using vm-bhyve 1.3 on FreeBSD 12, you can use configuration options to control each virtual CPU popup structure:

```sh
cpu=8
cpu_sockets=2
cpu_cores=4
cpu_threads=1
```

# About NVMe Support

Like FreeBSD 12.1R, bhyve supports simulation of NVMe. For the vm-bhyve configuration, follow the following options:

```sh
disk0_type="nvme"
disk0_name="disk0.img"
disk0_opts="maxq=16,qsz=8,ioslots=1,sectsz=512,ser=ABCDEFGH"
```

You can even install a virtual machine on a physical NVME disk without a virtual disk. The following is an example:

```sh
loader="uefi"
graphics="yes"
xhci_mouse="yes"
cpu=2
ram=8G
network0_type="e1000"
network0_switch="public"
utctime="no"
passthru0="4/0/0"
```

NVME SSD。

Currently, NVMe starts the Windows 8.1 and the updated Windows, and if you want to start Windows 7 from NVME, follow the following steps。

- Installation of Windows 7 virtual machines using the haci-HD controller, as is normal。
- after installation, attach an additional disk1.img to the nvme controller。
- Installation of NVme patches for Microsoft, i.e. __CODESPAN_0 and __CODESPAN_1 to ensure that the NVme controller and disk 1 appear in the virtual device manager of Windows7。
- turning off virtual power, disk0.img and disk1.img in the virtual configuration. start again。
- turn off the virtual power, delete the ahci controller and dissk1.img. leave the nvme controller and disk0.img, start again。

Now Windows 7 Virtual Machine Device Manager only has a nvme controller, no AHCI controller。

# References

- [vm-bhyve/wiki/Running-Windows] (https://github.com/churchers/vm-bhyve/wiki/Running-Windows)
- [The win11 request ISO assesses the emergency-time regedit method]
- [windows 11 on blowve] (https://forums.freebsd.org/threads/windows-11-on-bhyve82371/)
- [FreeBSD, Bhyve me Windows 11]
- [iki/bhyve/Windows] (https://wiki.freebsd.org/bhyve/Windows)
- [churchers/vm-bhyve/wiki] (https://github.com/churchers/vm-bhyve/wiki)
- [Using Windows on FreeBSD's vm-bhyve]



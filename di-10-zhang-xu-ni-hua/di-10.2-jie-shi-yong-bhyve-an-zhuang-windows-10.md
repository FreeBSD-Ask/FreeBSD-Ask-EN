# Section 10.2 Install Windows 11 (vm-bhyve) using bhyve

The following curriculum is based on FreeBSD 14.2 RELEASE + Windows 11 Iot Enterprise LTSC.

# Install solidware and required software

> Windows 11 IoT Enterprise LTSC, version 24H2 (x64) - DVD (English) System Link (from [itellyou] (https://next.itellyou.cn/):
>
> Because the Iot version removes installation restrictions such as TPM, memory size, etc.
>
> SHA256: 4F59662A96FC1DA48C1B415D369D08AF55DD64E8F1C84E0166D9E50405D7A
>
> `magnet: ?xt=urn:btih: 7352bd2db48c3381dffa78377373rdc75a4a6f1cff&dn=en-us_windows_11_iot_interprise_ltsc_ 2024_x64_dvd_f6b14814.iso&xl=51444817664 `

Load kernel modules:

>** Skills**
>
> Just this once, and later vm-bhyve will load the module.

```sh '
# Kldload vmm
````

Inspection:

```sh '
♪ kldstat grep vmm
7 1 0ffffffff 833000 44b0 vmmectl.ko
10 1 0ffffffff83.4000 33e438 vm.ko
````

I don't...

First, install UEFI solidware, VNC with vm-bhyve.

- Install with pkg:

```sh '
# Pkg install hyve-firmware vm-bhyve viewer
````

- Or install with Ports:

````
#cd/usr/ports/sysutils/bhyve-firmware/ & make install clean
#cd /usr/ports/sysutils/vm-bhyve/ & make install clean
#cd/usr/ports/net/tigervnc-viewer/ & make install clean
````

I don't...

Specify the location in `/etc/rc.conf ' to start vm with the virtual machine:

```sh '
"YES"
Vm_dir="/home/ykla/vm"
````

Create template path:

```sh '
#mkdir-p/home/ykla/vm/.templates
````

Copy the template to the virtual machine template position:

```sh '
#cp /usr/local/share/examples/vm-bhyve/*/home/ykla/vm/.templates
````

Create a virtual switch, `public ' , which you specified in the template, `ue0 ' , which is a web card I'm using on the Internet, and you need to change it to your own, or you'll create a failed and false virtual machine: `exit with error 4 ' :

```sh '
♪ I'm switch created public
# I'm switch add public #
````

See new `vm-public ' after creation:

```sh '
# If config

. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .

vm-public: flags = 1008843 < UP, BROADCAST, RUNING, SIMPLEX, MULTICAST, LOWEER_UP>Metric 0 mtu 1500
Options = 0
Others 62:bc:e8:9f:f7:e1
id 00:00:00:00:00:00:3000 Priority 32768 hellotime 2 fwddelay 15
There's a lot of time left for me to get out of here.
root id id 00:00:00:00 00:00, registration 32768 ifcost 0 port 0
== sync, corrected by elderman == @elder_man
If maxadr 0 port 1 priority 128 path cost 20000
_Other Organiser
nd6 options =9<PERFORMND, IFDISABLED>
````

>** Skills**
>
> If created wrong, it can be destroyed:
>
> ```sh '
# vm Switch destroy public
> ````

View assigned virtual switches:

```sh '
Root@ykla:/usr/home/ykla
NAME TYPE IFACE ADDRESS PRIVATE MTU VLAN PORTS
Public standing vm-public
````

For the proper use of xhci mouse in the freeBSD host after 13.0, the driver hms (4) should be used. Add in `/boot/loader.conf ':

```sh '
ww.usb.usbhid.enable=1
"YES."
````

# Configure virtual machine templates

> Note that if you run an old version of Windows 10 or when you want to install Microsoft SQL Server on Windows, you need to use the parameter `disk0_opts= 'sectorsize=512' to set the size of the disk sector to 512.

Creates a window virtual machine based on a template, disk occupied 40GB:

```sh '
?
````

>** Skills**
>
> Command to destroy virtual machines:
>
> ```sh '
> root@ykla:/usr/home/ykla #vm
>
> Are you sure you want to fully remove this virtual Machine (y/n)?
> ````

Note, however, that the template is problematic and needs to be revised as follows: `/home/ykla/vm/winduest/winguest.conf ' :

> ** Note**
>
> In the old FreeBSD version (formerly FreeBSD 14.0), `/home/`is softly connected to `/usr/home/`, same.
>
> FreeBSD 14 to drop, no longer soft connection but direct use of `/home/ ' .

```sh '
Localer= "uefi" # does not support UEFI's Windows cannot start, e. g. XP operating system, but note that the win7 supports UEFI
Graphics = "yes"
Xhci_mouse=yes
cpu=2 # CPU, this better be more.
memory = 4G

# Put up to 8 Disks on a single heci conseller.
# Without this, add a dsk pushes the following network addresses into higher slot numbers,
♪ Which reasons wonders to see them as a new interface
"8"

♪ In fact, this should be changed to virtio-net and drivers in the general
# e1,000 works out-of-the-box
Webwork0_type= "e1000"
# Virtual switch

Disk0_type
Disk0_name="disk0.img"

# Windows exits the host to expose localtime by default, not UTC
utctime= "no" # Specifies which window uses UTC time to avoid a time difference of 8 hours

graptics_res= "120x1080" # Specifies the screen resolution of the VNC link, with available values listed below
uuid = "af86e094-56da-11ed-958f-20894999cc9"
"58:9c:fc:0c:5e:bb"
Root@ykla:/usr/home/ykla#
````


# Install the system

Specifies that Windows iso files start normal installationI don't know. When running in installation mode, `vm-bhyve ' will wait until the VNC client connects to the virtual machine. This allows you to grab any key to Boot from a CD/DVD. You can see in `vm list ' , at which point the virtual machine will be shown as a lock:

```sh '
# vm install winguest / home/ykla/en-us_windows_11_iot_interprise_ltsc_2024_x64_dvd_f6b1414.iso #
Starting winguest
? found in/home/ykla/vm/winguest
? Booting...
````

Access Win11 from VNC



![.. ..gitbook/assets/win1.png]

When `Press any key to Boot from a CD/DVD ' appears, press back several times quickly.

>** Skills**
>
>If you forget to press back to UEFI shell, please stop the virtual machine and re-execut the installation steps above.
>
>! [UEFI shell] (. . . .gitbook/assets/win4.png)

![..gitbook/assets/win2.png]

![.. .gitbook/assets/win3.png]

![.. ..gitbook/assets/win5.png]

Please note that the second sentence should read "Chinese"

![.. ..gitbook/assets/win6.png]

We choose "Simplified, Mainland China"

![..gitbook/assets/win7.png]

Start installation. VNC connections will be disconnected several times during installation, and reconnect is sufficient.




Opens the tigervnc-viewer input `localhost ' , clicks on the connection, and then press any key to enter the installation.


> Skills
>
>Terminating Virtual Machine: If the Virtual Machine is stuck to the order 'kill ' kill-9 ' to avoid disrupting the machine, and if the physical machine is really blocked, you can jump over the waiting machine by `Ctrl ' + `C ' at tty and force it off.
>
> ```sh '
>root@ykla: ~vm list
>NAME DATASTORE LOADER CPU MEMORY VNC AUTO STATE
>winguest default efi 2 4G 0.0.0.0: 5900 No Running (2072)
>root@ykla:/usr/home/ykla #vm stop winguest
>Sending ACPI shutdown to winguest
> ````
>
> If invalid:
>
> ````
♪ root@ykla: ♪ ps-el
>UID PDID C PRI NI NI VSZ RSS MWCHAN STAT TT TIME COMMAND
> 0 1858 1 68 0 16388 4 Wait IW 3 0:00.00()/bin/sh/usr/local/sbin/vm _run winguest/home/ykla/zh-cn_windows_11_business_editions_version_24h2_x64_dvdd
#kill-9 1858
> ````

# When installed #

![...gitbook/assets/win8.png]

Select "China".

Once installed, open:

```sh '
♪ I'm starting winguest ♪
````

Open VNC connection on it.

![.. .gitbook/assets/win9.png]

Enter Username

![.. ..gitbook/assets/win10.png]

Enter password

![.. ..gitbook/assets/win11.png]

Repeat Enter Password

![.. ..gitbook/assets/win12.png]

Enter security concerns and repeat three requests for you to set up three different questions.

![.. ..gitbook/assets/win13.png]

Privacy settings. Free to adjust, then click "Accept "

![.. ..gitbook/assets/win14.png]

... it will be updated in the installation, and there may be some way to skip (validated oobe\bypassnro) and the reader is asked to study it.

![.. ..gitbook/assets/win15.png]

![.. ..gitbook/assets/win16.png]

Hanster system:

![.. ..gitbook/assets/win17.png]

![.. ..gitbook/assets/win18.png]

![.. ..gitbook/assets/win19.png]

![.. ..gitbook/assets/win20.png]

![.. .gitbook/assets/win21.png]

![.. ..gitbook/assets/win22.png]

# # troubleshooting and unfinished business

There's a problem with restarting your own physics machine. There is also the question of `ifconfig ' , compared to the above, to see if there are excess web cards and destroy them.

If the virtual machine has been stopped, check your network.

Look at the network. This is virtual.

```sh '
Root@ykla:/usr/home/ykla #ifconfig
alc0: flags =8802 <BROADCAST, SIMPLEX, MULTICAST >Metric 0 mtu 1500
Options =c319a<TXCSUM, VLAN_MTU, VLAN_HWTAGING, VLAN_HWCSUM, TSO4, WOL_MCAST, WOL_MAGIC, VLAN_HWTSO, LINKSTATE>
Others 20:89:82:94:7c:c9
Media:
nd6 options =29<PERFORMND, IFDISABLED, AUTO_LINKLOCAL>
== sync, corrected by elderman == @elder_man
Options =680003 < RXCSUM, TXCSUM, LINKSTATE, RXCUM_IPV6, TXCSUM_IPV6>
Inet-6-1 prefixlen 128
Inet6fe80: 1%lo0prefixlen 64 standard 0x2
Inet 127.0.0.1 netmask 0xff00000
I'm sorry.
Nd6 options =21 <PERFORMND, AUTO_LINKLOCAL>
ue0: flags=8943<UP, BRODADAST, RUNING, PROMISC, SIMPLEX, MULTICAST>Metric 0 mtu 1500
Options = 8,000b < RXCSUM, TXCSUM, VLAN_MTU, LINKSTATE>
Other f8:e2:3b:3f:ea:4c
Inet. 192.168.319.169 netmask 0xffffff00
Media: Ethernet effect (1000baseT<full-duplex>)
Status: active
nd6 options =29<PERFORMND, IFDISABLED, AUTO_LINKLOCAL>
vm-public: flags=8843<UP, BRODADCAST, RUNING, SIMPLEX, MULTICAST>Metric 0 mtu 1500
Other 3a:e1:fa:98:33:b4
id 00:00:00:00:00:00:3000 Priority 32768 hellotime 2 fwddelay 15
There's a lot of time left for me to get out of here.
root id id 00:00:00:00 00:00, registration 32768 ifcost 0 port 0
== sync, corrected by elderman == @elder_man
If maxadr 0 port 3 priority 128 path cost 20000
_Other Organiser
I don't know6 options = 9 < PERFORMND, IFDISABLED>
Root@ykla:/usr/home/ykla#
````

Look at the network. It's a virtual machine.

```sh '
Tap 0: flags = 8943 < UP, BROADCAST, RUNING, PROMISC, SIMPLEX, MULTIC 0 mtu 1500
Description: vmnet/winguest/0/public
Options = 80000
Other 58:9c:fc:10:ff:d6
Groups: top vm-port
Media:
Status: active
nd6 options =29<PERFORMND, IFDISABLED, AUTO_LINKLOCAL>
Opened by PID 2519
````



# Optional Configuration

- See all virtuals:


```sh '
#vm list
NAME DATASTORE LOADER CPU MEMORY VNC AUTO STATE
I don't think I've ever seen anything like it.
````

- View specified virtual status:

```sh '
root@ykla:/usr/home/ykla #vminfo winguest
- - - - - - - -
Vertual Machine:
- - - - - - - -
State: stopped
datastore:
I don't know.
uuid: f86e094-56da-11ed-958f-20894999cc9
cpu: 2
Memory: 4G

Image by Flickr-interface
Number: 0
Eulitude:
I'm sorry, I'm sorry.
Fixed-mac-address: 58:9c:fc:0c:5e:bb
Fixed-device:

virtual-disk
Number: 0
Data-type: file
Hecí-hd
Options: -
system-path: /home/ykla/vm/winguest/disk0.img
Bytes-size: 42949672960 (40,000 G)
Bytes-used: 23557898240 (21.940G)
````


# # VNC Configuration Options

If you want VNC to listen to a specific host IP address, specify the following options:

```sh '
"1.2.3.4"
````

You can also choose a port outside 5900. Obviously, if you have multiple virtual machines, you need a different port number for each virtual machine. If not specified, we will automatically select an available port, starting with 5900:

```sh '
"5901"
````

By default, the screen resolution is set to `800x600 ' . To specify other resolutions, use the following parameters:

```sh '
"1600x9000"
````

Please note that only the following resolution is currently supported:

```sh '
1920x1200
1920x1080
1600 x 1200
1600 x 900
1280x1024
1280x720
1024x768
800 x 600
640x480
````

## Add VirtIO Web Drive

While the network adapter "e1000" is open and allows users to network, it is recommended to use the "virtio-net" device to the extent possible. There are many ways to install these drivers.

- If the machine can access the Internet with an e1000 device, you can download and install the virtio drive directly in the virtual machine. Once installed, the virtual machine is shut down, the equipment is changed in the virtual machine configuration and restarted.
- Virtual machines can be started in installation mode, but specify the VirtIO ISO file.

```sh '
♪ I'm install winguest virtio-installer ♪
````

- You can add CD devices to virtual machines and point to ISO files

```sh '
Disk1_type= "ahci-cd"
Disk1_dev
disk1_name="/ full/path/to/virtio-insteller.iso"
````

About CPU

Most desktop versions of Windows do not support more than one physical CPU. By default, bhyve configures a single virtual CPU and a single core.

You can modify the sysctl variable `hw.vmm.topology.cores_per_package ' to tell bhyve to create a multi-core, not a single core for each CPU. For example, setting this sysctl to 4 will configure a virtual machine with 8 CPUs with 2 x 4 cores.

`hw.vmm.topology.cores_per_package' must be set in `/boot/loader.conf ' (to be effective only)

When using vm-bhyve 1.3 on FreeBSD 12, you can use configuration options to control each virtual CPU popup structure:

```sh '
cpu = 8
cpu_sockets=2
cpu_cores=4
cpu_threads=1
````

# About NVMe Support

Like FreeBSD 12.1R, bhyve supports simulation of NVMe. For the vm-bhyve configuration, follow the following options:

```sh '
"nvme"
Disk0_name="disk0.img"
Disk0_opts="maxq=16, qsz=8,ioslots=1, sectsz=512, ser=ABCDEFGH"
````

You can even install a virtual machine on a physical NVME disk without a virtual disk. The following is an example:

```sh '
Loader = "uefi"
"Yes."
Xhci_mouse=yes
cpu = 2
Ram = 8G
"E1000"
"public"
utctime is "no."
Passthru0 = "4/0/0"
````

`4/0/0 ' is a straight line NVME SSD.

Currently, NVMe starts the Windows 8.1 and the updated Windows, and if you want to start Windows 7 from NVME, follow the following steps.

- Installation of Windows 7 virtual machines using the haci-HD controller, as is normal.
- After installation, attach an additional disk1.img to the nvme controller.
- installation of nvme patches for Microsoft, i.e. `Windows 6.1-KB2990941-v3-x64.msu ' and `Windows 6.1-KB308773-v2-x64.msu ' to ensure the presence of nvme controllers and disk 1 in the virtual equipment manager of Windows7.
- Turning off virtual power, disk0.img and disk1.img in the virtual configuration. Start again.
- Turn off the virtual power, delete the ahci controller and dissk1.img. Leave the nvme controller and disk0.img, start again.

Now Windows 7 Virtual Machine Device Manager only has a nvme controller, no AHCI controller.

# References

- [vm-bhyve/wiki/Running-Windows] (https://github.com/churchers/vm-bhyve/wiki/Running-Windows)
- [The win11 releasing ISO requires the important-time regedit TPM working around]
- [Windows 11 on Bhyve] (https://forums.freebsd.org/threads/Windows-11-on-bhyve82371/)
- [FreeBSD, Bhyve me Windows 11]
- [iki/bhyve/Windows] (https://wiki.freebsd.org/bhyve/Windows)
- [churchers/vm-bhyve/wiki] (https://github.com/churchers/vm-bhyve/wiki)
- [Using Windows on FreeBSD's vm-bhyve]



# Section 18.2 Treeberry pie set up FreeBSD

FreeBSD support for the architecture is hierarchical, and ARM belongs to the [first-level architecture] (https://www.freebsd.org/platforms/), but the software support is still somewhat weak AMD64, and some software cannot be constructed in source code form through ports.


# Get ready #

All we have to prepare is:

- A berries pie board;
- A line;
- A storage card;
- ** Chosen one**: a CH340 USB truncheon or a 1080P monitor;
- A regular router, no Internet ** not important**;
- If using Windows 10/11 (operating system)
- XShell
- WinSCP (software)

# Basic installation idea #

- Download of mirrors for berry pie at <https://FreeBSD.org>;
- Decompression after download;
- Use [rufus] (https://rufus.ie/zh/) to create a start-up disk;
- Inserting web lines, cards, access monitors, etc.;
- Insert the memory card into the berry pie;
- Holds electricity for about five minutes;

>** Skills**
>
>Recommends a monitor (or ***CH340*** USB thread) to avoid being stuck without knowing that it is still suffering.
>
> - If you use a USB line, make sure to purchase *** CH340*** chips, otherwise there will be problems such as jamming, non-output, non-response of input, failure to drive, incompatibility of Windows 10, etc.
>
> - If you use a monitor, make sure that the screen resolution is not less than 1080 P (1920 x 1080) and the size of the screen should not be less than 8 inches - otherwise the docking and non-connection is an effect. I can only see if it's bright. I can't read it.
>
If you have access to the monitor, try to ensure that both the strawberry pie and the monitor are powered. The monitor can be powered later than the strawberry pie, but it should not be too late.
>
> â€” Attached **CH340** USB Trans-Strait Official Driver Download Address < https://www.wch.cn/download/CH341SER_EXE.html>

- Check the router backstage for IP
- SSH connection.


**Note:** The writing requires that the FAT partition be mounted to replace all the files in it, otherwise the screen will be activated and the replacement file path will be:

<https://github.com/FreeBSD-Ask/FreeBSD-rpi4-Firmware>

# FreeBSD ZFS and berries pie

If the solid is not the latest, use the Raspberry pi to update the solid!

> ** Note**
>
> FreeBSD by default provides an IMG mirror using the UFS file system. Users who want to use ZFS can write the img on the memory card and start it properly. Inserts a U-disk to load the ZFS module. Run command `bsdinstall ' normal installation (place selection U disc) is sufficient. If you want to use ZFS on the memory card, then you can install it with a U-disk.

Prior to installation: (`mmcsd0 ' for storage card, 'da0 ' for U-disk. To create a raspberry-based FreeBSD system in zfs)

Use a normal mirror to write to the memory card and then insert a blank U disk, which will keep the FAT32, MBR partition table.

```sh '
# Gpart show
== sync, corrected by elderman == @elder_man
63 1985 - free - (993K)
2048 102400 1 fat16 [active] (50M)
104448 246835200 2 freebsd (118)
2 246939648 8192 - free - (4.0M)

=0246835200 mmcsd0s2 BSD(118G)
0 128 - free - (64K)
128 230057856 1 freebsd-ufs (110G)
230057984 16777216 2 freebsd-swap (8.0G)

= >63 60088257 da0 MBR (29G)
63 4033 - free - (2.0M)
4096 600844224 1 fat32lba [active] (29G)
````

The zfs module must be loaded first, otherwise the partition will be wrong about `syscl: unknown oid ' vfs.zfs.min_auto_ashit ' .

```sh '
# kldload zfs
````

Start installation:

```sh '
# Bsdinstall
````

Just copy the solid after installation, and be careful not to overwrite the original EFI partition.

After installation:

```sh '
ykla@ykla: $gpart show
= > 34 60088253 da0 GPT (29G)
34 6 - free - (3.0K)
40 532480 1 ms-basic-data (260M)
532520 2008 - free - (1.0M)
534528 4194304 2 freebsd-swap (2.0G)
4728832 55357440 3 freebsd-zfs (26G)
60086272 2015 - free - (1.0M)
````

Then I installed it on the memory card again.

# Berry pie 5

- Berry pie, 5,8G.
- FreeBSD 15.0-CURRENT
- Get on RTL 8156B.
- Start Disk 256G NVME SSD
- UEFI: [rpi5-efi v0.3] (https://github.com/work/rpi5-efi)



>** Warning**
>
>This does not apply to D0 and 16G deposits. Available at <https://rpicn.bsdcn.org>. If you use a new solid, you may need to downgrade to use this paper.

Following testing, Berryberry pies 5 8G was initiated using [UEFI] (https://github.com/workproject/rpi5-uefi), FreeBSD 15.0 (testing example `FreeBSD-15.0-CURRENT-arm64-aarch64-20240628-14ee5324a9b-270986-memstick.img.xx ' ), supporting m2 NVme SSD from storage cards, USB equipment, m2 extension panels (micro-snow [PCI_TO_M_HAT+] (https://www.waveshare.net/wiki/PCIe_TO_M.2_HAT+)], which is also compatible with PCIe 3.0 velocity. However, it is not driven (USB cards can be used with reference to chapter I for specific models). The fan is controlled by the solidware, so the default will keep turning and will not stop. HDMI normal. USB 2/3 is normal. KDE5 has been tested for normal output to the HDMI monitor.


# Berry pie 5 with HAT+

Please confirm whether or not the HAT+ standard is met with the 5-Berry Pie extension currently sold on the market. If it doesn't match, it can usually only get power through PCIe FPC. However, in order to comply with the relevant regulations, the extension plate power demand should be 5V 2A, or 10W.

Berry pie 5 provides not a standard PCIe interface, but a self-designed FPC interface, which requires a switch to connect PCI equipment to the Berry pie 5.

According to the routing code for berry pie 5, the interface can only provide up to 5V 1A, i.e. up to 5W. Therefore, the HAT+ code for the berry pie requires that power should also be obtained from the GPIO interface.

# Berry pie 5 8G compile and install the world and kernel

Example: [FreeBSD 15.0-CURRENT] (https://cgit.freebsd.org/src/committee/?id=fef0e39f64a1db796d8777dbee71fc287f6107) is the default parameter.

> ````
>root@ykla:/usr/src #getrev-parse HEAD
>fef0e39f64a1db796d8777dbee71fc287f6107
> ````

- Compile the world (user space) for approximately 6 hours.

```sh '
--bildworld_epilogue ---
- - - - - - - - - - - - - - - - - - -
World built completed on Tue Aug 6 04:01:22 CST 2024
World built in 21438 seconds, ncpu: 4, make-j4
- - - - - - - - - - - - - - - - - - -
````

- 26 minutes to compile the kernel.

```sh '
- - - - - - - - - - - - - - - - - - -
>Kernel built for GENERIC brought on Tue Aug 6 07:22:22
- - - - - - - - - - - - - - - - - - -
GENERIC built in 1564 seconds, ncpu: 4, make-j4
- - - - - - - - - - - - - - - - - - -
````

# Fragmentation and unfinished business

- `news_msdos /dev/gpt/efiboot0:operation not limited '

This problem occurs mainly in the installation of a system to the U-disk with a zfs memory card, which is currently unsolved and can only be installed with another U-disk starter.

Possible command: `gpart destroy-F da2 ' destroys this wrong step-created document system in order to prevent the system from not being identified.

# References

- [Raspberry Pi Berry Pie Chinese Document] (https://rpicn.bsdcn.org)

# Archive content (old but probably still useful)

FreeBSD andberry pie 4B 8G failed

Replace FAT partition content with downloading FreeBSD 14 mirrors if it does not start (the default partition is hidden, use disskgenius to activate the hidden partition distribution disc)

<https://github.com/FreeBSD-Ask/FreeBSD-rpi4-Firmware>

Amend `config.txt ' to read as follows:

```sh '
Arm_64bit=1
dToverlay=disable-bt
dToverlay=mmc
= 0x4000
Kernel=u-boot.bin
Armstub=armstub8-gic.bin
hdmi_safe=0
# Overfrequency
Arm_freq=2000
Over_voltage=6
````

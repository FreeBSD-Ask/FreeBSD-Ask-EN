# Section 18.2 Treeberry pie set up FreeBSD

FreeBSD ' s support for the architecture is hierarchical, and ARM belongs to [Level I regulation] (https://www.freebsd.org/platforms/), but software support is still somewhat weak AMD64, and some software cannot be constructed in source code by ports。


# Get ready #

All we have to prepare is:

- A berries pie board
- A line
- A storage card
- ** CHOSEN ONE**: A CH340 USB TRUNCHEON OR A 1080P MONITOR
- A regular router, no Internet ** not important**
- If using Windows 10/11 (operating system)
- XShell
- WinSCP (software)

# Basic installation idea #

- Download of mirrors for berry pie at <https://FreeBSD.org>
- Decompression after download
- use [rufus] (https://rufus.ie/zh/) to create a start-up disk
- Inserting web lines, cards, access monitors, etc.
- Insert the memory card into the berry pie
- Holds electricity for about five minutes

>** Skills**
>
>RECOMMENDS A MONITOR (OR ***CH340*** USB THREAD) TO AVOID BEING STUCK WITHOUT KNOWING THAT IT IS STILL SUFFERING。
>
> - If you use a USB line, make sure to purchase *** CH340*** chips, otherwise there will be problems such as jamming, non-output, non-response of input, failure to drive, incompatibility of Windows 10, etc
>
> - If you use a monitor, make sure that the screen resolution is not less than 1080 P (1920 x 1080) and the size of the screen should not be less than 8 inches - otherwise the docking and non-connection is an effect. I can only see if it's bright. I can't read it。
>
If you have access to the monitor, try to ensure that both the strawberry pie and the monitor are powered. The monitor can be powered later than the strawberry pie, but it should not be too late。
>
> — Attached **CH340** USB Trans-Strait Official Driver Download Address < https://www.wch.cn/download/CH341SER_EXE.html>

- CHECK THE ROUTER BACKSTAGE FOR IP
- SSH CONNECTION。


**NOTE:** THE WRITING REQUIRES THAT THE FAT PARTITION BE MOUNTED TO REPLACE ALL THE FILES IN IT, OTHERWISE THE SCREEN WILL BE ACTIVATED AND THE REPLACEMENT FILE PATH WILL BE:

<https://github.com/FreeBSD-Ask/FreeBSD-rpi4-Firmware>

# FreeBSD ZFS and berries pie

If the solid is not the latest, use the Raspberry pi to update the solid

> ** Note**
>
> FreeBSD by default provides an IMG mirror using the UFS file system. Users who want to use ZFS can write the img on the memory card and start it properly. Inserts a U-disk to load the ZFS module. Run command __CODESPAN_0_ Normal installation (place selection U disk) is sufficient. If you want to use ZFS on the memory card, then you can install it with a U-disk。

Before installation: __CODESPAN_0_is a memory card, __CODESPAN_1_is a U-disk. To create a raspberry-based FreeBSD system in zfs)

USE A NORMAL MIRROR TO WRITE TO THE MEMORY CARD AND THEN INSERT A BLANK U DISK, WHICH WILL KEEP THE FAT32, MBR PARTITION TABLE。

```sh
# gpart show
=>       63  246947777  mmcsd0  MBR  (118G)
         63       1985          - free -  (993K)
       2048     102400       1  fat16  [active]  (50M)
     104448  246835200       2  freebsd  (118G)
  246939648       8192          - free -  (4.0M)

=0246835200 mmcsd0s2 BSD(118G)
0 128 - free - (64K)
128 230057856 1 freebsd-ufs (110G)
230057984 16777216 2 freebsd-swap (8.0G)

= >63 60088257 da0 MBR (29G)
63 4033 - free - (2.0M)
4096 600844224 1 fat32lba [active] (29G)
````

The zfs module must be loaded first, otherwise the partition will be wrong __CODESPAN_0_ or something。

```sh
# kldload zfs
```

Start installation:

```sh
# bsdinstall
```

JUST COPY THE SOLID AFTER INSTALLATION, AND BE CAREFUL NOT TO OVERWRITE THE ORIGINAL EFI PARTITION。

After installation:

```sh
ykla@ykla:~ $ gpart show
=>      34  60088253  da0  GPT  (29G)
        34         6       - free -  (3.0K)
        40    532480    1  ms-basic-data  (260M)
    532520      2008       - free -  (1.0M)
    534528   4194304    2  freebsd-swap  (2.0G)
   4728832  55357440    3  freebsd-zfs  (26G)
  60086272      2015       - free -  (1.0M)
```

Then I installed it on the memory card again。

# Berry pie 5

- BERRY PIE, 5,8G
- FreeBSD 15.0-CURRENT
- GET ON RTL 8156B
- Start Disk 256G NVME SSD
- UEFI: [rpi5-efi v.3] (https://github.com/work/rpi5-efi)



>** Warning**
>
>This does not apply to D0 and 16G deposits. Available at <https://rpicn.bsdcn.org>. If you use a new solid, you may need to downgrade to use this paper。

Following testing, the berries pie 5 8G was activated using [UEFI] [https://github.com/workproject/rpi5-uefi), FreeBSD 15.0 (test example `FreeBSD-15.0-CURRENT-arm64-aarch64-20240628-14fee5324a9b-270986-memstick.img.xz`), support from storage cards, USB equipment, m2 extension panels (micro-screech [PCIe_TO_M.2_HAT+] (https://www.waveshare.net/wiki/PCIe_TO_M2_HAT+), which is also compatible with PCIE 3.0.0. However, it is not driven (USB cards can be used with reference to chapter I for specific models). The fan is controlled by the solidware, so the default will keep turning and will not stop. HDMI normal. USB 2/3 is normal. KDE5 has been tested for normal output to the HDMI monitor。


# BERRY PIE 5 WITH HAT+

Please confirm whether or not the HAT+ standard is met with the 5-Berry Pie extension currently sold on the market. If it doesn't match, it can usually only get power through PCIe FPC. However, in order to comply with the relevant regulations, the extension plate power demand should be 5V 2A, or 10W。

Berry pie 5 provides not a standard PCIe interface, but a self-designed FPC interface, which requires a switch to connect PCI equipment to the Berry pie 5。

ACCORDING TO THE ROUTING CODE FOR BERRY PIE 5, THE INTERFACE CAN ONLY PROVIDE UP TO 5V 1A, I.E. UP TO 5W. THEREFORE, THE HAT+ CODE FOR THE BERRY PIE REQUIRES THAT POWER SHOULD ALSO BE OBTAINED FROM THE GPIO INTERFACE。

# BERRY PIE 5 8G COMPILE AND INSTALL THE WORLD AND KERNEL

Example: [FreeBSD 15.0-CURRENT] (https://cgit.freebsd.org/src/committee/?id=fef0e39f64a1db796d8777dbee71fc287f6107) is the default parameter。

> ````
>root@ykla:/usr/src #getrev-parse HEAD
>fef0e39f64a1db796d8777dbee71fc287f6107
> ````

- Compile the world (user space) for approximately 6 hours。

```sh
--- buildworld_epilogue ---
--------------------------------------------------------------
>>> World build completed on Tue Aug  6 04:01:22 CST 2024
>>> World built in 21438 seconds, ncpu: 4, make -j4
--------------------------------------------------------------
```

- 26 minutes to compile the kernel。

```sh
--------------------------------------------------------------
>>> Kernel build for GENERIC completed on Tue Aug  6 07:22:22 CST 2024
--------------------------------------------------------------
>>> Kernel(s)  GENERIC built in 1564 seconds, ncpu: 4, make -j4
--------------------------------------------------------------
```

# Fragmentation and unfinished business

- CODESPAN_0_

This problem occurs mainly in the installation of a system to the U-disk with a zfs memory card, which is currently unsolved and can only be installed with another U-disk starter。

POSSIBLE COMMAND: __CODESPAN_0_ DESTROYS THE FILE SYSTEM CREATED BY THIS ERROR IN ORDER TO PREVENT THE SYSTEM FROM NOT BEING IDENTIFIED。

# References

- [Raspberry Pi Perry Pi China Document]

# Archive content (old but probably still useful)

FreeBSD andberry pie 4B 8G failed

Replace FAT partition content with downloading FreeBSD 14 mirrors if it does not start (the default partition is hidden, use disskgenius to activate the hidden partition distribution disc)

<https://github.com/FreeBSD-Ask/FreeBSD-rpi4-Firmware>

AMEND ___CODESPAN_0 TO READ AS FOLLOWS:

```sh
arm_64bit=1
dtoverlay=disable-bt
dtoverlay=mmc
device_tree_address=0x4000
kernel=u-boot.bin
armstub=armstub8-gic.bin
hdmi_safe=0
force_turbo=0 # 超频
arm_freq=2000 # 超频
over_voltage=6 # 超频
```

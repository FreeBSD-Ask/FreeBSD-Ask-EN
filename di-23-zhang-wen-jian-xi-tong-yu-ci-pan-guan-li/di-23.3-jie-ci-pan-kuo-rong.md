# Section 23.3 Disk amplification

>** Warning**
>
>ZFS AND UFS CAN ONLY EXPAND AND NOT SHRINK

# ZFS DISK AMPLIFICATION


```sh
root@ykla:~ # gpart show
=>       40  167772087  nda0  GPT  (80G)
         40     532480     1  efi  (260M)
     532520       1024     2  freebsd-boot  (512K)
     533544        984        - free -  (492K)
     534528    4194304     3  freebsd-swap  (2.0G)
    4728832  142071775     4  freebsd-zfs  (68G)
  146800607   20971520        - free -  (10G)
```

AS YOU CAN SEE, __CODESPAN_0_EMPTY SPACE IS 10GB。

Selecting the expansion of Division 4:

```sh
root@ykla:~ # gpart resize -i 4 nda0
nda0p4 resized
```

Look again:

```sh
root@ykla:~ # gpart show
=>       40  167772087  nda0  GPT  (80G)
         40     532480     1  efi  (260M)
     532520       1024     2  freebsd-boot  (512K)
     533544        984        - free -  (492K)
     534528    4194304     3  freebsd-swap  (2.0G)
    4728832  163043295     4  freebsd-zfs  (78G)
```


```sh
root@ykla:~ # zpool list
NAME    SIZE  ALLOC   FREE  CKPOINT  EXPANDSZ   FRAG    CAP  DEDUP    HEALTH  ALTROOT
zroot  67.5G  2.20G  65.3G        -         -     2%     3%  1.00x    ONLINE  - # 这里看到还是 67.5G 没有扩容
root@ykla:~ # zpool status
  pool: zroot
 state: ONLINE
status: Some supported and requested features are not enabled on the pool.
	The pool can still be used, but some features are unavailable.
action: Enable all features using 'zpool upgrade'. Once this is done,
	the pool may no longer be accessible by software that does not support
	the features. See zpool-features(7) for details.
config:

	NAME        STATE     READ WRITE CKSUM
	zroot       ONLINE       0     0     0 # 可以看到池名是默认的 zroot
	  nda0p4    ONLINE       0     0     0 # 这里看到是 nda0p4

no known data officers
````

extended zfs pool:

```sh
root@ykla:~ #  zpool online -e zroot nda0p4
```

After looking at the amplification:

```sh
root@ykla:~ # zpool list
NAME    SIZE  ALLOC   FREE  CKPOINT  EXPANDSZ   FRAG    CAP  DEDUP    HEALTH  ALTROOT
zroot  77.5G  2.20G  75.3G        -         -     2%     2%  1.00x    ONLINE  -
```

Extension completed。

References

- [Solved-extend ZFS Party] (https://forums.freebsd.org/threads/extend-zfs-Partition555964)

# UFS DISK AMPLIFICATION



- __CODESPAN_0_ VIEW DISK PARTITION

```sh
root@freebsd:~ # gpart show
=>       3  41943035  da0  GPT  (20G)
         3       122    1  freebsd-boot  (61K)
       125     66584    2  efi  (33M)
     66709   2097152    3  freebsd-swap  (1.0G)
   2163861  10486633    4  freebsd-ufs  (5.0G)
  12650494  29292544       - free -  (14G)
```

VIEW THE SYSTEM DISK SIZE IS ONLY 5G, SHOWING ___CODESPAN_0_ ONLY THIS ONE。

- Execute the amplification order

> ** Warning**
>
>IF YOU USE A GPT PARTITION TABLE, THE UPPER EXPANSIVE OPERATION (** ON A VIRTUAL MACHINE OR CLOUD SERVER**) WILL DAMAGE THE GPT PARTITION TABLE, SO IT NEEDS TO BE RESTORED:
>
> ```sh '
> #gpart cover da0
> ````
>
> The next steps after implementation are the same。

___ CODESPAN_0 __ IS FOR THE EXPANSION OF THE ___ CODESPAN_1 __。

```sh
root@freebsd:~ #  gpart resize -i 4 da0
da0p4 resized
```

- START __CODESPAN_0_SERVICE, AUTO-EXPAND EXTENSION

```sh
root@freebsd:~ # service growfs onestart
Growing root partition to fill device
da0 recovering is not needed
da0p4 resized
growfs: no room to allocate last cylinder group; leaving 7.7MB unused
super-block backups (for fsck_ffs -b #) at:
 11544384, 12827072, 14109760, 15392448, 16675136, 17957824, 19240512, 20523200, 21805888, 23088576, 24371264,
 25653952, 26936640, 28219328, 29502016, 30784704, 32067392, 33350080, 34632768, 35915456, 37198144, 38480832
```

- VIEW THE RESULTS WITH __CODESPAN_0_。

```sh
root@freebsd:~ # df -hl
Filesystem         Size    Used   Avail Capacity  Mounted on
/dev/gpt/rootfs     18G    4.8G     12G    29%    /
devfs              1.0K      0B    1.0K     0%    /dev
/dev/gpt/efiesp     32M    651K     31M     2%    /boot/efi
tmpfs               20M    4.0K     20M     0%    /tmp
tmpfs               32M    156K     32M     0%    /var
```

Divisional expansion completed。

# Appendix

**TECHNOLOGY: ** PARTITION NUMBER CAN BE VIEWED WITH A SPECIFIC NAME AFTER __CODESPAN_0, OR USING PARAMETERS __CODESPAN_1_:

```sh
root@ykla:~ # gpart show -p
=>       40  244277168    mmcsd0  GPT  (116G)
         40     532480  mmcsd0p1  efi  (260M)
     532520       2008            - free -  (1.0M)
     534528  243740672  mmcsd0p2  freebsd-zfs  (116G)
  244275200       2008            - free -  (1.0M)

=34 976773101 nda0 GPT (466G)
34 6 - free - (3.0K)
40 567256 nda0p1 efi (277M)
567296 419436064 nda0p2 ms-basic-data (200G)
420003360 310592132 nda0p3 ms-basic-data (148G)
730595492 4 - Free - (2.0K)
730595496 177626968 nda0p4 ms-basic-data (85G)
908222464 67100672 nda0p5 freebsd-swap (32G)
975323136 1445937 nda0p6 ms-recovery (706M)
976769073 4062 - free - (2.0M)
````

- PRINT PARTITION TYPE GUID
(IF GPT) OR ORIGINAL PARTITION TYPE (MBR)

```sh
root@ykla:~ # gpart show -rp
=>       40  244277168    mmcsd0  GPT  (116G)
         40     532480  mmcsd0p1  c12a7328-f81f-11d2-ba4b-00a0c93ec93b  (260M)
     532520       2008            - free -  (1.0M)
     534528  243740672  mmcsd0p2  516e7cba-6ecf-11d6-8ff8-00022d09712b  (116G)
  244275200       2008            - free -  (1.0M)

=34 976773101 nda0 GPT (466G)
34 6 - free - (3.0K)
40 567256 nda0p1 c12a7328-f81f-11d2-ba4b-00a0c93ec93b (277M)
567296 419436064 nda0p2 ebd0a0a2-b9e5-4433-87c0-68b6b72699c7 (200G)
420003360 310592132 nda0p3 ebd0a0a2-b9e5-4433-87c0-68b6b72699c7 (148G)
730595492 4 - Free - (2.0K)
730595496 177626968 nda0p4 ebd0a0a2-b9e5-4433-87c0-68b6b72699c7 (85G)
908222464 67100672 nda0p5 516e7cb5-6ecf-11d6-8ff8-00022d09712b (32G)
9753136 14459336 nda0p6 de94bba4-06d1-4d40-a16a-bfd50179d6ac (706M)
976769073 4062 - free - (2.0M)
````

- View details:

```sh
# gpart list mmcsd0
```

References

- [GPT PARTITON DETAIL] (https://www.jinbuguo.com/storage/gpt.html), GPT Basics
- [HOW EASY TO CHANGE THE TYPE OF PARTITON ID? TRY THIS TWO WAYS] (https://www.disktool.cn/content-center/change-partner-type-id-211.1.html), which is not clear from the division type ID and division UUID. {\i1 \cH30D3F4}When it's old, people who've installed black apples should have set excessive zone type ID

ABOUT UFS

UFS is fully known as UNIX File System, a UNIX file system based on UNIX v7. In the past, MacOS used the file system as a root file system. FreeBSD is currently using UFS2. Linux's reading and writing support for UFS is also incomplete. This file system can only be expanded and cannot be reduced。

> ** Note**
>
The UFS storage used in devices such as > UFS file systems and mobile phones is not the same, and the UFS is an abbreviation of the Universal Flash Store, which is already available at 4.0 (FreeBSD supports eMC in 10.4; the UFS appears in FreeBSD 15.0 development plan and is not yet supported). The UFS version number as a file system is only 2. Also, the system inside the cell phone is not likely to be a UFS file system, because Anzor, based on Linux, does not support UFS at all, and the general root file system for these devices is ext.4 (some new devices are F2FS)。

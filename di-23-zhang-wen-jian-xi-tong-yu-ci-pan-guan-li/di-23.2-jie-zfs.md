# Section 23.2 ZFS

Currently ZFS is almost open and does not need additional configuration.

# ZFS compression

View the default compression format for FreeBSD 14:

```sh '
# zfs get communication
NAME PROPERTY VALUE SOURCE
Zroot company lz4 local
Zroot/ROOT company lz4 incorporated from zroot
Zroot/ROOT/default communication lz4 incorporated from zroot
Zroot/ home company lz4 incorporated from zroot
Zroot/home/ ykla company lz4 from zroot
Zroot/tmp company lz4 incorporated from zroot
Zroot/usr company lz4 incorporated from zroot
Zroot/usr/ports communication nz4 incorporated from zroot
Zroot/usr/src company lz4 incorporated from zroot
Zroot/var company lz4 incorporated from zroot
Zroot/var/udit communication lz4 incorporated from zroot
Zroot/var/crash company lz4 incorporated from zroot
Zroot/var/log company lz4 incorporated from zroot
Zroot/var/mail company lz4 incorporated from zroot
Zroot/ var/tmp company lz4 incorporated from zroot
````

Replace zstd with:

```sh '
Root@ykla:/home/ykla
````

View after restarting:

```sh '
# zfs get company
NAME PROPERTY VALUE SOURCE
Zroot company zstd-5 local
Zroot/ROOT company zstd-5 occupied from zroot
Zroot/ROOT/default communication zstd-5 from zroot
Zroot/ home company zstd-5 occupied from zroot
Zroot/home/ykla company zstd-5 from zroot
Zroot/tmp company zstd-5 occupied from zroot
Zroot/usr company zstd-5 occupied from zroot
Zroot/usr/ports communication zstd-5 from zroot
Zroot/usr/src company zstd-5 from zroot
Zroot/var company zstd-5 occupied from zroot
Zroot/var/udit communication zstd-5 occupied from zroot
Zroot/var/crash communication zstd-5 from zroot
Zroot/var/log COMMENT zstd-5 occupied from zroot
Zroot/var/mail permission zstd-5 occupied from zroot
Zroot/var/tmp company zstd-5 from zroot
````

View actual compression rate:

```sh '
# zfs get company
NAME PROPERTY VALUE SOURCE
Zroot compressortio 2.70x-
Zroot/ROOT Compressory 2.68x-
Zroot/ROOT/defaultcompressortio 2.68x-
Zroot/ home company 1.00x-
Zroot/home/ykla compressratio 1.0x-
Zroot/tmp Compressory 1.00x-
Zroot/usr compressratio 2.73x-
Zroot/usr/portscompressortio 1.00x-
Zroot/usr/src compressratio 2.73x-
Zroot/var Compressortio 1.47x-
Zroot/var/uditcompressratio 1.00x-
Zroot/var/crash compressortio 1.0x-
Zroot/var/log Compressory 2.90x-
Zroot/var/mail company 1.00x-
Zroot/var/tmp Compressory 1.00x-
````

# ZFS pics and returns

ZFS snapshots are similar to virtual.

- Create a snapshot.

Default creation of partition (`Auto ZFS ' ) as follows:

```sh '
# zfs list
NAME USED AVAIL REFER MOUNTPOINT
Zroot 1.72G 440G 96K/zroot
Zroot/ROOT 1004M 440G 96K none
Zroot/ROOT/default 1004M 440G 1004M /
zroot/tmp 104K 440G 104K/tmp
Zroot/usr 760M 440G 96K/usr
Zroot/usr/home 128K 440G 128K/usr/home
Zroot/usr/ports 96K 440G 96K/usr/ports
440G 759M/usr/src
Zroot/var 628K 440G 96K/var
Zroot/var/udit 96K 440G 96K/var/udit
Zroot/var/crash 96K 440G 96K/var/crash
Zroot/var/log 148K 440G 148K/var/log
Zroot/var/mail 96K 440G 96K/var/mail
zroot/var/tmp 96K 440G 96K/var/tmp
````

Snapshot `zroot ' (tested to represent the entire ZFS file system under the default partition mentioned above, `-r ' is re-created, `test ' is a random name):

```sh '
Root@ykla:/home/ykla
Root@ykla:/home/ykla
NAME USED AVAIL REFER MOUNTPOINT
Zroot
Zroot/ROOT@test 0B - 96K -
Zroot/ROOT/default
Zroot/tmp
Zroot/usr
Zroot/usr/home
Zroot/usr/ports@test 0B - 1.98G -
Zroot/var
Zroot/var/log
Root@ykla:/home/ykla#ls/usr/ports/
CHANGES Archivers/ emulators/misc/ textproc/
CONTRIBUTIING.md astro/finance/multimedia/ ukrainian/
COPYRIGHT audio/ french/ net-im/ vietnamese/
GIDs base/ ftp/ net-mgmt/ www/
INDEX-13 benchmarks/games/net-p2p/x11-locks/
Keywords/biology/german/ net/ x11-drivers/
MVED cad/graphics/news/ x11-fm/
Makefile Chinese/hebrew/olish/ x11-fonts/
Mk/comms/hungarian/ports-mgmt/ x11-servers/
README converts/ irc/ portuguese/ x11-themes/
Templates/datas/ japanese/print/ x11-toolkits/
Tools/ deskutils/ java/ russian/ x11-wm/
UIDs devel/ korean/ science/ x11/
UPDATTING files/long/ security/
Accessibility/ dns/ mail/shells/
@arbic/ editos/math/ sysutils/
Root@ykla:/home/ykla #rm/usr/ports/
````

- Revert.

The original snapshot cannot be returned at the time of its restoration and must be returned to each other (if you have a better solution, please tell us that there are some scripts available on the web):

Unlike virtual snapshots, in the default case, the `zfs rollback ' order cannot roll back to a snapshot other than the latest one (https://docs.oracle.com/cd/E19253-01/819-7065/gbck/index.html), unless the `r ' is used, but this removes all the snapshots created.

```sh '
Root@ykla:/home/ykla
Root@ykla:/home/ykla
Root@ykla:/home/ykla
Root@ykla:/home/ykla
Root@ykla:/home/ykla
Root@ykla:/home/ykla #zfs rollback-r zroot/usr/home@test
Root@ykla:/home/ykla
Root@ykla:/home/ykla
Root@ykla:/home/ykla
````

- Destroy the snapshot.

Destruction of snapshots (use of `r ' recursive destruction when destroyed):

```sh '
Root@ykla:/home/ykla
Root@ykla:/home/ykla
No data available
Root@ykla:/home/ykla#

````

> `snapshot ' can be abbreviated in the order as `snap ' .


# Start environment

What is a start-up environment? Combine with snapshot and rollback, which is equivalent to jump-up at a time. A start-up environment is equivalent to a time line, a copy of a start-up environment is equivalent to another time line (the two start-up environments after the copy are independent of each other) and the switch between the start-up environments is the passage of two time lines (or parallel space). `zroot/ROOT/default ' is the default start-up environment.

```sh '
# zfs snap zroot/ ROOT/default@new
# zfs clean zoot/ROOT/default@new zoot/ROOT/new
````

Duplicate mirrors can be used as a startup environment to view available startup environments with `bectl ' tools

```sh '
# Bectl list
Be Active Mountain Space Created
0915 - 4.00M 2023-09-19:44
13.2-RELEASE-p2_2023-09-13_14111 - 29.0M 2023-09-13:14:11
New - 432K 2023-09-20:17
2023-04-10:06
````

In the column `Active ' , `N ' indicates the current use environment and `R ' indicates the environment to be used at the next start. `bectl ' tools can change the next start-up environment (check `8 ' in the start-up menu at the start of FreeBSD, or change the start-up environment)

```sh '
Now, bectl activate new
It's just that it's been a long time.
````

View again with `bectl list ' and observe changes in the Active column

```sh '
Bectloh, listen.
Be Active Mountain Space Created
0915 - 4.00M 2023-09-19:44
13.2-RELEASE-p2_2023-09-13_14111 - 29.0M 2023-09-13:14:11
New R / 2.84M 2023-09-2015:17
Despite N-40.8G 2023-04-10:06
````

Restart FreeBSD (select the `new 'start environment in the start menu, or switch to the new start environment with `bectl action new ' above) and watch with `df ' that the mounted root directory file system is already `zroot/ ROOT/new '

```sh '
♪ df
A few days ago, a few years ago, a few days ago, a few days ago, a few days later, a few days later, a few days ago, a few days ago, a few days later, a few days later, a few days later, a few days later, a few days ago, I've had to go by.
Zroot/ROOT/new 110611616 42612156 67999460 39% /
Devfs 1 1 0 100% /dev
/dev/gpt/efiboot0 266176 1872 264304 1% /boot/efi
fdescfs 1 0 100% /dev/fd
````

Switch back to the `zroot/ROOT/default 'start environment, select the default start environment in the start menu, or switch to default as above to start environment

Expansion: A start-up environment can be upgraded to FreeBSD 14, with 13, 14 versions of co-existence.

>** Warning**
>
>The cost of using extension is that zfs cannot upgrade: the upgrade hangs up as soon as it is upgraded because the old version of the ZFS is not re-compatible backwards. Practice is of little significance and can be used only as a backup.

References

- [wiki/BootEnvirons] (https://wiki.freebsd.org/BootEnvirons)

# FreeBSD zfs zpool upgrade

13.2 To 14.0, the zpool version has been upgraded.

This assumes that `freebsd-update ' has been upgraded from 13.2 to 14.0.

Pre-start alert: Prepare to livecd for accident, livecd for 14.0 and above, 13.2 does not support the zfs (not able to access new zfs file system) 14.0.

View `zpool ' status:

```sh '
#zpool status

I'm sorry.
stat state: ONLINE
Some supported and relisted oceans are not available on the wall.
The poor can still be used, but some fishes are unviable.
Once this is done,
That does not support
See zpool-features (7) for details.
Config:

NAME STATE READ WRITE CKSUM
Zroot ONLINE 0 0 0
A da0p3 ONLINE 0 0 0

No known data officers
````

None of the zfs' new features could be used before being upgraded. The following upgrades are made:

```sh '
@u13t14 #zpool upgrad zroot

This system supplies ZFS room safe flags.

Allowed the following impacts on 'zroot':
edonr
zilsaxattr
Head_errlog
blake3
Block_cloning
vdev_zaps_v2

Pool 'zroot' has the Boots policy set, you might need to update
See gptzfsboot (8) and loader.efi (8) for details.
````

# # rewrite guide (not EFI only)

>** Warning**
>
> `bootfs ' property is an important sign for guiding FreeBSD on zfs, and it may be okay to ignore this hint, but it is not possible to direct the system when there is a problem, and it is suggested that the `boot code ' be rewritten as a hint (why so? ~ because I blew up ~). If you don't have the **freebsd-boot** partition, ** do not need** the following operation.

View partition information:

```sh '
#Gpart show

=40 33554352 ada0 GPT (16G)
40 1024 1 freebsd-boot (512K)
1064 984 - free - (492K)
2048 4194304 2 freebsd-swap (2.0G)
4196352 29356032 3 freebsd-zfs (14G)
3355384 2008 - free - (1.0M)
````

Found a `freebsd-boot ' type partition with the serial number `1 ' corresponding to the `-i ' option in the following command and recapitulating `bootcode ':

```sh '
Root@u13t14 #gpartbootcode-p/boot/gptzfsboot-i 1 aada0
Partcode write to aada0p1
````

See `zpool ' status again:

```sh '
#zpool status

I'm sorry.
stat state: ONLINE
Config:

NAME STATE READ WRITE CKSUM
Zroot ONLINE 0 0 0
A da0p3 ONLINE 0 0 0

No known data officers
````

# User-level zfs administration

zfs allows non-privileged users to manage.

From FreeBSD 14.1 by (please refer to the distribution instructions, as modified by [this] (https://cgit.freebsd.org/src/committee/?id=516009ce8d38)), `bsdinstall (8) `adduser (8) ' : When the parent directory of the user ' s home directory is on the zfs data set (i.e. if `home ' is a zfs data set, `/home/xx ' ), a zfs data set will be created for the user ' s home directory. The parameter `adduser ' may be disabled. `adduser ' is also available for non-privileged user home directory encryption for zfs.

The following operation is based on `FreeBSD 14.1-RELEASE ' .

# # base user-level zfs administration

Let's start with the zfs data set for unprivileged users.

When we first installed the system, we created two ordinary users, “aria2” and “safreya”.

```sh '
%zfs list
NAME USED AVAIL REFER MOUNTPOINT
Zroot 53.7G 396G 96K/zroot
Zroot/ROOT 12.8G 396G 96K none
Zroot/ROOT/14.1-RELEASE-p3_2024-09-17_194642 8K 396G11.6G /
Zroot/ROOT/default 12.8G 396G 11.9G /
Zroot/aria2187M 396G 187M/usr/local/data/ria2
Zroot/home 7.74G 396G 96K/home
Zroot/home/ria2 128 K 396G 128K/home/aria2 #Note this trip
Zroot/home/safreya 7.74G 396G 7.70G/home/safreya #please note this trip
Zroot/jails 3.12G 396G 3.12G /usr/jails
Zroot/sec 28.5G 396G 28.5G /usr/local/data/sec
Zroot/tmp 102M 396G 102M /tmp
Zroot/usr 1.34G 396G 96K /usr
Zroot/usr/ports 1.34G 396G 1.34G/usr/ports
Zroot/usr/src 96K 396G 96K/usr/src
Zroot/var 1.58M 396G 96K/var
Zroot/var/udit 96K 396G 96K/var/udit
Zroot/var/crash 96K 396G 96K/var/crash
Zroot/var/log 1.1.2M 396G 1.1.2M/var/log
Zroot/var/mail 168K 396G 168K/var/mail
Zroot/var/tmp 120K 396G 120K/var/tmp
Safreya ~ %
````

Of which:

```sh '
Zroot/home/ria2 128 K 396G 128K/home/ria2
Zroot/home/safreya 7.74G 396G 7.70G/home/safreya
````

That is, when creating users, separate data sets `zroot/home/aria2 ' , `zroot/home/safreya ' have been created by default for the users `safreya ' and `aria2 ' respectively.

Next, look at the user privileges on each of the two data sets.

```sh '
~ zfs allow zroot/ home/ria2
- Personalities on zroot/home/aria2 - - - - - - - - - -
Local+Descent missions:
Our aria2 state, destroy, mount, snapshot
~ zfs allow zroot/ home/safreya
- Personalities on zroot/home/safreya - - - - - - - - - -
Local+Descent missions:
We're going to have to take a look at this.
````

As you can see, when creating the user collection, the default created four privileges for users: `create ' , `destroy ' , `mount ' and `snapshot ' .

So, for both data sets, a snapshot can also be used by ordinary users:

```sh '
safreya ~ % zfs snap zroot/ home/ safreya@snap1
%zfs list-t snap
NAME USED AVAIL REFER MOUNTPOINT
Zroot/home/safreya@snap0B-770G-
````

Again, `create ' , `destroy ' , `mount ' permission:

```sh '
~ zfs create zroot/ home/safreya/ dataset_1
{\cHFFFFFF}{\cH00FFFF}{\cH00FFFF}
I'm not sure if you're going to do this.
````

```sh '
%1'
Password:
Vfs.usermount: 0-> 1
~ zfs create zroot/ home/safreya/ dataset_2
%zfs list
NAME USED AVAIL REFER MOUNTPOINT
...a part of this omission...

Zroot/home 7.79G 396G 96K/home
Zroot/home/ria2 128 K 396G 128K/home/ria2
Zroot/home/safreya 7.79G 396G 7.68G/home/safreya
Zroot/home/safreya/dataset_1 96K 396G 96K/home/safreya/dataset_1
Zroot/home/safreya/dataset_2 96K 396G 96K/home/safreya/dataset_2
...a part of this omission...
````

```sh '
Safreya ~ % zfs detroy zroot/ home/ safreya/ dataset_1
Safreya ~ % zfs detroy zroot/ home/ safreya/ dataset_2
````

As you can see, creating (create) permissions and destroying (destroys) can be used normally, but the mounted (mount) permission requires the `vfs.usermount ' to open the kernel parameter to allow a user-level mount.

Here, the user-level zfs management needs have been largely met. But if you are careful enough, you will find that the `rollback ' permissions are not available and can be used to authorize ordinary user rollback privileges. Namely:

```sh '
Safreya ~ % zfs rollback zroot/ home/ safreya@snap1
{\cHFFFFFF}{\cH00FF00} cannot rollback 'zroot/home/safreya': permission denied
~ su-m root-c 'zfs allow safreya
Password:
Safreya ~ % zfs rollback zroot/ home/ safreya@snap1
````

## # user-level zfs encryption

FreeBSD 14.1 uses zfs encryption at the user level and requires specific privileges for users.

```sh '
~ su-root-c 'zfs allow safreya change-key, load-key, keepformat, keeplocation, encryption zroot/home/safreya'
Password:
~ zfs allow zroot/ home/safreya
- Missions on zroot/home/safreya - - - - - - - -
Local+Descent missions:
We're going to have to take a look at this.
Safreya ~ %
````

`change-key ' , `load-key ' , `keyformat ' , `keylocalization '  and `encryption ' are the five permission properties used for zfs encryption.

Now create an encrypted data set `zroot/home/safreya/secret ':

```sh '
{\cHFFFFFF}{\cH00FF00} {\cHFFFFFF}{\cH00FF00}
Enter new passphrase: # Enter the password here, the password doesn't come back, nothing happens
Re-enter new passphrase: #Repeat the above password, the password doesn't come back, and nothing.
````

Can not open message

```sh '
safreya ~ zfs get mounted zroot/ home/ safreya/secret
NAME PROPERTY VALUE SOURCE
Zroot/home/safreya/secret mounted yes-
````

View the `mounted ' properties, encrypted dataset creation is mounted, now create a file and unmount the encrypted dataset:

```sh '
%cd secret
>abc.txt
Safreya secret %cd..
~ zfs unmount zroot/ home/safreya/secret
safreya ~zfs unload-key zroot/ home/safreya/secret
safreya ~ zfs get mounted zroot/ home/ safreya/secret
NAME PROPERTY VALUE SOURCE
Zroot/home/safreya/secret moved no--
~ %ls secret ~ no output
Safreya ~ %
````

Unmounting an encrypted data set must remember to also unload the key. Mount encryption data sets with keys:

```sh '
safreya ~ zfs load-key zroot/ home/ safreya/secret
Enter passphrase for 'zroot/home/safreya/secret':
~ zfsmount zroot/ home/safreya/secret
%ls secret
Name
.rw-r-r -- 25 safreya 19 Sep 20:26 abc.txt
````


Note**
>
> Whether the data set is mounted or not, the sub-command `destroy ' can successfully destroy the data set because the `destroy ' privileges are granted by default, so that if the system is not operated by the user himself, there may be a situation where “I do not have it, destroy it”.
>
> It is also important to remember that “authorization” is granted to an ordinary user's “agent permission” to operate an authorized data set that is equivalent to root and does not require a password. The delegation of competence is therefore subject to a combination of considerations and reasonable limitations on the scope of the mandate and the attributes of competence, such as the ban on `destroy ' powers.

```sh '
~ su-m root-c 'zfs unallow safreya detroy zroot/ home/ safreya'
Password:
~ zfs allow zroot/ home/safreya
- Personalities on zroot/home/safreya - - - - - - - - - -
Local+Descent missions:
You know, we're the only ones who know how to make a difference.
````

Here `zroot/home/safreya/secret ' inherits the authorized attributes of the data set `zroot/home/safreya ' , and the authorizations/counter-authorizations are directed at `zroot/home/safreya ' and do not function for the operation of `zroot/home/safreya/secret ' (post-action properties are unchanged for unknown reasons).

### `adduser ' & Encrypted User Home Directory

`adduser ' commands can directly use encrypted master directory datasets, but the permissions given by default are insufficient and cannot be mounted directly by ordinary users once unmounted

```sh '
# Root safreya #
Usedname: test
Full name:
Uid (Leave empty for default):
Login group [test]:
Login group is best.
[default]:
Shell (ssh tcsh zsh rzsh git-shell rash rbash nologin):
Home directory [/home/test]:
Home directory missions:
(yes/no)
[yes]:
Once an empty password?
[yes/no]:
Enter password:
Enter password again:
Lock out the account after crime?
Usename: test
Password: *****
Full Name:
Uid: 1003
ZFS dataset: zroot/ home/test
Encrypted: yes
Class:
Groups:
Home: /home/test
Home Mode:
Shell: /bin/sh
Locked: no
[yes/no]
Enter encryption keyphrase for ZFS dataset:
Enter new passphrase:
Re-internew passphrase:
(Zroot/home/test).
IFO:
Add another user?
Goodbye!
````

Access:

```sh '
# zfs allow zroot/home/test
- Personalities on zroot/home/test - - - - - - -
Local+Descent missions:
We're going to have to go to the hospital.
````

Unmount:

```sh '
# zfs unmount zroot/home/test
# zfs unload-key zroot/home/test
````

Switch to normal user `test 'mount attempt:

```sh '
# Su test #
$ zfs load-key zroot/home/test
Enter passphrase for 'zroot/home/test':
I'm sorry.
````

`Permission denied ' is inadequate and denied access.


References


- [zfs-allow -- delegate ZFS accreditation missions to unprivileged users] (https://man.freebsd.org/cgi/man.cgi?zfs-allow)
- [zfs-create-created ZFS dataset]
(https://man.freebsd.org/cgi/man.cgi?zfs-create)
FreeBSD manual
- [OpenZFS Encryption Arives on FreeBSD] (https://freebsdfoundation.org/wp-content/uploads-2020/07/OpenZFS-Encryption-Arrives-on-FreeBSD.pdf), which illustrates the similarities and differences between GELI and zfs encryption
- [Merge OpenZFS support in to HEAD] (https://cgit.freebsd.org/src/committee/?id=9e5787d2284e), FreeBSD 13.0 was transferred to OpenZFS

Remarks

- ZFS does not use `/etc/fstab ' , but EFI, Swap is still in use.
。
# SECTION 23.7 ZFS DISK DECRYPT

# ZFS ENCRYPTED MOUNT DISK

If the ZFS disk is encrypted when FreeBSD is installed, how do we mount the disk

Disk Structure (FreeBSD 11 later)

| Division Type | Mount Point | Equipment |
| :---------------: | :----: | :---------------------------: |
| freebsd-boot/EFI |  | /dev/ada0p1 |
| freebsd-zfs | I'm sorry | /dev/ada0p2/, /dev/ada0p2.eli |
| freebsd-swap |  | /dev/ada0p3,/dev/ada0p3.eli |

>** Skills**
>
> __CODESPAN_0_ IS THE SATA HARD DRIVE。

It's simple and doesn't need a key. Execute Command

```sh
# geli attach /dev/ada0p3
```

ENTER THE CORRECT PASSWORD TO IMPORT THE DISK BY __CODESPAN_0_。

# ENCRYPT ZFS ROLLS WITH GELI

- Create block devices:

```sh
# zfs create -V 256M zroot/test
```

- View (other useless information ignored):

```sh
# zfs list
NAME                 USED  AVAIL  REFER  MOUNTPOINT
zroot/test           262M  83.7G    56K  -
```

- Create a randomly generated 4K size key:

```sh
# dd if=/dev/random of=/tmp/test.key bs=4k count=1
1+0 records in
1+0 records out
4096 bytes transferred in 0.000083 secs (49072111 bytes/sec)
```

- Initialize and load encrypted disks

```sh
# geli init -K /tmp/test.key /dev/zvol/zroot/test
Enter new passphrase: # 输入密码，密码不显示为 ***，就是什么也没有
Reenter new passphrase: # 重复输入密码，密码不显示 ***，就是什么也没有

Metadata backup for programmer/dev/zvol/zroot/test can be found in/var/backups/zvol_zroot_test.eli
and can be restored with the following command:

# geli restore / var/backups/zvol_zroot_test.eli /dev/zvol/zroot/test
````

- Unlock and mount the zvol device using the specified key file

```sh
# geli attach -k /tmp/test.key /dev/zvol/zroot/test
Enter passphrase: # 输入刚才设置的密码
```

- Found the equipment

```sh
# ls /dev/zvol/zroot/test.eli
/dev/zvol/zroot/test.eli
```

- We can create a new file partition on that device

```sh
# zpool create -m /tmp/ztest ztest /dev/zvol/zroot/test.eli
```

- Viewing devices

```
# geli list
Geom name: zvol/zroot/test.eli
State: ACTIVE
EncryptionAlgorithm: AES-XTS
KeyLength: 128
Crypto: accelerated software
Version: 7
UsedKey: 0
Flags: AUTORESIZE
KeysAllocated: 1
KeysTotal: 1
Providers:
1. Name: zvol/zroot/test.eli
   Mediasize: 268434944 (256M)
   Sectorsize: 512
   Mode: r1w1e1
Consumers:
1. Name: zvol/zroot/test
   Mediasize: 268435456 (256M)
   Sectorsize: 512
   Stripesize: 16384
   Stripeoffset: 0
   Mode: r1w1e1
```


# References

- [GELI - Disk Encryption in FreeBSD] (https://bsd-pl.org/assets/talks/2018-11-15_0_Micha %C5%82-Borysiak_GELI-Disk-encryption-in-FreeBSD.pdf), this is mainly from here. The unwritten part is because the test failed。

# Section 12.5 Grub & UEFI and efibootmgr


# Judge whether the current system uses UEFI

- If it's not UEFI:

```sh '
# efibootmgr # default belt, no need to install.
If you don't like it, you'll have to do it.
````

- If the current system is UEFI, efibootmgr output is similar:

```sh '
# efibootmgr # default belt, no need to install.
Boot to FW: false
BootCurrent: 0004
BootOrder: 0004, 0000, 0001, 0002, 0003
+Boot0004*FreeBSD
Boot000000* EFI VMware Virgin SCSI Hard Drive (0.0)
Boot0001* EFI VMware Vital IDE CDROM Drive (IDE 1:0)
Boot0002*EFI Network
Boot0003* EFI Internal Shell
````


# EFI Partition Delete & Rebuild (in doubt)

FreeBSD's default EFI is fat16, after this reconstruction is fat32?

Note**
>
>If `gpt (UEFI)' is not selected at the time the system is installed, `gpart show ' will find a partition `freebsd-boot (512K) ' .

- View current mount:

```sh '
Root@ykla:
zroot/ ROOT/default on/ (zfs, local, noatime, nfsv4acls)
Devfs on /dev (devfs)
/dev/gpt/efiboot0 on /boot/efi (msdosfs, local)
(zfs, local, noatime, nfsv4acls)
Zroot/var/log on/var/log (zfs, local, noatime, noexec, nosuid, nfsv4acls)
zroot/tmp on/tmp (zfs, local, noatime, nosuid, nfsv4acls)
Zroot/usr/ports on/usr/ports (zfs, local, noatime, nosuid, nfsv4acls)
Zroot on /zroot
(zfs, local, nfsv4acls)
Zroot/var/udit on/var/udit (zfs, local, noatime, noexec, nosuid, nfsv4acls)
Zroot/var/crash on/var/crash (zfs, local, noatime, noexec, nosuid, nfsv4acls)
Zroot/usr/src on/usr/src (zfs, local, noatime, nfsv4acls)
zroot/home/ykla on/home/ykla (zfs, local, noatime, nfsv4acls)
zroot/var/tmp on/var/tmp
````

- Check the file system.

````
Root@ykla:/ #fstyp/dev/nvd0p1
msdosfs
````

- Resize it.

```sh '
# gpart show
=40 12582940 nda0 GPT (60G)
40 532480 1 efi (260M)
532520 2008 - free - (1.0M)
534528 4194304 2 freebsd-swap (2.0G)
4728832 121098240 3 freebsd-zfs (58G)
125827072 2008 - free - (1.0M)

Root@ykla: ~ #umount/boot/efi # has to unload to delete!
#gpartdelete-i 1 nda0
Nda0p1 deleted
# gpart show
=40 12582940 nda0 GPT (60G)
40 534488 - free - (261M)
534528 4194304 2 freebsd-swap (2.0G)
4728832 121098240 3 freebsd-zfs (58G)
125827072 2008 - free - (1.0M)

# Gpart add -b 40 -s 260M -t -basic -data -i 1 nda0
Nda0p1 armed
# gpart show
=40 12582940 nda0 GPT (60G)
40 532480 1 ms-basic-data (260M)
532520 2008 - free - (1.0M)
534528 4194304 2 freebsd-swap (2.0G)
4728832 121098240 3 freebsd-zfs (58G)
125827072 2008 - free - (1.0M)

````

Format to fat32 (`/dev/nvd0p1 ' must remain unmounted. But if you specify the sector, it seems to affect 4K alignment?

```sh '
#news_msdos-F32 /dev/nvd0p1
16630 rules too few rules for FAT32, need 65525
````

Mount:

```sh '
Root@ykla: #mount-t msdosfs/dev/nda0p1/boot/efi
#cd/boot/efi/
root@ykla:/boot/ efi #mkdir # Create efi folders in fat32
````

# # troubleshooting and unfinished business

`news_msdos: 16630 rules too few rules for FAT 32, need 65525 ' ?


# UEFI and efibootmgr

- View current startup:

```sh '
#efibootmgr
Boot to FW: false
BootCurrent: 0001
Timeout: 1 seconds
BootOrder: 0002, 0003, 000 000, 0001
Boot0002* Windows Boot Manager
Boot0003* UEFI OS
Boot000000* refind
+Boot0001*freebsd#+ as default starter
````

>** Skills**
>
>Details can be used for `efibootmgr-v ' .

- Set refind to start first (this does not mean he's the default start item, which changes the sort in BIOS):

>** Warning**
>
> Not specified `efibootmgr-o 000000 ' . In so doing, other start-ups would be deleted.

```sh '
Root@ykla:/home/ykla
Boot to FW: false
BootCurrent: 0001
Timeout: 1 seconds
BootOrder: 000 000, 0001, 0002, 0003
Boot000000* refind
+Boot0001*freebsd
Boot0002* Windows Boot Manager
Boot0003* UEFI OS
````


References

- [efibootmgr cannot add UEFI startup entry] (https://bbs.archlinuxcn.org/viewtopic.php?id=12914), this is simple and simple
- [efibootmgr (8)] (https://man.freebsd.org/cgi/man.cgi?efibootmgr (8)), FreeBSD man manual, English
- [in-depth knowledge of efibootmgr]Operating to securely delete start-up method resolution] (https://my.oschina.net/emacs_8861834/blog/17450288), detailed but not all applicable to BSD

# UEFI Operation Example

Now let's assume there's two hard drives, two hard drives with one EFI partition, one FreeBSD and the other Windows.

Only one EFI partition is left, i.e. two EFI configuration files are placed in a hard drive in the EFI partition.

Hard drive with Windows as `ada0 ' and FreeBSD as `nvd0 '. This article deletes nvd0, the EFI partition generated by the BSD installation (it is not known why FreeBSD's EFI file system is Fat16). The FreeBSD guide file was placed under the `ada0 ' hard drive.

Quick Start of Close Windows: Order `powercfg/h off ' . (If you go in, set the BIOS interface, you don't have to turn it off.)

Then turn off and re-enter FreeBSD, create a mount point:

```sh '
#mkdir/mnt/efi
````

Check if `ada0p1 '(the first partition of the hard drive) is our mounted EFI partition. Enter the command:

```sh '
# fstyp /dev/ada0p1
````

My output is `NTFS ' , which is not the EFI partition we want;

And look at the second partition:

```sh '
# fstyp /dev/ada0p2
````

Output `msdosfs ' , EFI partition on our Windows disk.

Next, mount the EFI partition on the aada0 disk to FreeBSD '/mnt/efi ':

```sh '
# Mount-t msdosfs/dev/ada0p2/mnt/efi
````

Creates a directory under the EFI path for the FreeBSD guide:

```sh '
#mkdir /mnt/efi/EFI/freebsd
````

Then copy the startup file to that path

```sh '
#cp /boot/boot1.efi /mnt/efi/EFI/freebsd/bootx64.efi
````

Final generation of starter:

```sh '
# efibootmgr-c-l-mnt/efi/EFI/freebsd/bootx64.efi-L "FreeBSD 14.2"
````

Restart to Windows and activate `FreeBSD 14.2 ' with easyufi.

If FreeBSD is activated again, use [DiskGenius] (https://www.disskgenius.cn/) or other partition tools to delete the EFI partition and file of the nvd0 disk.


# Grub

The `grub ' test cannot directly direct the kernel of FreeBSD to activate the system. It can only be indirectly directed by `chainlain+1 ' .

```sh '
"FreeBSD-13.0"
# Please check yourself
Cainloader /boot/boot1.efi
♪ I'm sorry ♪
````

# # References

- [Working GRUB confibration for UEFI growing FreeBSD] (https://unix.stackexchange.com/questions/354260/working-grub-confi-training-freebsd)
- [Trying to Boot FBSD13 via grub2] (https://www.reddit.com/r/freebsd/comments/q4qgq9/trying_to_boot_fbsd13_via_grub2/)

Current configuration for reporting errors (`grub2-efi`FBSD 14.2):

```sh '
# Grub-install-target=x86_64-efi-efi-directory=/boot/efi/-bootloader-id=grub-boot-directory=/boot/-modules=part_gpt part_msdos bsd zfs"
Now, I'm going to ask you, Mr. Grub-install:
Root@ykla:~#grab-install-target=x86_64-efi-efi-efi-efi/-botloader-id=grub-boot-directory=/boot/-modules=part_gpt part_msdosbsd zfs”
Installing for x86_64-efi platform.
I don't know what you're talking about.
````

Plus parameter `-vvv`, a long line of errors can be seen. It's too long. The output is at <https://gist.github.com/ykla/9b6de6c8d4ee524840acb9981bf850a>

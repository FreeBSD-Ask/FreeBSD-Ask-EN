# Section 12.5 Grub & UEFI and efibootmgr


# JUDGE WHETHER THE CURRENT SYSTEM USES UEFI

- IF IT'S NOT UEFI:

```sh '
# efibootmgr # default belt, no need to install。
if you don't like it, you'll have to do it?
````

- If the current system is UEFI, efibootmgr output is similar:

```sh
# efibootmgr # 默认自带、无需安装。
Boot to FW : false
BootCurrent: 0004
BootOrder  : 0004, 0000, 0001, 0002, 0003
+Boot0004* FreeBSD
Boot0000* EFI VMware Virtual SCSI Hard Drive (0.0)
Boot0001* EFI VMware Virtual IDE CDROM Drive (IDE 1:0)
Boot0002* EFI Network
Boot0003* EFI Internal Shell (Unsupported option)
```


# EFI PARTITION DELETE & REBUILD (IN DOUBT)

FreeBSD's default EFI is fat16, after this reconstruction is fat32?

Note**
>
>IF, AT THE TIME OF INSTALLATION OF THE SYSTEM, __CODESPAN_0 IS NOT SELECTED, __CODESPAN_1 IS FOUND TO EXIST IN __CODESPAN_2_。

- View current mount:

```sh
root@ykla:~ # mount
zroot/ROOT/default on / (zfs, local, noatime, nfsv4acls)
devfs on /dev (devfs)
/dev/gpt/efiboot0 on /boot/efi (msdosfs, local)
zroot/home on /home (zfs, local, noatime, nfsv4acls)
zroot/var/log on /var/log (zfs, local, noatime, noexec, nosuid, nfsv4acls)
zroot/tmp on /tmp (zfs, local, noatime, nosuid, nfsv4acls)
zroot/usr/ports on /usr/ports (zfs, local, noatime, nosuid, nfsv4acls)
zroot on /zroot (zfs, local, noatime, nfsv4acls)
zroot/var/mail on /var/mail (zfs, local, nfsv4acls)
zroot/var/audit on /var/audit (zfs, local, noatime, noexec, nosuid, nfsv4acls)
zroot/var/crash on /var/crash (zfs, local, noatime, noexec, nosuid, nfsv4acls)
zroot/usr/src on /usr/src (zfs, local, noatime, nfsv4acls)
zroot/home/ykla on /home/ykla (zfs, local, noatime, nfsv4acls)
zroot/var/tmp on /var/tmp (zfs, local, noatime, nosuid, nfsv4acls)
```

- Check the file system

```
root@ykla:/ # fstyp /dev/nvd0p1
msdosfs
```

- Resize it

```sh
root@ykla:~ # gpart show
=>       40  125829040  nda0  GPT  (60G)
         40     532480     1  efi  (260M)
     532520       2008        - free -  (1.0M)
     534528    4194304     2  freebsd-swap  (2.0G)
    4728832  121098240     3  freebsd-zfs  (58G)
  125827072       2008        - free -  (1.0M)

root@ykla: ~ #umount/boot/efi # has to unload to delete
#gpartdelete-i 1 nda0
nda0p1 deleted
# gpart show
=40 12582940 nda0 GPT (60G)
40 534488 - free - (261M)
534528 4194304 2 freebsd-swap (2.0G)
4728832 121098240 3 freebsd-zfs (58G)
125827072 2008 - free - (1.0M)

# Gpart add -b 40 -s 260M -t -basic -data -i 1 nda0
nda0p1 armed
# gpart show
=40 12582940 nda0 GPT (60G)
40 532480 1 ms-basic-data (260M)
532520 2008 - free - (1.0M)
534528 4194304 2 freebsd-swap (2.0G)
4728832 121098240 3 freebsd-zfs (58G)
125827072 2008 - free - (1.0M)

```

Formats as fat32 (__CODESPAN_0_ must remain unmounted). But if you specify the sector, it seems to affect 4K alignment

```sh
root@ykla:~ # newfs_msdos -F 32 /dev/nvd0p1
newfs_msdos: 16630 clusters too few clusters for FAT32, need 65525
```

Mount:

```sh
root@ykla:~ # mount -t msdosfs /dev/nda0p1 /boot/efi
root@ykla:~ # cd /boot/efi/
root@ykla:/boot/efi # mkdir efi # 创建 fat32 分区中的 efi 文件夹
```

# # troubleshooting and unfinished business

QUESTION: HOW TO SOLVE __CODESPAN_0_


# UEFI and efibootmgr

- View current startup:

```sh
root@ykla:/home/ykla # efibootmgr
Boot to FW : false
BootCurrent: 0001
Timeout    : 1 seconds
BootOrder  : 0002, 0003, 0000, 0001
 Boot0002* Windows Boot Manager
 Boot0003* UEFI OS
 Boot0000* refind
+Boot0001* freebsd # + 为默认启动项
```

>** Skills**
>
>DETAILS CAN BE __CODESPAN_0_。

- Set refind to start first (this does not mean he's the default start item, which changes the sort in BIOS):

>** Warning**
>
> NOT __CODESPAN_0_ SO SPECIFIED. IN SO DOING, OTHER START-UPS WOULD BE DELETED。

```sh
root@ykla:/home/ykla # efibootmgr -o 0000,0001,0002,0003
Boot to FW : false
BootCurrent: 0001
Timeout    : 1 seconds
BootOrder  : 0000, 0001, 0002, 0003
 Boot0000* refind
+Boot0001* freebsd
 Boot0002* Windows Boot Manager
 Boot0003* UEFI OS
```


References

- [efibootmgr cannot add UEFI startup] (https://bbs.archlinuxcn.org/viewtopic.php?id=12914), this is a short and simple one
- [efibootmgr (8)] (https://man.freebsd.org/cgi/man.cgi?efibootmgr (8)), FreeBSD man manual, English
- [in-deep knowledge of the efibootmgr operation to securely remove start-up method] (https://my.oschina.net/emacs_8861834/blog/17450288), with details, but not all applicable to BSD

# UEFI OPERATION EXAMPLE

Now let's assume there's two hard drives, two hard drives with one EFI partition, one FreeBSD and the other Windows。

ONLY ONE EFI PARTITION IS LEFT, I.E. TWO EFI CONFIGURATION FILES ARE PLACED IN A HARD DRIVE IN THE EFI PARTITION。

The hard drive with Windows is __CODESPAN_0, the hard drive with FreeBSD is __CODESPAN_1. This article deletes nvd0, the EFI partition generated by the BSD installation (it is not known why FreeBSD's EFI file system is Fat16). Place the FreeBSD guidance file under __CODESPAN_2_ hard drive。

First off Windows quick start: command is __CODESPAN_0_. (If you go in, set the BIOS interface, you don't have to turn it off.)

Then turn off and re-enter FreeBSD, create a mount point:

```sh
# mkdir /mnt/efi
```

TEST __CODESPAN_0_(FIRST PARTITION OF THE HARD DRIVE) IF WE WANT TO MOUNT THE EFI PARTITION. ENTER THE COMMAND:

```sh
# fstyp /dev/ada0p1
```

MY OUTPUT IS CODESPAN_0, WHICH IS NOT THE EFI PARTITION WE WANT

And look at the second partition:

```sh
# fstyp /dev/ada0p2
```

Output __CODESPAN_0 is our EFI partition on Windows disks。

Next, mount the EFI partition on the aada0 disk to __CODESPAN_0_:

```sh
# mount -t msdosfs /dev/ada0p2 /mnt/efi
```

Creates a directory under the EFI path for the FreeBSD guide:

```sh
# mkdir /mnt/efi/EFI/freebsd
```

Then copy the startup file to that path

```sh
# cp /boot/boot1.efi /mnt/efi/EFI/freebsd/bootx64.efi
```

Final generation of starter:

```sh
# efibootmgr -c -l /mnt/efi/EFI/freebsd/bootx64.efi -L "FreeBSD 14.2"
```

Restart to Windows, activate __CODESPAN_0_ with easyufi。

If FreeBSD is activated again, use [DiskGenius] (https://www.disskgenius.cn/) or other partition tools to delete the EFI partition and file of the nvd0 disk。


# Grub

The __CODESPAN_0_ test cannot directly direct the kernel of FreeBSD to activate the system. It can only be directed indirectly by __CODESPAN_1_。

```sh
menuentry "FreeBSD-13.0 Release" {
set root='(hd0,gpt1)'  # 请自己检查
chainloader /boot/boot1.efi
}
```

# # References

- [Working GRUB Conformation for UEFI Building FreeBSD] (https://unix.stackexchange.com/questions/354260/working-grub-confi-training-freebsd)
- [Trying to Boot FBSD13 via Grub2] (https://www.reddit.com/r/freebsd/comments/q4qq9/trying_to_boot_fbsd13_via_grub2/)

MISREPORTING OF CURRENT CONFIGURATION (__CODESPAN_0_FBSD14.2):

```sh
# grub-install --target=x86_64-efi --efi-directory=/boot/efi/efi/ --bootloader-id=grub --boot-directory=/boot/ --modules="part_gpt part_msdos bsd zfs"
grub-install: error: relocation 0x4 is not implemented yet.
root@ykla:~ # grub-install --target=x86_64-efi --efi-directory=/boot/efi/efi/ --bootloader-id=grub --boot-directory=/boot/ --modules="part_gpt part_msdos bsd zfs"
Installing for x86_64-efi platform.
grub-install: error: unknown filesystem.
```

Plus parameter __CODESPAN_0, you can see a long line of errors. It's too long. The output is at <https://gist.github.com/ykla/9b6de6c8d4ee524840acb9981bf850a>

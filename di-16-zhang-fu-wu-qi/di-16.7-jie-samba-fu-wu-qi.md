Section 16.7 Samba Server

Samba is the re-entry of SMB/CIFS (Server Message Block, Server Message Block) protocols. CIFS (Common Internet File System, General Internet File System) is a derivative agreement for SMB。

Samba is also the Portuguese/English equivalent of “samba”. There's a sense of enthusiasm。

samba tcp/139, 445 port to open firewall; ddp/137, 138 port。

# install samba

- install with pkg:

```sh
# pkg install samba420
```

- or install with Ports:

```sh
# cd /usr/ports/net/samba420/ 
# make install clean
```

# See after installation

```sh
# pkg info -D samba420
samba420-4.20.7_4:
On install:  # 安装提示：
How to start: http://wiki.samba.org/index.php/Samba4/HOWTO  
如何启动：参见官方指南

? Your compliance is: /usr/local/etc/smb4.conf
:: your profile path is: /usr/local/etc/smb4.conf

All the relevant data are under: /var/db/samba4
:: all relevant databases are located at:/var/db/samba4

All the logs are under: /var/log/samba4
:: all logs are located at:/var/log/samba4

*Provisioning script is: /usr/local/bin/samba-tool
* # initialized script: /usr/local/bin/samba-tool

For the working DNS updates you will need to either build dns/ bind9*
# IF YOU NEED TO USE THE DNS UPDATE FUNCTION PROPERLY, YOU NEED:
with the available GSSAPI
# Or build the dns/bind9* that enabled GSSAPI (recommended GCSSAPI_MIT5)
i don't know if i'm going to be able to do this, but i'm not going to do this.
# or install dns/samba-nsupdate packages, which pre-configure the required support。

You will need to share the 'nsupdate' community in the
smb4.conf file:
# you need to specify the location of the nsupdate command in smb4.conf:

    nsupdate command = /usr/local/bin/samba-nsupdate -g  # 示例配置

For ad hoc documentation check: https://wiki.samba.org/index.php/User_Documentation
# More documents are available:

Port relaid bug reports can go to the https://gitlab.com/samba-freebsd/ports/-/issues or
# Issues related to FreeBSD port should be submitted to:

to the FreeBSD Bugzilla https://bugs.freebsd.org/

# All issues related to Samba itself can be submitted to:
All Samba returned bug reports should go to the: https://bugzilla.samba.org/
````

# configure samba

- Configure services

```sh
# service samba_server enable
```

- CREATE __CODESPAN_0_, ADD THE FOLLOWING AND SAVE IT


```ini
[global]
    min protocol = SMB2

[root]
this post is part of our special coverage global development 2011
path = / root
= no
= yes
= yes
printable = no
= 0755
````

Annotations:

__CODESPAN_0_: GLOBAL CONFIGURATION, APPLICABLE TO ALL SHARED ITEMS。
-_CODESPAN_0_: Limit the minimum support protocol to SMB2 to facilitate high-end Windows access
- ___ CODESPAN_0: DEFINES A SHARED NAME __ CODESPAN_1_。
-_CODESPAN_0_: This shared description is visible in Windows browsers。
- __CODESPAN_0: THE ACTUAL PATH FOR SHARING IS __CODESPAN_1_,** NOT RECOMMENDED** TO SHARE THE DIRECTORY IN THE PHYSICAL ENVIRONMENT。
__CODESPAN_0: NO ANONYMOUS ACCESS (EQUIVALENT TO __CODESPAN_1_)。
__CODESPAN_0_: SHARES CAN BE VIEWED AMONG NETWORK NEIGHBOURS。
__CODESPAN_0: ALLOWS THE CLIENT TO WRITE TO THE DIRECTORY。
-_CODESPAN_0_: NOT PRINTER SHARING。
- __CODESPAN_0_: THE DEFAULT PERMISSION TO CREATE A NEW FILE IS 755, OWNER READS AND WRITES, GROUP AND OTHER USERS READ ONLY。

---|---

- create samba root user and configure password:

```sh
# smbpasswd -a root
```

- Start service

```sh
# service samba_server start 
```


- view samba status:

```sh
# service samba_server status
nmbd is running as pid 1520.
smbd is running as pid 1525.
```

- Access to shared folders under Windows using the following command (subject to actual IP, copy not working):

>** Skills**
>
> Visit share folder description under Windows: Press Windows + **R** (lowcase r can also) to open the Run dialogue box. Enter the following command in the dialogue box (replaces the contents of the example with the actual IP address and the shared folder name):

```batch
\\192.168.179.150
```

![.. ..gitbook/assets/samba1.png]

ENTER THE USERNAME __CODESPAN_0_ JUST CREATED, AS WELL AS THE PASSWORD:

![.. ..gitbook/assets/samba2.png]

Connection success:

![.. .gitbook/assets/samba3.png]

Set Samba as a domain member

environment: freebsd 12

CONFIGURE STATIC IP ADDRESSES

Use the following command configuration:

```sh
# bsdconfig
```

Configure hostname

THE HOSTNAME SHOULD BE CONFIGURED WHEN THE SYSTEM IS INSTALLED. YOU CAN VIEW OR EDIT SETTINGS AT __CODESPAN_0_:

```sh
hostname="fb"
```

CONFIGURE DNS

EDIT __CODESPAN_0_, WRITING:

```sh
# Generated by resolvconf
search SVROS.COM               //设置域控制器域名
# nameserver 192.168.253.2

nameserver 192.168.253.130 // Setup domain controller IP address
nameserver 223.5.5.5
nameserver 127.0.0.1
i don't know, options edns0
````

## MODIFY __CODESPAN_0_

```sh
# echo "kern.maxfiles=25600" >> /etc/sysctl.conf
# echo "kern.maxfilesperproc=16384" >> /etc/sysctl.conf
# echo "net.inet.tcp.sendspace=65536" >> /etc/sysctl.conf
# echo "net.inet.tcp.recvspace=65536" >> /etc/sysctl.conf
```

## CREATE_CODESPAN_0_

```ini
[libdefaults]
	default_realm = SVROS.COM   //设置域名
	dns_lookup_realm = true
	dns_lookup_kdc = true
	ticket_lifetime = 24h
	renew_lifetime = 7d
	forwardable = yes
```

## MODIFY __CODESPAN_0_

```sh
# sed -i -e "s/^passwd:.*/passwd: files winbind/" /etc/nsswitch.conf
# sed -i -e "s/^group:.*/group: files winbind/" /etc/nsswitch.conf
```

## CREATE_CODESPAN_0_

```ini
[global]
	workgroup = SVROS
	server string = Samba Server Version %v
	security = ads
	realm = SVROS.COM
	domain master = no
	local master = no
	preferred master = no
	socket options = TCP_NODELAY IPTOS_LOWDELAY SO_RCVBUF=131072 SO_SNDBUF=131072
	use sendfile = true

	idmap config * : backend = tdb
	idmap config * : range = 100000-299999
	idmap config SVROS : backend = rid
	idmap config SVROS : range = 10000-99999
	winbind separator = +
	winbind enum users = yes
	winbind enum groups = yes
	winbind use default domain = yes
	winbind nested groups = yes
	winbind refresh tickets = yes
	template homedir = /home/%D/%U
	template shell = /bin/false

	client use spnego = yes
	client ntlmv2 auth = yes
	encrypt passwords = yes
	restrict anonymous = 2
	log file = /var/log/samba4/log.%m
	max log size = 50

== sync, corrected by elderman == @elder_man

[testshare]
this post is part of our special coverage Syria Protests 2011
path = /samba/testshare
= no
"Domain Users"
= 0770
= 0770
= 0660
= 0660
````

optimization of physical access to the last two lines of "testshare" above (optional)

```sh
create mode = 0750
force create mode = 0750
```

add samba to the field

```sh
net ads join --no-dns-updates -U administrator
net ads testjoin
# Should report "Join is OK"
# On your DC, open the DNS MMC and add an "A" entry for your BSD server so clients can find it
```

# # make samba start and set to start self-start

```sh
# echo "samba_server_enable=YES" >> /etc/rc.conf
# echo "winbindd_enable=YES" >> /etc/rc.conf
# service samba_server start
```

# # Test Kerberos

```sh
kinit administrator
# Enter domain admin password, it should return to the prompt with no errors
klist
# Credentials cache: FILE:/tmp/krb5cc_0
#    Principal: administrator@SVROS.COM
#
# Issued                Expires               Principal
# Dec  6 10:15:39 2021  Feb  4 20:15:39 2021  krbtgt
```

# # Test Winbind

```sh
wbinfo -u
# 应该会返回域用户列表

wbinfo-g
# Should return the list of domain user groups

now passwd
# THE USER LIST SHOULD END WITH A DOMAIN USER WITH UID GREATER THAN 10000

oh, get group
# THE END OF THE USER GROUP LIST SHOULD INCLUDE DOMAIN USER GROUPS WITH GIDS GREATER THAN 10000
````

# # execute if wbinfo command shows error

```sh
# service samba_server restart
```

# # Create shared folders

```sh
# mkdir -p /samba/testshare
# chown "administrator":"domain users" /samba/testshare
# chmod 0770 /samba/testshare
```

If only the owner is allowed to read and write, only the group is allowed to read, set as follows:

```sh
# chmod 0750 /samba/testshare
```

If only the owner is allowed to read and write, the group and others cannot read and write, set with the following command:

```sh
# chmod -R 0700 /samba/testshare
```

# The failure and the lack of competition

The Samba log is located at ___CODESPAN_0_。

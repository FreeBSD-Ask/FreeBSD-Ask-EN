SECTION 16.1 FTP SERVER

FTP is File Transfer Protocol. Using the FTP service to build a server can quickly transfer files。

#Pure-FTPd (based on MySQL)

> ** Warning**
>
>Pure-FTPD has removed support for RFC 2640, so the use of ftp command lines for FTP-related non-English files under Windows will be uncoded and the code cannot be modified. See <https://www.pureftpd.org/project/pure-ftpd/news/>。
>
> ``powershell '
♪ ftp quote opts utf8 on
>504 Unknown company
> ````

---|---

Use the command line (in FreeBSD) and WinSCP to test Pure-FTPd without a problem of hyphenation。

# Install

as the pkg package does not have database support, the software needs to be installed through ports:

```sh
# cd /usr/ports/ftp/pure-ftpd
# make config
```

SELECT _CODESPAN_0_, THE REST KEEP THE DEFAULT OPTION TO RETURN THE CAR:

![..gitbook/assets/PureFTPD.png]

```sh
# make BATCH=yes install clean
```

### CONFIGURE __CODESPAN_0_FILE

### # Generate Profile

```sh
# cp /usr/local/etc/pure-ftpd.conf.sample /usr/local/etc/pure-ftpd.conf
# cp /usr/local/etc/pureftpd-mysql.conf.sample /usr/local/etc/pureftpd-mysql.conf
```

#### edit profile and add mysql support

CONFIGURE __CODESPAN_0_ FILES, WITH THE FOLLOWING MODIFICATIONS:

```ini
# 兼容 ie 等非正规化的 ftp 客户端

BrokenClientscompatibility yes

# Passive connection to the port range of response。

Passive PortRange 30000 50000

# THE SMALLEST UID THAT ALLOWS THE USER TO LOG IN。
# FOR EXAMPLE, A VALUE OF 100 WILL PREVENT ALL UID USERS LESS THAN 100。
# if you want root to log in, use 0。

MinUID 2000

# ALLOW FXP TRANSFERS ONLY FOR AUTHENTICATION USERS。

AllowUserFXP yess

# if not disabled or commented, the log will miss not find ftp user

AntiWarez yes

# Automatically create a user home directory if it does not exist

CreateHomeDir yes

# MySQL profile (see README. MySQL)

MySQLConfigfile /usr/local/etc/pureftpd-mysql.conf
````

# # configure mysql

> ** Note**
>
>This is based on MySQL 8.x. See other sections for the installation of MySQL, basic settings。

please install mysql 8.x。

Create database

```sql
create database pureftpd;
use pureftpd;
DROP TABLE IF EXISTS `users`;
CREATE TABLE `users` (
   `User` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_bin NOT NULL,
   `Password` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_bin NOT NULL,
   `Uid` int(11) NOT NULL DEFAULT -1 COMMENT '用户 ID',
   `Gid` int(11) NOT NULL DEFAULT -1 COMMENT '用户组 ID',
   `Dir` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_bin NOT NULL,
   `quotafiles` int(255) NULL DEFAULT 500,
   `quotasize` int(255) NULL DEFAULT 30,
   `ulbandwidth` int(255) NULL DEFAULT 80,
   `dlbandwidth` int(255) NULL DEFAULT 80,
   `ipaddress` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci NULL DEFAULT'*',
   `comment` int(255) NULL DEFAULT NULL,
   `status` tinyint(4) NULL DEFAULT 1,
   `ulratio` int(255) NULL DEFAULT 1,
   `dlratio` int(255) NULL DEFAULT 1,
   PRIMARY KEY (`User`) USING BTREE
) ENGINE = InnoDB CHARACTER SET = utf8mb4 COLLATE = utf8mb4_general_ci ROW_FORMAT = Dynamic;
```

### Create login database users and set passwords

```sql
CREATE USER 'pftp'@'localhost' IDENTIFIED BY 'abc123';
GRANT SELECT, INSERT, UPDATE, DELETE ON pureftpd.* TO 'pftp'@'localhost';
flush privileges;
```

Test database links:

```sh
# mysql -u pftp -p -h localhost pureftpd
```

## CONFIGURE __CODESPAN_0_

Full examples:

```ini
##############################################
#                                            #
# 示例 Pure-FTPd 的 MySQL 配置文件。         #
# 详细说明请参阅 README.MySQL。              #
#                                            #
##############################################

# MySQLServer database server address
MySQLServer 127.0.0.1

# MySQLServer database server port
MYSQLPort 3306

# optional: if the database server runs on this machine, specify the path for mysql.sock。
MYSQLSocket / var/run/mysqld/mysqld.sock

# Database username
MySQLUser pftp

# Database password
MySQLPassword abc123

# Database name
MySQLDatabaseureftpd

# Password encryption (identified here)
# valid values include: "cleartext", "argon 2, "scrypt", "crypt" and "any"
MySQLCrypt

# The string parts in the following settings will be replaced when running:
# I don't know
# L WILL BE REPLACED BY A USER NAME TO TRY TO AUTHENTICATE。
# I WILL BE REPLACED BY THE IP ADDRESS THAT THE USER IS CONNECTED TO。
# P WILL BE REPLACED WITH THE PORT NUMBER THAT THE USER CONNECTS TO。
\R WILL BE REPLACED BY THE IP ADDRESS OF THE USER'S SOURCE。
# \D WILL BE REPLACED BY A LONG INTEGER FORM OF A REMOTE IP ADDRESS。
# I don't know
# Use these replacement strings to perform very complex queries, especially for virtual mainframe settings。

# SQL QUERY STATEMENT TO GET THE PASSWORD
MySQLGetPW SELECT Password

# SQL QUERY STATEMENT TO GET A SYSTEM USER NAME OR UID
MySQLGETUID SELECT Uid FROM uss Weree User

# Default UID - set to overwrite the query results for MySQLGetUID
MySQLDefaultUID 2000

# SQL QUERY STATEMENT TO GET A SYSTEM USER NAME OR GID
MySQLGID SELECT Gid FROM user Werere User

# Default GID - the query results of MySQLGetGid will be overridden when set
MySQLDefaultGID 2000

# SQL QUERY STATEMENT TO GET THE USER HOME DIRECTORY
MySQLGetdir SELECT Dir FROM uss Werere User

# Optional: query for maximum number of files (Virtual quota support to open)
MySQLGetQTAFS SELECT QuotaFiles FROMUS USER

# OPTIONAL: USED TO OBTAIN MAXIMUM DISK USAGE (MB IN VIRTUAL QUOTA SUPPORT)
MySQLGetQTASZ SELECT QuotaSize FORM USERS WEREE USER

# Optional: upload/download ratio, server needs to support ratio function
MySQLGetRatioUL SELECT ULRATIO FORM USES WHORE USER
MySQLGetRatioDL SELECT DLRATIO FORM USES WHERE USER

# Optional: Bandwidth limit in KB/s. Server needs to support bandwidth limit functionality
MySQLGetBandthUL SELECT ULBANDWIDth
MySQLGetBandthDL SELECT DLBANDWIDth USER USER

Enable ~ path extension. ** Do not use blindly unless the following conditions are met:**
# 1) You know exactly what you're doing。
#2) Actual users are consistent with virtual users。
# MySQLForceTildeExpansion 1

# IF YOU USE A SERVICE-TYPE STORAGE ENGINE, YOU CAN ENABLE SQL SERVICES TO AVOID COMPETITIVE CONDITIONS。
# If you use the traditional MyISAM engine, keep this comment。
# MySQLTransactions On
````

## add ftp group and user

>** Warning**
>
>pure-pw won't work after using the database。


```sh
# pw groupadd ftpgroup -g 2000
# pw useradd ftpuser -u 2001 -g 2000 -s /sbin/nologin -w no -d /home/pureftp -c "VirtualUser Pure-FTPd" -m
```

- Adds a FTP login user (must manually write to mysql database), the user created by the following command is __CODESPAN_0_. The password is __CODESPAN_1_。


```sql
USE pureftpd;
INSERT INTO `users` (`User`, `Password`, `Uid`, `Gid`, `Dir`, `quotafiles`, `quotasize`, `ulbandwidth`, `dlbandwidth`, `ipaddress`, `comment`, `status`, `ulratio`, `dlratio`)
VALUES ('test', 'test2', 2001, 2000, '/home/pureftp/www', 500, 30, 80, 80, '*', NULL, 1, 1, 1);
```

Note**
>
> CODESPAN_0, CODESPAN_1 > MUST BE CONSISTENT WITH THE USER CREATED BY __CODESPAN_2 ABOVE。

>** Skills**
>
>THE BASIC IDEA IS THAT VIRTUAL USERS WHO WRITE TO THE DATABASE WILL INHERIT THE PERMISSIONS OF __CODESPAN_0_ CREATED BY THE USER AND THE GID\UID, AND THEN OPERATE THE FTP THROUGH THE USERS IN THE DATABASE. SAME。

Examples of practical operations:

```sql
root@localhost [(none)]> show databases;
+--------------------+
| Database           |
+--------------------+
| information_schema |
| mysql              |
| performance_schema |
| pureftpd           |
| sys                |
+--------------------+
5 rows in set (0.00 sec)
root@localhost [pureftpd]> USE pureftpd;
Database changed
root@localhost [pureftpd]> INSERT INTO `users` (`User`, `Password`, `Uid`, `Gid`, `Dir`, `quotafiles`, `quotasize`, `ulbandwidth`, `dlbandwidth`, `ipaddress`, `comment`, `status`, `ulratio`, `dlratio`)
    -> VALUES ('test', 'test2', 2001, 2000, '/home/pureftp/www', 500, 30, 80, 80, '*', NULL, 1,1, 1);
Query OK, 1 row affected (0.01 sec)
root@localhost [pureftpd]> select * from users;
+------+----------+------+------+-------------------+------------+-----------+-------------+-------------+-----------+---------+--------+---------+---------+
| User | Password | Uid  | Gid  | Dir               | quotafiles | quotasize | ulbandwidth | dlbandwidth | ipaddress | comment | status | ulratio | dlratio |
+------+----------+------+------+-------------------+------------+-----------+-------------+-------------+-----------+---------+--------+---------+---------+
| test | test2    | 2001 | 2000 | /home/pureftp/www |        500 |        30 |          80 |    80 | *         |    NULL |      1 |       1 |       1 |
+------+----------+------+------+-------------------+------------+-----------+-------------+-------------+-----------+---------+--------+---------+---------+
1 row in set (0.01 sec)

```

- CONFIGURE FTP DIRECTORY

```sh
# mkdir -p /home/pureftp/www 
# chown -R ftpuser:ftpgroup /home/pureftp
# chmod -R 775 /home/ftpuser # 权限要设置为 775，这样同组的才能读写
```

References

- [Lineux Environnement FTP Personnel Settings Detailed and National Step All] (https://my.oschina.net/emacs_874886/blog/17171107), 775 permission settings from here

Service Operations

```sh
# service pure-ftpd enable  # 添加服务
# service pure-ftpd start   # 启动服务器
# service pure-ftpd stop    # 停止服务
# service pure-ftpd restart # 重启服务
```

References

- [Virtual Hosting with PureFTPd And MySQL] (http://km.npru.ac.th/userfiles/R013/km_articles_files/20120227104346_Virtual%20Hosting%20With%20PureFTPd%20And%20MySQL.pdf), based on this framework

# # troubleshooting and unfinished business

- Pure-FTPd log at ___CODESPAN_0_。

# ProFTPD (based on MySQL)

>** Skills**
>
>ProFTPD does not code under Windows' own FTP link。



## Install ProFTPD

> ** Note**
>
>This is based on MySQL 8.0. See other sections for the installation of MySQL, basic settings。

Please install the configuration MySQL 8.x - Need to be consistent with version ___CODESPAN_0_ installed __CODESPAN_1_。

```sh
# pkg install proftpd proftpd-mod_sql_mysql
```

or

```sh
# cd /usr/ports/ftp/proftpd/ && make install clean
# cd /usr/ports/databases/proftpd-mod_sql_mysql/ && make install clean
```

##ProFTPD profile __CODESPAN_0_

- Edit the configuration file for ProFTPD __CODESPAN_0_, as follows:

>** Skills**
>
>FOR EXAMPLE, SEE __CODESPAN_0_。

```ini
ServerName "Test Ftp Server"
ServerType standalone
DefaultServer on
ServerIdent on "FTP Server ready"
Port 21
Umask 022

# Timeout settings
Timeout Login 300
Timeout Idle 36000
Timeout NoTransfer 36000

# Resource constraints
User programd
Group programd
RLimitMemory 256M 256M
RLimitOpenFiles 1024 1024
Passive Ports 50000 60000

# Log Configuration
LogFormat default "%h %l %u %t\r\s %b"
LogFormat auth "%v [%P] %h %t "%r\s"
SystemsLog / var/log/proftpd/proftpd.log
TransportLog / var/log/proftpd/xfer.log
Extended Log / var/log/proftpd/auth.log AUTH auth

# MySQL module load
LoadModule mod_sql.c
LoadModule mod_sql_mysql.c
LoadModule mod_sql_passwd.c

# Allow access to your own directory only, remove access #

Default Root

# Run Overwrite File

Allooverwriteon

♪ Global ♪
# Database connection
SQLConnectInfo programpd

# Key amendments
SQLAuthTypes SHA256
SQLPasswordEngine on

# User chart map
SQLUserInfo ussername password uid girl homedir shell
SQL DefaultGID 2000
SQLDefaultUID 2000
RequireValid Shell off

# Authentication Configuration
AuthOrder mod_sql.c
SQLAENTICATE USES

# Login statistics
SQLNamedQuery get count SELECT ""CONCAT"
SQLNamedQuery updatecount UPDATE "count=count+1 WeHERE username='u'" users
SQLShowInfo PASS "230"
SQLog PASS update count

# File Operations Log

SQLNamedQuery log_work FREEFORM "INSERT INTO worklog (user_name, file_and_path, bytes, Send_time, clent_ip, clent_name, clent_committee) VALUES ('%u', '%f', %b, NULLIF('%T','), 'a', '%h', '%m')"

SQLLog RETR, STOR, DELE log_work

</Global>
````

- CREATE A DIRECTORY TO STORE THE LOG OF THE FTP SERVER:


```sh
# mkdir /var/log/proftpd
```

>** Warning**
>
> IF NOT ** PROACTIVE** CREATION (EVEN IF CREATED AUTOMATICALLY) WILL PROMPT __CODESPAN_0_。


>** Skills**
>
>ProFTPD profile __CODESPAN_0_ has a syntax check command `proftpd -t -d5`_。

WE HAVE SPECIFIED IN OUR SETTINGS THAT THE SERVER WILL WORK ON PORT 21 IN ACTIVE MODE AND IN PASSIVE MODE WITHIN 50000-60000. THESE PORTS SHOULD BE OPENED IN THE FIREWALL. FOR PF, THIS WAS DONE BY ADOPTING THE FOLLOWING RULES:

```sh
pass in quick on $ext_if proto tcp from any to $ext_if port { 21, 50000:60000 }
```

Create user

For security purposes, we will run Proftpd as a non root user. We will therefore create this user:

```sh
# adduser
Username: proftpd # 用户名
Full name: FTP User # 用户全名
Uid (Leave empty for default): 
Login group [proftpd]:
Login group is proftpd. Invite proftpd into other groups? []:
Login class [default]:
Shell (sh csh tcsh bash nologin) [sh]: nologin # 不允许登录系统
Home directory [/home/proftpd]:
Home directory permissions (Leave empty for default):
Enable ZFS encryption? (yes/no) [no]:
Use password-based authentication? [yes]: no
Lock out the account after creation? [no]:
Username    : proftpd
Password    : <disabled>
Full Name   : FTP User
Uid         : 1002
ZFS dataset : zroot/home/proftpd
Class       :
Groups      : proftpd
Home        : /home/proftpd
Home Mode   :
Shell       : /usr/sbin/nologin
Locked      : no
adduser: INFO: Successfully created ZFS dataset (zroot/home/proftpd).
adduser: INFO: Successfully added (proftpd) to the user database.
Add another user? (yes/no) [no]:
Goodbye!
```


Database Related

- Create a MySQL database and a user with full access to the created database:

```sql
CREATE DATABASE `proftpd` CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci;
```

- create database user and password (authorization programd database):

```sh
CREATE USER 'proftpd'@'localhost' IDENTIFIED BY '123456';
GRANT SELECT, INSERT, UPDATE, DELETE ON proftpd.* TO 'pftp'@'localhost';
FLUSH PRIVILEGES;
```

- Create data sheets:

```sql
USE proftpd;

DROP TABLE IF EXISTS USES;
CREATE TABLE _CODESPAN_0_ (
NOT NULL,
__TEXT CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_i_ci NOT NULL,
NOT NULL,
__CODESPAN_0_INT(11) DEFAULT NULL,
__CODESPAN_0_INT(11) DEFAULT NULL,
___ CODESPAN_0_ VARCHAR(255) DEFAULT NULL,
___ CODESPAN_0_ VARCHAR(255) DEFAULT NULL,
__CODESPAN_0_INT(11) NOT NULL DEFAUT0,
PRIMARY KEY (__CODESPAN_0_)
) ENGINE =InnoDB DEFAULT CHARSET =utf8mb4 COLLATE =utf8mb4_0900_ai_ci;
DROP TABLE IF EXISTS worklog;
CREATE TABLE worklog
id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
date TEMESTAMP(0) DEFAULT CURRENT_TIMESTAMP(0),
ours_name VARCHAR(20) CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_i_ci DEFAULT NULL,
cARATER SET utf8mb4 COLLATE utf8mb4_0900_i_ci DEFAULT NULL,
bytes BIGINT UNSIGNED DEFAULT NULL,
send_time VARCHAR (9) CHARACTER SET utf8mb4 COLLATE utf8mb4_090_ai_ci DEFAULT NULL,
cLALATE utf8mb4_0900_ai_ci DEFAULT NULL,
i'm not sure I'm going to be able to do this,
cLALATE utf8mb4_0900_ai_ci DEFAULT NULL,
I'm sorry,
UNIQUE INDEX id (id)
ENGINE =InnoDB Character SET =utf8mb4 COLLATE =utf8mb4_0900_ai_ci ROW_FORMAT =DYNAMIC;
INSERT INTO ___ CODESPAN_0.__ CODESPAN_1 (__ CODESPAN_2 , __ CODESPAN_3 , __ CODESPAN_4 , __ CODESPAN_5 , __ CODESPAN_6 , __ CODESPAN_7 , __ CODESPAN_8 , __ CODESPAN_9 __)
VALUES ('test', 'test user', SHA2('FTPpassword_here', 256), '1002', '1002', '/home/www/ftp', NULL, '0');
````

Created:

- FTP USERNAME_CODESPAN_0_
- FTP LOGIN PASSWORD - CODESPAN_0_
- UID _CODESPAN_0_
- GID > CODESPAN_0_

>** Warning**
>
>UID GID must be the same as the programpd user! Otherwise, you can't write
>
>
> You can determine the UID and GID of the programpd user by:
>
> ```sh '
>root@ykla:/home/ykla id programd
>uid=1002 (proftpd) gid=1002 (proftpd) groups=1002 (proftpd)
> ````


- Test database links:

```sql
# mysql -u proftpd -p -h localhost proftpd

proftpd@localhost [proftpd] > show data;
You have an error in your SQL syntax; check the manual that guarantees to your MySQL service for the right syntax to use near 'data' at line 1
> show data;
+ - - - - - +
Database
+ - - - - - +
information_schema
%1 %1
proftpd
+ - - - - - +
3rows in set (0.00 sec)

>use proftpd;
Database changed
{\bord0\shad0\alphah3d}productpd;
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
you know, we're gonna have to use the word "screw."
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
test user |d1d6930fda5f964acba51ec4c35d0d0db3b36d25bf59f1120abd2e4f9140d9|1002|1002| /home/www/ftp|NULL|0
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
1row in set (0.00 sec)
````

CREATES A DIRECTORY AND A TEST FTP USER THAT SPECIFIES THE CREATED DIRECTORY AS A USER DIRECTORY:

```sh
# mkdir -p /home/www/ftp
# chown -R proftpd:proftpd /home/www/ftp
# chmod -R 775 /home/www/ftp
```

Service Operations

```sh
# service proftpd enable  # 加入启动
# service proftpd start   # 启动服务
# service proftpd stop    # 停止服务
# service proftpd restart # 重启服务
```

USE USER __CODESPAN_0, PASSWORD __CODESPAN_1_TO LOG IN TO FTP。

# vsftpd

vsftpd is Very Security FTP Daemon. More popular on Linux. Tested in the Windows on FTP client and will not be confused。

# # install vsftpd

- install by pkg

```sh
# pkg install vsftpd-ssl pam_pwdfile apache24
```

| Name | Annotations |
|:-----------------|:----------|
| vsftpd-ssl | vsftpd-ssl with SSL support |
| pam_pwdfile | A PAM MODULE ALLOWS USER IDENTIFICATION USING A PLAIN TEXT PASSWORD FILE。 |
| apace24 | `htpasswd 'command provided |

>** Skills**
>
>FreeBSD system __CODESPAN_0_ only serves compatibility and is not actually used. Relevant db database files are actually used。

- By Ports:

```
# cd /usr/ports/ftp/vsftpd/ && make install clean
# cd /usr/ports/security/pam_pwdfile/ && make install clean
# cd /usr/ports/www/apache24 && make install clean
```

Observation of installation output:

```sh
[2/2] Installing vsftpd-ssl-3.0.5_2...
===> Creating groups
Using existing group 'ftp'
===> Creating users
Creating user 'ftp' with uid '14'
===> Creating homedir(s)
[2/2] Extracting vsftpd-ssl-3.0.5_2: 100%
```

See vsftpd to create a user _CODESPAN_0_ to see the user details:

```sh
# id ftp
uid=14(ftp) gid=14(ftp) groups=14(ftp)
```

# Create virtual users #

```sh
root@ykla:/home/ykla # adduser
Username: ftptest
Full name:
Uid (Leave empty for default):
Login group [ftptest]: ftp # 注意此处
Login group is ftp. Invite ftptest into other groups? []:
Login class [default]:
Shell (sh csh tcsh nologin) [sh]: nologin # 注意此处
Home directory [/home/ftptest]:
Home directory permissions (Leave empty for default):
Enable ZFS encryption? (yes/no) [no]:
Use password-based authentication? [yes]:
Use an empty password? (yes/no) [no]:
Use a random password? (yes/no) [no]:
Enter password: # 注意此处，我设置密码为 z
Enter password again:
Lock out the account after creation? [no]:
Username    : ftptest
Password    : *****
Full Name   :
Uid         : 1003
ZFS dataset : zroot/home/ftptest
Class       :
Groups      : ftp
Home        : /home/ftptest
Home Mode   :
Shell       : /usr/sbin/nologin
Locked      : no
OK? (yes/no) [yes]:
adduser: INFO: Successfully created ZFS dataset (zroot/home/ftptest).
adduser: INFO: Successfully added (ftptest) to the user database.
Add another user? (yes/no) [no]:
Goodbye!
```

above:

- USERNAME __CODESPAN_0_
- PASSWORD __CODESPAN_0_
- GROUP __CODESPAN_0_

# # configure pam_pwdfile

- CREATE FILE __CODESPAN_0_, WRITTEN:


```ini
auth required /usr/local/lib/pam_pwdfile.so pwdfile /usr/local/etc/vsftpd_login.db
account required /usr/lib/pam_permit.so
```

- CREATE PASSWORD DATABASE (I ADDED THE USER __CODESPAN_0, THE PASSWORD IS __CODESPAN_1_)

```sh
# htpasswd -c -b /usr/local/etc/vsftpd_login.db ftptest z
Adding password for user virtual
```

SUBSEQUENT ADDITION (MAY REQUIRE __CODESPAN_0_, NOT TESTED):

```sh
# htpasswd -b /usr/local/etc/vsftpd_login.db 新建的用户名 新建的用户密码
```


## CONFIGURE __CODESPAN_0_

vsftpd main configuration data is saved at __CODESPAN_0_ and can be modified directly. Because there's a back-up template at CODESPAN_1_。

WE WILL CONFIGURE __CODESPAN_0_ AS FOLLOWS:

```ini
# /usr/local/etc/vsftpd.conf 示例配置文件 
#
# 默认编译设置相当保守。此示例文件略微放宽了一些设置，使 FTP 守护进程更实用。
# 参阅 vsftpd.conf.5 可获取所有默认编译设置。
#
# 请注意：此示例文件不是 vsftpd 选项的详尽列表。
# 请阅读 vsftpd.conf.5 手册页，以全面了解 vsftpd 的功能。
#
# 不允许匿名 FTP 吗？
anonymous_enable=NO
#
# 允许本地用户登录。
local_enable=YES
#
# 取消注释以启用任何形式的 FTP 写命令。
write_enable=YES
#
# 本地用户的默认 umask 值为 077。你可能希望将其更改为 022，
# 如果你的用户期待这样的话（022 是大多数其他 FTP 服务的默认值）
# local_umask=022
#
# 取消注释以允许匿名 FTP 用户上传文件。仅当启用了上面的全局写入功能时，才会生效。
# 此外，你还需要为 FTP 用户创建一个可写的目录。
# anon_upload_enable=YES
#
# 如果你希望匿名 FTP 用户能够创建新目录，取消注释此项。
# anon_mkdir_write_enable=YES
#
# 启用目录消息 - 在远程用户进入某个目录时，给出相关的消息。
dirmessage_enable=YES
#
# 启用上传/下载日志记录。
xferlog_enable=YES
#
# 确保 PORT 传输连接来自端口 20 (ftp-data)。
connect_from_port_20=YES

local_root=/home/ftp
anon_root=/home/ftp
# I don't know
# if you want, you can arrange to upload anonymous files to different users. attention! do not recommend that upload files be attributed to "root" users
# Down_uploads #
# down_username=whoever
# I don't know
# You can overwhelm the repository of log files. The default path is as follows。
#xferlog_file=/var/log/vsftpd.log
# I don't know
# if necessary, you can use the log file in standard ftpd xferlog format。
# note that in this case the default log file location is / var/log/xferlog。
# Xferlog_std_format=YES
# I don't know
# You can change the default for idle sessions. Unit seconds, same
= 1800
# I don't know
# You can change the default value of the time-out data connection。
data_convention_timeout=1200
# I don't know
# IT IS RECOMMENDED THAT YOU DEFINE A SINGLE USER ON THE SYSTEM FOR THE FTP SERVER AS A COMPLETELY ISOLATED AND PRIVILEGED USER。
# nopriv_user=ftpsecure
# I don't know
# ENABLE THIS OPTION, THE SERVER WILL RECOGNIZE THE ABOR REQUEST. OWING TO THE COMPLEXITY OF THE CODE, SECURITY IS NOT RECOMMENDED FOR USE。
# IF NOT ENABLED, SOME OLD FTP CLIENT MAY HAVE PROBLEMS。
# Async_abor_enable #
# I don't know
# BY DEFAULT, THE SERVER PRETENDS TO ALLOW ASCII MODE, BUT ACTUALLY IGNORES THE REQUEST。
# OPENS THE FOLLOWING OPTIONS AND THE SERVER WILL MODIFY THE ASCII FORMAT OF THE FILE IN ASCII MODE。
# Note: In some FTP servers, ASCII supports allowing a denial-of-service attack (DoS) in the ASCII mode by "SIZE/big/file" command. vsftpd has predicted the attack and remains secure, reporting the size of the original document。
# ASCII FORMAT CHANGE IS A BAD FEATURE OF THE AGREEMENT。
# Ascii_upload_enable #
# Ascii_download_enable #
# I don't know
# You can completely customize the login message:
fTP service.
# I don't know
# You can specify a file that prohibits anonymous email addresses. This function may be useful to protect against certain DoS attacks。
# Deny_email_enable #
# (the default value is as follows)
# banned_email_file=/etc/vsftpd.banned_emails
# I don't know
# You can specify a visible list of local users, and put these users choroot() into their home directory. If choroot_local_user is YES
# this list becomes a list of users without chroot() operations。
warning! choot() could be very dangerous. if you use chroot, make sure you have no permission to write to the top directory of the chroot directory)
# choroot_local_user=NO, chorot_list_file will be restricted to users in their home directory
choot_local_user=NO
choot_list_enable=YES
# (the default value is as follows)
_list_file=/usr/local/etc/vsftpd.choot_list
allow_writeable_chroot=YES
# I don't know
# You can enable the "-R" option for the embedded ls. Disable this option by default to avoid remote users causing too much I/O on large sites。
# However, some defective FTP clients (e.g. "ncftp" and "mirror") assume that there is a "-R" option, so there is some reason to enable it。
#ls_recurse_enable #
# I don't know
# When the "listen" command is enabled, vsftpd runs in an independent mode and listens to the IPv4 package. This command cannot be used at the same time as the listen_ipv6。
== sync, corrected by elderman ==
# I don't know
# This command enables the listening IPv6 package. If you want to listen to the IPv4 and IPv6 packages at the same time, you must run two examples of vsftpd using two different profiles。
make sure one of the options is out
# listen_ipv6 #

# This option should be the path to an empty directory。
# This directory should not be written to FTP users. This directory is used as a security chroot () prison in vsftpd when access to the file system is not required。
secure_chroot_dir=/usr/local/share/vsftpd/empty

# This option is valid only if background mode is enabled。
# IT WILL WRITE THE RUNNING DAEMON PID TO THE SPECIFIED PATH FILE。
# BY DEFAULT DO NOT CREATE A PID FILE。
#pid_file=/var/run/vsftpd.pid

# if using vsftpd in stand-alone mode, cancel the following two lines:
== sync, corrected by elderman ==
♪ Background ♪

# Use local time
♪ I'm so sorry ♪
````

The official web document is here [VSFTPD.CONF] (https://security.appspot.com/vsftpd/vsftpd_conf.html) and is translated in Chinese into [vsftpd.confchinese] (https://www.jinbugo.com/vsftpd/vsftpd.conf.html)。

# CODESPAN_0__

CREATE AND EDIT __CODESPAN_0, ADD __CODESPAN_1_


# Create Path #

```sh
# mkdir -p /home/ftp
# chown -R ftp:ftp /home/ftp
# chmod -R 775 /home/ftp
```

# # Service management

```sh
# service vsftpd enable  # 添加服务
# service vsftpd start   # 开始服务
# service vsftpd stop    # 停止服务
# service vsftpd restart # 重启服务
```

- USE USER __CODESPAN_0, PASSWORD __CODESPAN_1_1_ TO LOG IN TO FTP。

- vsftpd log at CODESPAN_0_

References

- [How to set up vsftpd on FreeBSD 12?] (https://www.osradar.com/how-to-set-up-vsftpd-on-freebsd-12/), modified from [Installing and Communising vsftpd on FreeBSD] (https://dnaeon.github.io/installing-and-configuring-vsftpd-on-freebsd/). This framework is based on this。

# CONNECT TO THE FTP SERVER

Simple example:

```powershell
# telnet localhost 21
Trying 127.0.0.1...
Connected to localhost.
Escape character is '^]'.
220 FTP Server ready
quit
221 Goodbye.
```

---|---

USING __CODESPAN_0_ COMMANDS, YOU CAN QUICKLY CONNECT TO A FTP SERVER。

Usage:

```sh
ftp [选项] [IP 地址]
```

---|---

FTP COMMAND:

```sh
account [密码] 提交补充密码

put upload

bell sends a hint after the file is passed

dir/ls display files and folders under this directory

cd toggle directory

delete delete file

features display functionality supported by this server

get remote files download remote files on the server

bye end session with server
````

Example:

```powershell
PS C:\Users\ykla> ftp 192.168.179.150
连接到 192.168.179.150。
220 Welcome to blah FTP service.
200 Always in UTF8 mode.
用户(192.168.179.150:(none)): ftptest
331 Please specify the password.
密码:

Login regular.
ftp>ls
200 police officers reporting to PASV.
Here comes the direct listening.
FreeBSD is fully focused on QA.pdf
FreeBSD technology inner (United States of America)
end of philosophy. docx
marxist philosophy
226 Directory send OK.
ftp: received 288 bytes, 0.00 seconds 96.00 kilobytes/s。
ftp>delete end of philosophy history.docx
Two hundred and fifty per cent.
i'm sorry
200 police officers reporting to PASV.
Here comes the direct listening.
-rw -- - 1 1003 14 14717778 Mar 06 15:39 FreeBSD completely pegged the QA version.pdf
-rw - - 1 1003 14 47037557 Mar 06 15:39 FreeBSD technology insider (United States) Michael Urban, (United States) Brian Tiemann, Wisdom East Studio Translation).pdf
-rw -- - 1 1003 14 591146 Oct 20 11:28 Marxist philosophy
226 Directory send OK.
ftp: received 435 bytes at 0.01 seconds 54.38 kilobytes/s。
{\chffffff}{\ch00ffff} get marxist philosophy
200 police officers reporting to PASV.
150 Opening BINARY Mode data connection for Marxist philosophy.
226 Transfer complete.
ftp: received 591146 bytes, 0.01 seconds 42224.71 kilobytes/s。
ftp>ls
200 police officers reporting to PASV.
Here comes the direct listening.
FreeBSD is fully focused on QA.pdf
FreeBSD technology inner (United States of America)
marxist philosophy
226 Directory send OK.
ftp: received 266 bytes, 0.00 seconds, 66.50 kb/s。
ftp>lcd
Current local directory C:\Users\ykla。
printer for ftp> put UOS.pdf
200 police officers reporting to PASV.
Okay to send data.
226 Transfer complete.
ftp: send 1269989 bytes at 0.04 seconds 36285.40 kb/s。
i'm sorry
200 police officers reporting to PASV.
Here comes the direct listening.
-rw -- - 1 1003 14 14717778 Mar 06 15:39 FreeBSD completely pegged the QA version.pdf
-rw - - 1 1003 14 47037557 Mar 06 15:39 FreeBSD technology insider (United States) Michael Urban, (United States) Brian Tiemann, Wisdom East Studio Translation).pdf
-rw -- - 1 1003 14 1269989 Mar 27 15:13 UOS Printers.pdf
-rw -- - 1 1003 14 591146 Oct 20 11:28 Marxist philosophy
226 Directory send OK.
ftp: received 515 bytes for 0.01 seconds 46.82 kilobytes/s。
ftp>by
221 Goodbye.
PS C: \Users\ykla>
````

THE FTP DEFAULT DOWNLOAD PATH IS __CODESPAN_0, AND I AM __CODESPAN_1_。

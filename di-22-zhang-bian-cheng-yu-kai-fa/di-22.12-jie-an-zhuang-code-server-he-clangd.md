# Section 22.12 code-server and clangd

> ** Warning**
>
> The Academy is currently testing normal on 13.2-RELEASE and 14.0-RELEASE, with other versions carefully referenced.

# Server enabled Linux binary compatible and deployed archlinux-bootstream mirror

```sh '
♪ Service Linux enough
# Service Linux start
#fetch-o/tmp https://mirrors.bfsu.edu.cn/archlinux/iso/latest/archlinux-bootstream-x86_64.tar.zst
#tar-use-compress-program=unzstd-xpvf arclinux-bootstrap-x86_64.tar.zst-C/tmp-numeric-owner
# rm arclinux-bootstream-x86_64.tar.zst
#cp-Rf/tmp/ root.x86_64/compat/linux
````

# Server Configure Pacman Source and Add arclinuxcn Repository


Edit `/compat/linux/etc/pacman.conf ' to read:

```sh '
[options]
Architecure = auto
Parallel Downloads = 5

[core]
Server = https://mirrors.cernet.edu.cn/archlinux/$repo/os/$arch
SigLevel =Required Database

[extra]
Server = https://mirrors.cernet.edu.cn/archlinux/$repo/os/$arch
SigLevel =Required Database

[archlinuxcn]
Server = https://mirrors.cernet.edu.cn/archlinuxcn/$arch
SigLevel =Required Database
````

# Initialise server Arch Linux Runtime Environment

```sh '
# choroot /compat/linux pacman-key-init
# choroot /compat/linux pacman-key-populate
````

# Server update Arch Linux running time environment and install code-server

Edit `/etc/resolv.conf/compat/linux/etc ' to read:

```sh '
# Chorot /compat/linux pacman-Syu-noconform
# Chorot /compat/linux pacman-S-noconfilm achlinuxcn-keyring
# Chorot /compat/linux pacman-S-noconfirm code-server
````

# The server removes the unused directory in the Arch Linux running environment

```sh '
# rm-Rf/compat/linux/home
# rm-Rf /compat/linux/root
#rm-Rf /compat/linux/usr/local
#rm-Rf /compat/linux/usr/src
````

# Server Install llvm and clang plugins

```sh '
♪ Pkg install-y llvm
#ln-sf /compat/linux/lib/code-server/bin/code-server/usr/local/bin
# Code-server-istall-expense
````

# Server starts code-server by daemon command

```sh '
# daemon-p/ root/.code-server.pid-f code-server-auth=none
````

# Client builds tunnels through SSH and connects to code-server servers through browser

```sh '
# ssh-L 8080:127.0.0.1:8080 -N root@server
````

Access to browser <http://127.0.0.1:8080>

# (example) Source tree of FreeBSD opened with code-server in browser

```sh '
# Code-server/usr/src
````

# (example) Browser compile and minimize kernels and generate `compile_committees.json ' files

```sh '
# Pkg install bear
#Bear --append -- make KernCONF=MINIMAL builtkernel
````

Wait for the `compile_committees.json ' file to be compiled and produced, and then you can start reading the source code of the key kernel.

# Automation of installation scripts

In order to facilitate rapid access to the development environment for readers, we have organized a script of steps to install code-server:

```sh '
#!/bin/sh

You know, set-e.

ARCHLINUX_MIRROR=https://mirrors.cernet.edu.cn/archlinux
ARCHLINUXCN_MIRROR=https://mirrors.cernet.edu.cn/archlinuxcn
FREEBSD_PKG_MIRROR=https://mirrors.cernet.edu.cn/FreeBSD-pkg

I'm sorry.

rm-Rf /compat/linux
Rm-Rf /tmp/archlinux-bootstream-x86_64.tar.zst
Rm-Rf/tmp/root.x86_64

It's not like I'm going to have to do this.
It's not a good idea.

Fetch-o /tmp "$ARCHLINUX_MIRROR/iso/latest/archlinux-bootstream-x86_64.tar.zst"
I'm sorry, I'm sorry.
cp-Rf/tmp/ root.x86_64/compat/linux

Cat >/compat/linux/etc/pacman.conf < EOF
[options]
Architecure = auto
Parallel Downloads = 5

[core]
Server = $ARCHLINUX_MIRROR/$repo/os/$arch
SigLevel =Required Database

[extra]
Server = $ARCHLINUX_MIRROR/$repo/os/$arch
SigLevel =Required Database

[archlinuxcn]
Server = $ARCHLINUXCN_MIRROR/$arch
SigLevel =Required Database
EOF

chroot /compat/linux pacman-key-init
chroot /compat/linux pacman-key-populate

cp / etc/resolv.conf /compat/linux/etc

/compat/linux pacman-sync-refresh-sysupgrad-noconform
/compat/linux pacman-sync-ned-noconfirm achlinuxcn-keyring
/compat/linux pacman-sync-ned-noconfirm code-server

In-sf/compat/linux/lib/code-server/bin/code-server/usr/local/bin

Rm-Rf /compat/linux/home
Rm-Rf /compat/linux/root
Rm-Rf /compat/linux/usr/local
Rm-Rf /compat/linux/usr/src

I'm sorry.

I'm not sure what I'm talking about.
I'm not sure I'm gonna be able to do this.

Rm-Rf /tmp/archlinux-bootstream-x86_64.tar.zst
Rm-Rf/tmp/root.x86_64
````

WelcomeTesting and feedback.

# FAQ common problem

# Why do you have this lesson?

By installing and configurationing a code-server on FreeBSD, you can obtain an integrated development environment in a native FreeBSD environment without installing a desktop environment. This allows you to use the familiar VSCode interface and the powerful clangd plugin to support the development of the FreeBSD kernel, thus significantly reducing the cost of learning to input FreeBSD code contributions and to develop secondary development.

Why the Arch Linux Compatible?

Only one revision of the historical version is available due to problems with the upstream FreeBSD version code-server. So running through the Linux Compatibility Layer is the most time-saving option at present. In addition, since the code-server was based on Node.js18, the minimum version requirements for glibc have been raised and the running-time environment provided by CentOS no longer meets its needs.

Compatible layer? Can that be used to develop FreeBSD?

Of course, although we use Linux codé-server for running, clangd and all other development tools are provided entirely by FreeBSD.

# # Why clangd and any other development tools will be provided by FreeBSD?

As you can see, after a combination of factors, code-server is currently operating under the Lenux binary compatible mode of FreeBSD. But first, let's be clear, it's a Linux binary compatible model, not a Linux simulator model, not a Linux virtual machine model. Since it is binary compatible, the main subject of the Linux program is the FreeBSD kernel itself, without adding an extra Linux kernel.

As the subject remains the FreeBSD kernel, this necessarily involves the hybrid operation of the Linux and FreeBSD programs, which in turn raises the issue of the dynamic link library. For a digitized binary, the dynamic link library path it needs is written dead, for example, if a Linux binary relies on `/lib/glibc.so ' , it will certainly go to `lib/glibc.so ' to look for the file, not elsewhere. But on FreeBSD, Linux ' s running time environment is under the `/compat/linux ' directory.

There are two ways to solve this problem. One is to patch the Linux binary and change its dependent `/lib/glibc.so ' to `/compat/linux/lib/glibc.so ' , but this practice is not only complex but inevitably leaves out. Another approach is to hijack the path at the internal nuclear level of FreeBSD, which automatically adds `/compat/linux' to `/compat/linux/lib/glibc.so ' , when a Linux binary has attempted `open ' /lib/glibc.so ' . This process is transparent to the application, which does not know for itself which document it eventually obtained, but from the perspective of the FreeBSD kernel, it actually visited `/compat/linux/lib/glibc.so ' .

If a file is not under the `/compat/linux ' directory, but is in the FreeBSD local system directory, the FreeBSD kernel will automatically fallback to try again on the original path. The `open ' system calls would be a real failure if the documents were still not available this time.

Back to code-server, it is a Linux program that, when attempting to access a document or directory, the default will be searched first under `/compat/linux ' . Assuming that you want to open the `/usr/src ' directory to look at FreeBSD ' s source tree, if `/compat/linux/usr/src ' exists, it is actually `/compat/linux/usr/src ' instead of `/usr/src ' which you really want. At this point, we need to delete `/compat/linux/usr/src ' to ensure that the FreeBSD kernel can fallback to the right `/usr/src ' .

The same logic applies to clangd. Since `compat/linux/bin/clangd ' does not exist, when code-server tries to start clangd, it eventually calls on `/usr/local/bin/clangd ' as provided by FreeBSD, and other development tools are the same. That's why even though the code-server runs on Linux compatibility, clangd and all other development tools are provided entirely by FreeBSD.

What else do you need to add?

:: How to provide code-server services through HTTPS on the server
:: Explore the difference between Linux Compatibility Layer and Linux Jail

You're encouraging users to be root death squad?

* To live with one another and to seek good for one's own soul.
:: Risk self-sufficiency.
。
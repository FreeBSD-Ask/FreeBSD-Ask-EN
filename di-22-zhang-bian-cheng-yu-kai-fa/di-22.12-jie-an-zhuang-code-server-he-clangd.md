# section 22.12 code-server and clangd

> ** Warning**
>
> THE ACADEMY IS CURRENTLY TESTING NORMAL ON 13.2-RELEASE AND 14.0-RELEASE, WITH OTHER VERSIONS CAREFULLY REFERENCED。

# Server enabled Linux binary compatible and deployed archlinux-bootstream mirror

```sh
# service linux enable
# service linux start
# fetch -o /tmp https://mirrors.bfsu.edu.cn/archlinux/iso/latest/archlinux-bootstrap-x86_64.tar.zst
# tar --use-compress-program=unzstd -xpvf archlinux-bootstrap-x86_64.tar.zst -C /tmp --numeric-owner
# rm archlinux-bootstrap-x86_64.tar.zst
# cp -Rf /tmp/root.x86_64/* /compat/linux
```

# server configure pacman source and add arclinuxcn repository


EDIT __CODESPAN_0_, WRITING:

```sh
[options]
Architecture = auto
ParallelDownloads = 5

[core]
Server = https://mirrors.cernet.edu.cn/archlinux/$repo/os/$arch
SigLevel =Required Database

[extra]
Server = https://mirrors.cernet.edu.cn/archlinux/$repo/os/$arch
SigLevel =Required Database

[archlinuxcn]
Server = https://mirrors.cernet.edu.cn/archlinuxcn/$arch
SigLevel =Required Database
````

# Initialise server Arch Linux Runtime Environment

```sh
# chroot /compat/linux pacman-key --init
# chroot /compat/linux pacman-key --populate
```

# Server update Arch Linux running time environment and install code-server

EDIT __CODESPAN_0_, WRITING:

```sh
# chroot /compat/linux pacman -Syu --noconfirm
# chroot /compat/linux pacman -S --noconfirm archlinuxcn-keyring
# chroot /compat/linux pacman -S --noconfirm code-server
```

# The server removes the unused directory in the Arch Linux running environment

```sh
# rm -Rf /compat/linux/home
# rm -Rf /compat/linux/root
# rm -Rf /compat/linux/usr/local
# rm -Rf /compat/linux/usr/src
```

# server install llvm and clang plugins

```sh
# pkg install -y llvm
# ln -sf /compat/linux/lib/code-server/bin/code-server /usr/local/bin
# code-server --install-extension llvm-vs-code-extensions.vscode-clangd
```

# server starts code-server by daemon command

```sh
# daemon -p /root/.code-server.pid -f code-server --auth=none
```

# Client builds tunnels through SSH and connects to code-server servers through browser

```sh
# ssh -L 8080:127.0.0.1:8080 -N root@server
```

access to browser <http://127.0.0.1:8080>

# (example) Source tree of FreeBSD opened with code-server in browser

```sh
# code-server /usr/src
```

# (EXAMPLE) BROWSER COMPILE AND MINIMIZE KERNELS AND GENERATE __CODESPAN_0_ FILES

```sh
# pkg install  bear
# bear --append -- make KERNCONF=MINIMAL buildkernel
```

WAITING FOR THE COMPILATION AND GENERATION OF THE __CODESPAN_0_ FILE, YOU CAN START READING THE SOURCE CODE OF THE KEY KERNEL。

# Automation of installation scripts

in order to facilitate rapid access to the development environment for readers, we have organized a script of steps to install code-server:

```sh
#!/bin/sh

you know, set-e

ARCHLINUX_MIRROR=https://mirrors.cernet.edu.cn/archlinux
ARCHLINUXCN_MIRROR=https://mirrors.cernet.edu.cn/archlinuxcn
FREEBSD_PKG_MIRROR=https://mirrors.cernet.edu.cn/FreeBSD-pkg

i'm sorry

rm-Rf /compat/linux
rm-Rf /tmp/archlinux-bootstream-x86_64.tar.zst
rm-Rf/tmp/root.x86_64

it's not like i'm going to have to do this
it's not a good idea

fetch-o /tmp "$ARCHLINUX_MIRROR/iso/latest/archlinux-bootstream-x86_64.tar.zst"
i'm sorry, I'm sorry
cp-Rf/tmp/ root.x86_64/compat/linux

cat >/compat/linux/etc/pacman.conf < EOF
[options]
Architecure = auto
Parallel Downloads = 5

[core]
Server = $ARCHLINUX_MIRROR/$repo/os/$arch
SigLevel =Required Database

[extra]
Server = $ARCHLINUX_MIRROR/$repo/os/$arch
SigLevel =Required Database

[archlinuxcn]
Server = $ARCHLINUXCN_MIRROR/$arch
SigLevel =Required Database
EOF

chroot /compat/linux pacman-key-init
chroot /compat/linux pacman-key-populate

cp / etc/resolv.conf /compat/linux/etc

/compat/linux pacman-sync-refresh-sysupgrad-noconform
/compat/linux pacman-sync-ned-noconfirm achlinuxcn-keyring
/compat/linux pacman-sync-ned-noconfirm code-server

in-sf/compat/linux/lib/code-server/bin/code-server/usr/local/bin

rm-Rf /compat/linux/home
rm-Rf /compat/linux/root
rm-Rf /compat/linux/usr/local
rm-Rf /compat/linux/usr/src

i'm sorry

i'm not sure what i'm talking about
i'm not sure i'm gonna be able to do this

rm-Rf /tmp/archlinux-bootstream-x86_64.tar.zst
rm-Rf/tmp/root.x86_64
````

Testing and feedback are welcome。

# FAQ COMMON PROBLEM

# Why do you have this lesson

By installing and configurationing a code-server on FreeBSD, you can obtain an integrated development environment in a native FreeBSD environment without installing a desktop environment. This allows you to use the familiar VSCode interface and the powerful clangd plugin to support the development of the FreeBSD kernel, thus significantly reducing the cost of learning to input FreeBSD code contributions and to develop secondary development。

Why the Arch Linux Compatible

Only one revision of the historical version is available due to problems with the upstream FreeBSD version code-server. So running through the Linux Compatibility Layer is the most time-saving option at present. In addition, since the code-server was based on Node.js18, the minimum version requirements for glibc have been raised and the running-time environment provided by CentOS no longer meets its needs。

Compatible layer? Can that be used to develop FreeBSD

Of course, although we use Linux codé-server for running, clangd and all other development tools are provided entirely by FreeBSD。

# # Why clangd and any other development tools will be provided by FreeBSD

As you can see, after a combination of factors, code-server is currently operating under the Lenux binary compatible mode of FreeBSD. But first, let's be clear, it's a Linux binary compatible model, not a Linux simulator model, not a Linux virtual machine model. Since it is binary compatible, the main subject of the Linux program is the FreeBSD kernel itself, without adding an extra Linux kernel。

As the subject remains the FreeBSD kernel, this necessarily involves the hybrid operation of the Linux and FreeBSD programs, which in turn raises the issue of the dynamic link library. For a digitized binary, the dynamic link library path that it needs is written dead, for example, if a Linux binary relies on ___CODESPAN_0, then it will go __CODESPAN_1_1_ to find the file, not anywhere else. But on FreeBSD, Linux 's running time environment is under ___CODESPAN_2_。

There are two ways to solve this problem. One is to patch the Linux binary and modify its dependent ___CODESPAN_0 to __CODESPAN_1_, but this approach is not only complex but inevitably leaves out. Another approach is the hijacking path at the internal nuclear level of FreeBSD, which automatically adds __CODESPAN_4 to the __CODESPAN_5 when a Linux binary program attempts __CODESPAN_2 __CODESPAN_3 __. This process is transparent to the application, and the application itself does not know which document it eventually obtained, but from the point of view of the FreeBSD kernel, it actually visited __CODESPAN_6_。

If a file is not under __CODESPAN_0_, but is in the FreeBSD local system directory, the FreeBSD kernel will automatically fallback to try again on the original path. If you can't find a file this time, CODESPAN_1_ will really fail。

Go back to code-server, which is a Linux program where the default is searched under __CODESPAN_0_ when trying to access a file or directory. Assuming that you want to open __CODESPAN_1 __ directory to look at the source tree of FreeBSD, if __CODESPAN_2 __ exists, it's actually __CODESPAN_3 __, not the __CODESPAN_4 __ that you really want. At this point, we need to delete ___CODESPAN_5 to ensure that the FreeBSD kernel can fallback to the right __CODESPAN_6_。

The same logic applies to clangd. Since __CODESPAN_0_does not exist, when the code-server tries to start clanged, it eventually calls __CODESPAN_1_1_ from FreeBSD, and other development tools are the same. That's why even though the code-server runs on Linux compatibility, clangd and all other development tools are provided entirely by FreeBSD。

What else do you need to add

:: How to provide code-server services through HTTPS on the server
:: Explore the difference between Linux Compatibility Layer and Linux Jail

you're encouraging users to be root death squad

* To live with one another and to seek good for one's own soul。
:: Risk self-sufficiency。
